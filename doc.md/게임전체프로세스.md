# Armchair Sleuths - 게임 전체 프로세스 (v2.0)

**문서 버전**: 2.0
**최종 업데이트**: 2025-10-21
**게임 버전**: Phase 3 (AP Integrity System)

---

## 📋 목차

1. [개요](#개요)
2. [전체 프로세스 개요](#전체-프로세스-개요)
3. [Phase 1: 케이스 생성](#phase-1-케이스-생성)
4. [Phase 2: Reddit 포스트 생성](#phase-2-reddit-포스트-생성)
5. [Phase 3: 게임 초기화](#phase-3-게임-초기화)
6. [Phase 4: 게임 플레이](#phase-4-게임-플레이)
7. [Phase 5: 답안 제출 및 채점](#phase-5-답안-제출-및-채점)
8. [데이터 흐름 상세](#데이터-흐름-상세)
9. [Redis 데이터 구조](#redis-데이터-구조)
10. [통합 테스트 시나리오](#통합-테스트-시나리오)

---

## 개요

Armchair Sleuths는 Reddit Devvit 플랫폼 기반의 일일 추리 게임입니다. 본 문서는 케이스 생성부터 답안 제출까지의 전체 프로세스를 end-to-end로 상세히 설명합니다.

### 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    Devvit Platform                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐ │
│  │   Scheduler  │    │    Backend   │    │   Frontend   │ │
│  │  (Cron Job)  │───▶│  Express API │◀───│  React App   │ │
│  └──────────────┘    └──────────────┘    └──────────────┘ │
│         │                    │                    │        │
│         └────────────────────┼────────────────────┘        │
│                              │                             │
│                    ┌─────────▼─────────┐                   │
│                    │   Redis KV Store  │                   │
│                    └───────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────▼─────────┐
                    │   Gemini AI API   │
                    │  (Case, Image,    │
                    │   Chat, Scoring)  │
                    └───────────────────┘
```

### 게임 화면 흐름 (6 Screens)

```
Loading → Cinematic Intro → Case Overview → Investigation → Submission → Results
  (1)          (2)               (3)             (4)            (5)        (6)
```

---

## 전체 프로세스 개요

### 타임라인

```
Day N-1 23:59 UTC
    │
    ├─▶ [Phase 1] DailyCaseScheduler 실행 (~14초)
    │   └─ Gemini API: 케이스 생성 + 이미지 생성
    │   └─ Redis: 케이스 및 용의자 저장
    │
Day N 00:00 UTC
    │
    ├─▶ [Phase 2] Reddit 포스트 생성 (수동 또는 자동)
    │   └─ Devvit: Custom Post 생성
    │
    ├─▶ [Phase 3] 플레이어가 포스트 클릭
    │   └─ React App 로드
    │   └─ API: 케이스 데이터 fetch
    │   └─ API: Player State 초기화 (AP=3)
    │
    ├─▶ [Phase 4] 게임 플레이
    │   ├─ Cinematic Intro (타이핑 효과)
    │   ├─ Case Overview (사건 개요)
    │   ├─ Investigation
    │   │   ├─ Suspect Interrogation (AP 획득)
    │   │   │   └─ AP Topic 감지 → +1~2 AP
    │   │   │   └─ Bonus 감지 → +1 AP
    │   │   │   └─ Emergency AP (1회 제공)
    │   │   └─ Location Search (AP 소비)
    │   │       └─ Quick Search: -1 AP
    │   │       └─ Thorough Search: -2 AP
    │   │       └─ Exhaustive Search: -3 AP
    │   └─ Submission (용의자 선택 + 추리)
    │
    └─▶ [Phase 5] 답안 제출 및 채점
        └─ Gemini AI: 추리 평가 (0-100점)
        └─ Leaderboard 업데이트
```

---

## Phase 1: 케이스 생성

### 1.1 Daily Scheduler 트리거

**파일**: `src/server/schedulers/DailyCaseScheduler.ts`
**실행 시간**: 매일 00:00 UTC (Devvit Scheduler)

```typescript
// DailyCaseScheduler.ts:35-50
scheduler.cron({
  name: 'daily-case-generator',
  cron: '0 0 * * *', // 매일 자정 UTC
  async onRun() {
    const geminiClient = createGeminiClient(context);
    const caseGenerator = createCaseGeneratorService(geminiClient);

    const newCase = await caseGenerator.generateCase({
      date: new Date(),
      includeImage: true,           // ✅ 케이스 이미지 생성
      includeSuspectImages: true    // ✅ 프로필 이미지 생성
    });

    console.log('✅ Daily case generated:', newCase.id);
  }
});
```

### 1.2 케이스 생성 프로세스

**API Endpoint**: `POST /api/case/generate` (수동 생성용)
**파일**: `src/server/index.ts:170-191`

```
CaseGeneratorService.generateCase()
    │
    ├─▶ [Step 1] Case Element 선택 (10초)
    │   └─ CaseElementLibrary.getTodaysCaseElements()
    │       └─ crime, location, victim, weapon, motive 랜덤 선택
    │
    ├─▶ [Step 2] 케이스 스토리 생성 (Gemini Text)
    │   └─ generateCaseStory()
    │       └─ title, summary, detailedDescription 생성
    │       └─ 3명의 용의자 생성 (1명 범인)
    │       └─ 증거물 및 위치 생성
    │       └─ AP Topics 생성 (용의자별 5-7개)
    │       └─ Intro Narration 생성 (cinematic)
    │
    ├─▶ [Step 3] 케이스 이미지 생성 (Gemini Image, if includeImage)
    │   └─ generateCaseImage()
    │       └─ Imagen 3 API 호출
    │       └─ Base64 인코딩
    │
    ├─▶ [Step 4] 프로필 이미지 생성 (3x Gemini Image, if includeSuspectImages)
    │   └─ generateSuspectProfileImages()
    │       └─ Promise.allSettled([...]) // 병렬 처리
    │       └─ 각 용의자 이미지 Vercel Function 호출
    │           └─ /api/generate-image (Sharp 압축)
    │               └─ 1.5MB PNG → 16KB JPEG 압축
    │               └─ data:image/jpeg;base64,... 형식 반환
    │
    └─▶ [Step 5] Redis 저장
        └─ CaseRepository.createCase()
            ├─ KVStoreManager.saveCase()
            │   └─ Redis: case:case-2025-10-21
            │   └─ Redis: case:date:2025-10-21 → case-2025-10-21
            └─ KVStoreManager.saveSuspect() x3
                └─ Redis: suspect:case-2025-10-21-suspect-1
                └─ Redis: suspect:case-2025-10-21-suspect-2
                └─ Redis: suspect:case-2025-10-21-suspect-3
                └─ 각각 profileImageUrl 포함 (Base64 JPEG)
```

### 1.3 생성된 데이터 구조

**Case 데이터** (Redis: `case:case-2025-10-21`)

```typescript
{
  id: "case-2025-10-21",
  date: "2025-10-21",
  title: "강남역 근처 독살 사건",
  summary: "강남역 인근 카페에서 30대 남성이 독극물 중독으로 사망...",
  imageUrl: "data:image/jpeg;base64,...",
  introNarration: "밤 11시, 강남역 근처 조용한 카페...",

  // Evidence Discovery System
  locations: [
    {
      id: "loc-1",
      name: "카페 현장",
      description: "사건이 발생한 카페",
      evidenceItems: [
        {
          id: "ev-1",
          type: "physical",
          name: "독극물 병",
          significance: "범행 도구",
          discoveryProbability: { quick: 0.3, thorough: 0.7, exhaustive: 0.95 }
        }
      ]
    }
  ],

  // Action Points Configuration
  actionPoints: {
    initial: 3,
    maximum: 12,
    costs: { quick: 1, thorough: 2, exhaustive: 3 }
  },

  // Suspects with AP Topics
  suspectIds: ["suspect-1", "suspect-2", "suspect-3"]
}
```

**Suspect 데이터** (Redis: `suspect:case-2025-10-21-suspect-1`)

```typescript
{
  id: "case-2025-10-21-suspect-1",
  caseId: "case-2025-10-21",
  name: "김민수",
  archetype: "nervous",
  isGuilty: true,

  // Profile
  background: "피해자의 전 직장 동료",
  personality: "불안하고 방어적",
  emotionalState: "긴장",
  profileImageUrl: "data:image/jpeg;base64,/9j/4AAQSkZJRg...", // ~16KB
  hasProfileImage: true,

  // AP Topics (5-7개)
  apTopics: [
    {
      id: "topic-alibi-1",
      category: "alibi",
      keywords: ["어디", "있었", "당시", "시간"],
      apReward: 1,
      requiresQuality: true,
      description: "알리바이 정보 획득",
      triggered: false
    },
    {
      id: "topic-relationship-1",
      category: "relationship",
      keywords: ["피해자", "관계", "알고"],
      apReward: 1,
      requiresQuality: true,
      description: "피해자와의 관계 파악",
      triggered: false
    }
    // ... 3-5개 더
  ]
}
```

---

## Phase 2: Reddit 포스트 생성

### 2.1 포스트 생성 API

**API Endpoint**: `POST /internal/menu/post-create`
**파일**: `src/main.tsx:75-120`

```typescript
// Devvit Menu Action
Devvit.addMenuItem({
  label: 'Create Case Post',
  location: 'subreddit',
  async onPress(event, context) {
    const todaysCase = await caseRepository.getTodaysCase();

    if (!todaysCase) {
      ui.showToast('No case available for today');
      return;
    }

    const post = await reddit.submitCustomPost({
      title: todaysCase.title,
      subredditName: 'armchair_sleuths_dev',
      preview: <blocks>
        <vstack>
          <text>🔍 Daily Mystery Case</text>
          <text>Tap to investigate!</text>
        </vstack>
      </blocks>
    });

    ui.showToast(`✅ Post created: ${post.id}`);
  }
});
```

### 2.2 커스텀 포스트 구조

```typescript
// Custom Post Type Definition
Devvit.addCustomPostType({
  name: 'Case Investigation',
  height: 'tall',
  render: (context) => {
    // React App 렌더링
    return <App context={context} />;
  }
});
```

---

## Phase 3: 게임 초기화

### 3.1 케이스 데이터 로드

**API Endpoint**: `GET /api/case/today`
**파일**: `src/server/index.ts:196-253`

#### Request

```
GET /api/case/today
```

#### Response (주요 필드)

```typescript
{
  // Case Info
  id: "case-2025-10-21",
  title: "강남역 근처 독살 사건",
  imageUrl: "data:image/jpeg;base64,...",
  introNarration: "밤 11시, 강남역 근처...",

  // Suspects (2-stage loading)
  suspects: [
    {
      id: "case-2025-10-21-suspect-1",
      name: "김민수",
      archetype: "nervous",
      hasProfileImage: true,  // ⚠️ Phase 1: flag only
      // profileImageUrl은 별도 API로 로드
    }
  ],

  // Evidence Discovery
  locations: [...],

  // Action Points
  actionPoints: {
    initial: 3,
    maximum: 12,
    costs: { quick: 1, thorough: 2, exhaustive: 3 }
  }
}
```

#### 백엔드 로직

```typescript
// src/server/index.ts:196-253
app.get('/api/case/today', async (req, res) => {
  const todaysCase = await caseRepository.getTodaysCase();
  const fullSuspects = await caseRepository.getCaseSuspects(todaysCase.id);

  // ⚠️ 2-stage loading: profileImageUrl 제외
  const suspectsData = fullSuspects.map(s => ({
    id: s.id,
    name: s.name,
    archetype: s.archetype,
    hasProfileImage: s.hasProfileImage,  // flag only
    background: s.background,
    personality: s.personality,
    emotionalState: s.emotionalState
    // profileImageUrl은 제외 (별도 API)
  }));

  res.json({
    ...todaysCase,
    suspects: suspectsData
  });
});
```

**Why 2-stage loading?**
- 초기 payload 크기 감소 (~150KB → ~10KB)
- 500 error 방지 (Devvit payload 제한)
- 이미지는 Investigation 화면에서 lazy load

### 3.2 프로필 이미지 로드 (2-stage)

**API Endpoint**: `GET /api/suspect-image/:suspectId`
**파일**: `src/server/index.ts:255-276`

#### Request

```
GET /api/suspect-image/case-2025-10-21-suspect-1
```

#### Response

```typescript
{
  suspectId: "case-2025-10-21-suspect-1",
  profileImageUrl: "data:image/jpeg;base64,/9j/4AAQSkZJRg...", // ~16KB
  hasImage: true
}
```

#### Frontend 통합 (Progressive Loading)

```typescript
// src/client/components/SuspectPanel.tsx
const [loadedImages, setLoadedImages] = useState<Record<string, string>>({});

useEffect(() => {
  suspects.forEach(async (suspect) => {
    if (suspect.hasProfileImage && !loadedImages[suspect.id]) {
      const response = await fetch(`/api/suspect-image/${suspect.id}`);
      const data = await response.json();

      setLoadedImages(prev => ({
        ...prev,
        [suspect.id]: data.profileImageUrl
      }));
    }
  });
}, [suspects]);
```

### 3.3 플레이어 상태 초기화

**API Endpoint**: `POST /api/player-state/initialize`
**파일**: `src/server/index.ts:1353-1398`

#### Request

```json
{
  "caseId": "case-2025-10-21",
  "userId": "reddit-user-123"
}
```

#### Response

```typescript
{
  caseId: "case-2025-10-21",
  userId: "reddit-user-123",

  // Action Points (초기화)
  actionPoints: {
    current: 3,        // actionPoints.initial
    total: 3,          // 누적 획득
    spent: 0,          // 누적 소비
    initial: 3,
    acquisitionHistory: [],
    spendingHistory: [],
    acquiredTopics: [],
    bonusesAcquired: [],
    emergencyAPUsed: false
  },

  // Evidence Discovery
  discoveredEvidence: [],
  visitedLocations: [],
  locationSearchCounts: {},

  // Submission
  hasSubmitted: false
}
```

#### 백엔드 로직

```typescript
// src/server/index.ts:1353-1398
function initializeActionPoints(caseData, playerState) {
  if (!playerState.actionPoints) {
    playerState.actionPoints = {
      current: caseData.actionPoints.initial,  // 3
      total: caseData.actionPoints.initial,
      spent: 0,
      initial: caseData.actionPoints.initial,
      acquisitionHistory: [],
      spendingHistory: [],
      acquiredTopics: new Set<string>(),
      bonusesAcquired: new Set<string>(),
      emergencyAPUsed: false
    };
  }
}
```

---

## Phase 4: 게임 플레이

### 4.1 화면 전환 흐름

```typescript
// src/client/App.tsx:50-80
type GameScreen =
  | 'loading'       // 케이스 로딩 중
  | 'intro'         // Cinematic Intro (타이핑 효과)
  | 'case-overview' // 사건 개요
  | 'investigation' // 용의자 대화 + 증거 탐색
  | 'submission'    // 답안 제출
  | 'results';      // 결과 및 리더보드

// 화면 전환 로직
useEffect(() => {
  if (caseData && currentScreen === 'loading') {
    if (caseData.introNarration) {
      setCurrentScreen('intro');  // Cinematic 있으면 intro
    } else {
      setCurrentScreen('case-overview');  // 없으면 바로 overview
    }
  }
}, [caseLoading, caseError, caseData, currentScreen]);
```

### 4.2 Cinematic Intro (Screen 2)

**컴포넌트**: `src/client/components/CinematicIntro.tsx`

```typescript
// 타이핑 효과 구현
function CinematicIntro({ narration, onComplete }) {
  const [displayedText, setDisplayedText] = useState('');
  const [currentIndex, setCurrentIndex] = useState(0);

  useEffect(() => {
    if (currentIndex < narration.length) {
      const timer = setTimeout(() => {
        setDisplayedText(prev => prev + narration[currentIndex]);
        setCurrentIndex(prev => prev + 1);
      }, 30); // 30ms per character

      return () => clearTimeout(timer);
    }
  }, [currentIndex, narration]);

  return (
    <div className="cinematic-intro">
      <p className="narration">{displayedText}</p>
      {currentIndex === narration.length && (
        <button onClick={onComplete}>조사 시작</button>
      )}
    </div>
  );
}
```

### 4.3 Investigation - Suspect Interrogation (AP 획득)

**API Endpoint**: `POST /api/chat/:suspectId`
**파일**: `src/server/index.ts:733-981`

#### Request

```json
{
  "message": "사건 당시 어디 있었나요?",
  "userId": "reddit-user-123",
  "conversationHistory": []
}
```

#### 백엔드 프로세스

```typescript
// src/server/index.ts:733-981
app.post('/api/chat/:suspectId', async (req, res) => {
  const { suspectId } = req.params;
  const { message, userId, conversationHistory } = req.body;

  // 1. Gemini Chat API 호출
  const chatResponse = await suspectChatService.chat(
    suspectId,
    message,
    conversationHistory,
    caseData
  );

  // 2. AP Topic 분석 (Phase 2)
  const apResult = apService.analyzeConversation(
    message,
    chatResponse.response,
    suspect,
    caseData,
    playerState.actionPoints,
    conversationId
  );

  // 3. AP 획득 처리
  if (apResult.apGained > 0) {
    playerState.actionPoints.current += apResult.apGained;
    playerState.actionPoints.total += apResult.apGained;

    // 획득 이력 저장
    playerState.actionPoints.acquisitionHistory.push({
      amount: apResult.apGained,
      source: 'interrogation',
      suspectId,
      topics: apResult.triggeredTopics,
      timestamp: new Date()
    });

    // Topic 플래그 업데이트
    apResult.triggeredTopics.forEach(topicId => {
      playerState.actionPoints.acquiredTopics.add(topicId);

      // Redis의 suspect도 업데이트
      const topic = suspect.apTopics.find(t => t.id === topicId);
      if (topic) topic.triggered = true;
    });
  }

  // 4. AP 최대치 적용
  if (playerState.actionPoints.current > caseData.actionPoints.maximum) {
    playerState.actionPoints.current = caseData.actionPoints.maximum; // 12
  }

  // 5. Player State 저장
  await kvStore.put(`player:${userId}:${caseData.id}`, playerState);

  res.json({
    response: chatResponse.response,
    suspectId,
    actionPointsGained: apResult.apGained,
    triggeredTopics: apResult.triggeredTopics,
    currentActionPoints: playerState.actionPoints.current
  });
});
```

#### AP Acquisition Service

```typescript
// src/server/services/ActionPointsService.ts
class ActionPointsService {
  analyzeConversation(
    userMessage: string,
    aiResponse: string,
    suspect: Suspect,
    caseData: Case,
    playerAP: ActionPointsState,
    conversationId: string
  ): APAnalysisResult {

    let totalAPGained = 0;
    const triggeredTopics: string[] = [];

    // 1. Topic 감지
    for (const topic of suspect.apTopics) {
      if (topic.triggered) continue; // 이미 트리거됨

      // 키워드 매칭
      const hasKeyword = topic.keywords.some(keyword =>
        userMessage.includes(keyword) || aiResponse.includes(keyword)
      );

      if (hasKeyword) {
        // Quality Check (if required)
        if (topic.requiresQuality) {
          const qualityScore = this.assessResponseQuality(aiResponse);
          if (qualityScore < 0.6) continue; // 낮은 품질은 AP 없음
        }

        totalAPGained += topic.apReward;
        triggeredTopics.push(topic.id);
      }
    }

    // 2. Bonus Detection
    const bonus = this.detectBonus(userMessage, aiResponse, caseData);
    if (bonus && !playerAP.bonusesAcquired.has(bonus.id)) {
      totalAPGained += bonus.reward;
      playerAP.bonusesAcquired.add(bonus.id);
    }

    return {
      apGained: totalAPGained,
      triggeredTopics,
      bonusId: bonus?.id
    };
  }

  // Quality Assessment (Gemini API)
  private async assessResponseQuality(response: string): Promise<number> {
    // Gemini: "이 응답이 수사에 유용한 정보를 포함하는가?" (0-1)
    // 구현 생략...
  }
}
```

#### Response

```json
{
  "response": "그때 저는 집에 있었어요. 아무도 증명할 수 없지만...",
  "suspectId": "case-2025-10-21-suspect-1",
  "actionPointsGained": 1,
  "triggeredTopics": ["topic-alibi-1"],
  "currentActionPoints": 4
}
```

### 4.4 Investigation - Location Search (AP 소비)

**API Endpoint**: `POST /api/location/search`
**파일**: `src/server/index.ts:1092-1332`

#### Request

```json
{
  "caseId": "case-2025-10-21",
  "userId": "reddit-user-123",
  "locationId": "loc-1",
  "searchType": "thorough"
}
```

#### 백엔드 프로세스

```typescript
// src/server/index.ts:1092-1332
app.post('/api/location/search', async (req, res) => {
  const { caseId, userId, locationId, searchType } = req.body;

  // 1. Player State 로드
  const playerState = await kvStore.get(`player:${userId}:${caseId}`);

  // 2. AP Cost 계산
  const apCost = caseData.actionPoints.costs[searchType];
  // quick: 1, thorough: 2, exhaustive: 3

  // 3. AP 검증
  if (playerState.actionPoints.current < apCost) {
    // Emergency AP 제공 (1회)
    if (!playerState.actionPoints.emergencyAPUsed) {
      const emergencyAP = apService.provideEmergencyAP(playerState.actionPoints);

      playerState.actionPoints.current += emergencyAP;
      playerState.actionPoints.total += emergencyAP;
      playerState.actionPoints.emergencyAPUsed = true;

      await kvStore.put(`player:${userId}:${caseId}`, playerState);

      return res.status(402).json({
        error: 'insufficient_ap',
        emergencyAPProvided: emergencyAP,
        message: '긴급 AP 1회 제공됨',
        currentAP: playerState.actionPoints.current
      });
    } else {
      return res.status(402).json({
        error: 'insufficient_ap',
        required: apCost,
        current: playerState.actionPoints.current
      });
    }
  }

  // 4. AP 차감
  playerState.actionPoints.current -= apCost;
  playerState.actionPoints.spent += apCost;

  // 5. 증거 탐색 (확률 기반)
  const location = caseData.locations.find(l => l.id === locationId);
  const discoveredEvidence: EvidenceItem[] = [];

  for (const evidence of location.evidenceItems) {
    const probability = evidence.discoveryProbability[searchType];
    const roll = Math.random();

    if (roll < probability) {
      // 중복 방지
      const alreadyFound = playerState.discoveredEvidence.some(
        e => e.id === evidence.id
      );

      if (!alreadyFound) {
        discoveredEvidence.push(evidence);
        playerState.discoveredEvidence.push(evidence);
      }
    }
  }

  // 6. 방문 기록
  if (!playerState.visitedLocations.includes(locationId)) {
    playerState.visitedLocations.push(locationId);
  }

  playerState.locationSearchCounts[locationId] =
    (playerState.locationSearchCounts[locationId] || 0) + 1;

  // 7. Spending History
  playerState.actionPoints.spendingHistory.push({
    amount: apCost,
    purpose: 'location_search',
    locationId,
    searchType,
    evidenceFound: discoveredEvidence.length,
    timestamp: new Date()
  });

  // 8. Player State 저장
  await kvStore.put(`player:${userId}:${caseId}`, playerState);

  // 9. Completion Rate 계산
  const totalEvidence = location.evidenceItems.length;
  const foundCount = playerState.discoveredEvidence.filter(
    e => location.evidenceItems.some(le => le.id === e.id)
  ).length;
  const completionRate = (foundCount / totalEvidence) * 100;

  res.json({
    success: true,
    evidenceFound: discoveredEvidence,
    actionPointsRemaining: playerState.actionPoints.current,
    actionCost: apCost,
    completionRate
  });
});
```

#### Response

```json
{
  "success": true,
  "evidenceFound": [
    {
      "id": "ev-1",
      "type": "physical",
      "name": "독극물 병",
      "description": "카페 쓰레기통에서 발견된 빈 병",
      "significance": "범행 도구"
    }
  ],
  "actionPointsRemaining": 2,
  "actionCost": 2,
  "completionRate": 50
}
```

### 4.5 Emergency AP System

```typescript
// src/server/services/ActionPointsService.ts
class ActionPointsService {
  provideEmergencyAP(playerAP: ActionPointsState): number {
    if (playerAP.emergencyAPUsed) return 0;

    // 1회 한정 AP 제공
    const emergencyAmount = 2; // 충분한 탐색을 위해 2 AP

    playerAP.acquisitionHistory.push({
      amount: emergencyAmount,
      source: 'emergency',
      timestamp: new Date()
    });

    return emergencyAmount;
  }
}
```

---

## Phase 5: 답안 제출 및 채점

### 5.1 답안 제출

**API Endpoint**: `POST /api/submit`
**파일**: `src/server/index.ts:983-1090`

#### Request

```json
{
  "caseId": "case-2025-10-21",
  "userId": "reddit-user-123",
  "selectedSuspectId": "case-2025-10-21-suspect-1",
  "reasoning": "김민수는 알리바이가 불확실하고, 피해자와 금전 문제가 있었으며..."
}
```

#### 백엔드 프로세스

```typescript
// src/server/index.ts:983-1090
app.post('/api/submit', async (req, res) => {
  const { caseId, userId, selectedSuspectId, reasoning } = req.body;

  // 1. 중복 제출 방지
  const playerState = await kvStore.get(`player:${userId}:${caseId}`);
  if (playerState.hasSubmitted) {
    return res.status(400).json({ error: 'already_submitted' });
  }

  // 2. 정답 확인
  const selectedSuspect = await caseRepository.getSuspect(selectedSuspectId);
  const isCorrect = selectedSuspect.isGuilty;

  // 3. AP Integrity Check (Phase 3)
  const integrityResult = await apService.verifyAPIntegrity(
    playerState.actionPoints,
    caseData.actionPoints
  );

  if (!integrityResult.isValid) {
    console.warn('⚠️ AP Integrity violation:', integrityResult.violations);
    // 치팅 감지 로그 저장 (현재는 경고만)
  }

  // 4. Gemini Scoring API 호출
  const scoringResult = await scoringService.scoreReasoning(
    reasoning,
    caseData,
    selectedSuspect,
    playerState.discoveredEvidence,
    isCorrect
  );

  // 5. 최종 점수 계산
  const baseScore = isCorrect ? scoringResult.score : 0;
  const bonusScore = calculateBonusScore(playerState);
  const finalScore = baseScore + bonusScore;

  // 6. Submission 저장
  const submission = {
    userId,
    caseId,
    selectedSuspectId,
    reasoning,
    isCorrect,
    score: finalScore,
    scoringBreakdown: {
      base: baseScore,
      bonus: bonusScore,
      total: finalScore
    },
    apIntegrity: integrityResult,
    submittedAt: new Date()
  };

  await kvStore.put(`submission:${userId}:${caseId}`, submission);

  // 7. Leaderboard 업데이트
  await leaderboardService.updateLeaderboard(caseId, userId, finalScore);

  // 8. Player State 업데이트
  playerState.hasSubmitted = true;
  await kvStore.put(`player:${userId}:${caseId}`, playerState);

  res.json({
    isCorrect,
    score: finalScore,
    scoringBreakdown: submission.scoringBreakdown,
    feedback: scoringResult.feedback
  });
});
```

### 5.2 Gemini Scoring Service

```typescript
// src/server/services/ScoringService.ts
class ScoringService {
  async scoreReasoning(
    reasoning: string,
    caseData: Case,
    selectedSuspect: Suspect,
    discoveredEvidence: EvidenceItem[],
    isCorrect: boolean
  ): Promise<ScoringResult> {

    const prompt = `
    당신은 추리 소설 평가자입니다. 다음 추리를 0-100점으로 평가하세요.

    사건: ${caseData.detailedDescription}
    용의자: ${selectedSuspect.name} (${selectedSuspect.background})
    발견한 증거: ${discoveredEvidence.map(e => e.name).join(', ')}
    제출한 추리: ${reasoning}
    정답 여부: ${isCorrect ? '정답' : '오답'}

    평가 기준:
    - 논리적 일관성 (30점)
    - 증거 활용 (30점)
    - 통찰력 (20점)
    - 설득력 (20점)

    오답인 경우 최대 50점까지만 부여.
    `;

    const response = await geminiClient.generateContent({
      model: 'gemini-2.0-flash',
      contents: [{ role: 'user', parts: [{ text: prompt }] }]
    });

    const score = this.parseScore(response.text);
    const feedback = this.extractFeedback(response.text);

    return { score, feedback };
  }
}
```

#### Response

```json
{
  "isCorrect": true,
  "score": 92,
  "scoringBreakdown": {
    "base": 87,
    "bonus": 5,
    "total": 92
  },
  "feedback": "논리적이고 증거에 기반한 우수한 추리입니다..."
}
```

### 5.3 Leaderboard 조회

**API Endpoint**: `GET /api/leaderboard/:caseId`
**파일**: `src/server/index.ts:1546-1587`

#### Request

```
GET /api/leaderboard/case-2025-10-21?limit=100
```

#### Response

```json
{
  "caseId": "case-2025-10-21",
  "entries": [
    {
      "rank": 1,
      "userId": "reddit-user-456",
      "score": 95,
      "submittedAt": "2025-10-21T12:34:56Z",
      "isCorrect": true
    },
    {
      "rank": 2,
      "userId": "reddit-user-123",
      "score": 92,
      "submittedAt": "2025-10-21T11:23:45Z",
      "isCorrect": true
    }
  ],
  "totalEntries": 2,
  "userRank": 2
}
```

---

## 데이터 흐름 상세

### AP 획득 플로우

```
User: "사건 당시 어디 있었나요?"
    │
    ├─▶ POST /api/chat/:suspectId
    │   └─ Gemini Chat API
    │       └─ Response: "저는 집에 있었습니다..."
    │
    ├─▶ APService.analyzeConversation()
    │   ├─ Topic Detection
    │   │   └─ "어디", "있었" → topic-alibi-1 매칭
    │   ├─ Quality Check (if required)
    │   │   └─ Gemini: "이 응답이 유용한가?" → 0.85
    │   ├─ Reward Calculation
    │   │   └─ topic-alibi-1: +1 AP
    │   └─ Bonus Detection
    │       └─ None
    │
    ├─▶ Player State 업데이트
    │   ├─ actionPoints.current: 3 → 4
    │   ├─ actionPoints.total: 3 → 4
    │   ├─ acquiredTopics: ["topic-alibi-1"]
    │   └─ acquisitionHistory: [{
    │         amount: 1,
    │         source: 'interrogation',
    │         suspectId: "suspect-1",
    │         topics: ["topic-alibi-1"]
    │       }]
    │
    └─▶ Response: { apGained: 1, currentAP: 4 }
```

### AP 소비 플로우

```
User: Thorough Search at "카페 현장"
    │
    ├─▶ POST /api/location/search
    │   ├─ Body: {
    │   │   locationId: "loc-1",
    │   │   searchType: "thorough"
    │   │ }
    │   └─ AP Cost: caseData.actionPoints.costs.thorough = 2
    │
    ├─▶ AP Validation
    │   ├─ Current: 4 AP
    │   ├─ Required: 2 AP
    │   └─ ✅ Sufficient
    │
    ├─▶ Evidence Discovery (확률 기반)
    │   ├─ Evidence 1: "독극물 병"
    │   │   └─ Thorough Probability: 0.7 → Roll: 0.45 → ✅ Found
    │   ├─ Evidence 2: "영수증"
    │   │   └─ Thorough Probability: 0.5 → Roll: 0.82 → ❌ Not Found
    │   └─ discoveredEvidence: ["독극물 병"]
    │
    ├─▶ Player State 업데이트
    │   ├─ actionPoints.current: 4 → 2
    │   ├─ actionPoints.spent: 0 → 2
    │   ├─ visitedLocations: ["loc-1"]
    │   ├─ locationSearchCounts: { "loc-1": 1 }
    │   ├─ discoveredEvidence: [{ id: "ev-1", name: "독극물 병" }]
    │   └─ spendingHistory: [{
    │         amount: 2,
    │         purpose: 'location_search',
    │         locationId: "loc-1",
    │         searchType: "thorough",
    │         evidenceFound: 1
    │       }]
    │
    └─▶ Response: {
          evidenceFound: ["독극물 병"],
          actionPointsRemaining: 2,
          completionRate: 50
        }
```

### 전체 플레이어 저니 (AP 관점)

```
Time: 0min
AP: 3 (initial)
    │
    ├─ [10min] Interrogate Suspect 1
    │  └─ Topic: "alibi" → +1 AP
    │  └─ AP: 3 → 4
    │
    ├─ [15min] Interrogate Suspect 2
    │  └─ Topic: "relationship" → +1 AP
    │  └─ Bonus: "insight" → +1 AP
    │  └─ AP: 4 → 6
    │
    ├─ [20min] Quick Search "카페"
    │  └─ Cost: -1 AP
    │  └─ Found: 1 evidence (독극물 병)
    │  └─ AP: 6 → 5
    │
    ├─ [25min] Interrogate Suspect 3
    │  └─ Topic: "motive" → +1 AP
    │  └─ AP: 5 → 6
    │
    ├─ [30min] Thorough Search "피해자 집"
    │  └─ Cost: -2 AP
    │  └─ Found: 2 evidence
    │  └─ AP: 6 → 4
    │
    ├─ [35min] Exhaustive Search "용의자 차량"
    │  └─ Cost: -3 AP
    │  └─ Found: 3 evidence
    │  └─ AP: 4 → 1
    │
    ├─ [40min] Try Quick Search "현장 주변"
    │  └─ Required: 1 AP, Current: 1 AP
    │  └─ ✅ Sufficient
    │  └─ AP: 1 → 0
    │
    ├─ [42min] Try Thorough Search (no AP left)
    │  └─ Required: 2 AP, Current: 0 AP
    │  └─ ❌ Emergency AP Triggered (1회 제공)
    │  └─ Emergency: +2 AP
    │  └─ AP: 0 → 2
    │
    ├─ [45min] Thorough Search "현장 주변"
    │  └─ Cost: -2 AP
    │  └─ Found: 1 evidence
    │  └─ AP: 2 → 0
    │
    └─ [50min] Submit Answer
       └─ Total AP Acquired: 7 (3 initial + 4 from topics)
       └─ Total AP Spent: 9 (6 searches + 3 emergency)
       └─ Final AP: 0
```

---

## Redis 데이터 구조

### 1. Case Data

**Key**: `case:{caseId}`
**Example**: `case:case-2025-10-21`

```json
{
  "id": "case-2025-10-21",
  "date": "2025-10-21",
  "title": "강남역 근처 독살 사건",
  "summary": "...",
  "detailedDescription": "...",
  "imageUrl": "data:image/jpeg;base64,...",
  "introNarration": "밤 11시...",
  "locations": [...],
  "actionPoints": {
    "initial": 3,
    "maximum": 12,
    "costs": { "quick": 1, "thorough": 2, "exhaustive": 3 }
  },
  "suspectIds": ["case-2025-10-21-suspect-1", "..."],
  "createdAt": "2025-10-20T00:00:00Z"
}
```

### 2. Case Date Index

**Key**: `case:date:{YYYY-MM-DD}`
**Value**: `{caseId}` (string)
**Example**: `case:date:2025-10-21` → `"case-2025-10-21"`

### 3. Case Suspects Index

**Key**: `case:{caseId}:suspects`
**Value**: `[suspectId1, suspectId2, suspectId3]`
**Example**: `case:case-2025-10-21:suspects` → `["case-2025-10-21-suspect-1", "..."]`

### 4. Suspect Data

**Key**: `suspect:{suspectId}`
**Example**: `suspect:case-2025-10-21-suspect-1`

```json
{
  "id": "case-2025-10-21-suspect-1",
  "caseId": "case-2025-10-21",
  "name": "김민수",
  "archetype": "nervous",
  "isGuilty": true,
  "background": "...",
  "personality": "...",
  "emotionalState": "...",
  "profileImageUrl": "data:image/jpeg;base64,...",
  "hasProfileImage": true,
  "apTopics": [...]
}
```

### 5. Player State

**Key**: `player:{userId}:{caseId}`
**Example**: `player:reddit-user-123:case-2025-10-21`

```json
{
  "caseId": "case-2025-10-21",
  "userId": "reddit-user-123",
  "actionPoints": {
    "current": 2,
    "total": 7,
    "spent": 5,
    "initial": 3,
    "acquisitionHistory": [...],
    "spendingHistory": [...],
    "acquiredTopics": ["topic-alibi-1", "topic-relationship-1"],
    "bonusesAcquired": ["bonus-insight-1"],
    "emergencyAPUsed": false
  },
  "discoveredEvidence": [...],
  "visitedLocations": ["loc-1", "loc-2"],
  "locationSearchCounts": { "loc-1": 2, "loc-2": 1 },
  "hasSubmitted": false
}
```

### 6. Conversation History

**Key**: `conversation:{conversationId}`
**Example**: `conversation:reddit-user-123-suspect-1-session-abc`

```json
{
  "conversationId": "reddit-user-123-suspect-1-session-abc",
  "userId": "reddit-user-123",
  "suspectId": "case-2025-10-21-suspect-1",
  "caseId": "case-2025-10-21",
  "messages": [
    {
      "role": "user",
      "content": "사건 당시 어디 있었나요?",
      "timestamp": "2025-10-21T10:00:00Z"
    },
    {
      "role": "assistant",
      "content": "저는 집에 있었습니다...",
      "timestamp": "2025-10-21T10:00:05Z",
      "apGained": 1,
      "triggeredTopics": ["topic-alibi-1"]
    }
  ],
  "createdAt": "2025-10-21T10:00:00Z",
  "lastMessageAt": "2025-10-21T10:00:05Z"
}
```

### 7. Submission

**Key**: `submission:{userId}:{caseId}`
**Example**: `submission:reddit-user-123:case-2025-10-21`

```json
{
  "userId": "reddit-user-123",
  "caseId": "case-2025-10-21",
  "selectedSuspectId": "case-2025-10-21-suspect-1",
  "reasoning": "김민수는...",
  "isCorrect": true,
  "score": 92,
  "scoringBreakdown": {
    "base": 87,
    "bonus": 5,
    "total": 92
  },
  "apIntegrity": {
    "isValid": true,
    "violations": []
  },
  "submittedAt": "2025-10-21T10:30:00Z"
}
```

### 8. Leaderboard

**Key**: `leaderboard:{caseId}`
**Value**: Sorted Set (score → userId)
**Example**: `leaderboard:case-2025-10-21`

```
ZADD leaderboard:case-2025-10-21 95 "reddit-user-456"
ZADD leaderboard:case-2025-10-21 92 "reddit-user-123"
ZADD leaderboard:case-2025-10-21 88 "reddit-user-789"

ZREVRANGE leaderboard:case-2025-10-21 0 99 WITHSCORES
→ [
    "reddit-user-456", 95,
    "reddit-user-123", 92,
    "reddit-user-789", 88
  ]
```

---

## 통합 테스트 시나리오

### 시나리오 1: 정상 플레이 (AP 적절히 사용)

```gherkin
Given 플레이어가 게임을 시작함
When 케이스가 로드됨
Then AP는 3이어야 함

# Interrogation Phase
When "김민수"에게 "알리바이"를 질문함
Then AP가 1 증가하여 4가 됨
And acquiredTopics에 "topic-alibi-1"이 추가됨

When "이서연"에게 "관계"를 질문함
Then AP가 1 증가하여 5가 됨

When "박준혁"에게 "동기"를 질문함
Then AP가 1 증가하고 bonus로 1 추가되어 7이 됨

# Evidence Discovery Phase
When "카페 현장"에서 Quick Search 수행
Then AP가 1 차감되어 6이 됨
And 독극물 병(확률 30%) 발견 가능

When "피해자 집"에서 Thorough Search 수행
Then AP가 2 차감되어 4가 됨
And 영수증(확률 70%) 발견 가능

When "용의자 차량"에서 Exhaustive Search 수행
Then AP가 3 차감되어 1이 됨
And 지문(확률 95%) 발견 가능

# Submission
When "김민수"를 범인으로 선택하고 추리 제출
Then 정답이 맞으면 87점 획득
And 리더보드에 등록됨
```

### 시나리오 2: AP 부족 (Emergency AP 트리거)

```gherkin
Given 플레이어가 AP를 모두 소진함 (AP = 0)
When Thorough Search(비용 2 AP) 시도
Then Error 402 "insufficient_ap" 발생
And Emergency AP 2 제공됨 (1회 한정)
And AP가 0 → 2로 증가

When 다시 Thorough Search 수행
Then AP가 2 차감되어 0이 됨
And 증거 발견 성공

When 다시 AP 부족 상태에서 Quick Search 시도
Then Error 402 "insufficient_ap" 발생
And Emergency AP는 제공되지 않음 (이미 사용됨)
```

### 시나리오 3: AP Integrity Check (Phase 3)

```gherkin
Given 플레이어가 답안을 제출함
When APService.verifyAPIntegrity() 실행
Then 다음을 검증:
  - 총 획득 AP <= (초기 AP + 최대 Topic AP + 최대 Bonus AP + Emergency AP)
  - 총 소비 AP <= 총 획득 AP
  - acquiredTopics가 중복되지 않음
  - emergencyAPUsed가 정확함

If 검증 실패
Then apIntegrity.isValid = false
And violations 배열에 위반 내역 기록
And 콘솔에 경고 로그 출력 (현재는 제출 거부하지 않음)
```

### 시나리오 4: 2-Stage Image Loading

```gherkin
Given 플레이어가 Investigation 화면 진입
When GET /api/case/today 호출
Then suspects[].hasProfileImage = true 반환
And suspects[].profileImageUrl은 반환되지 않음

When SuspectPanel 컴포넌트 렌더링
Then 각 suspect에 대해 GET /api/suspect-image/:suspectId 호출
And progressively 이미지 로드됨
And loadedImages state 업데이트

Then UI에 프로필 이미지 표시됨 (~16KB JPEG)
```

### 시나리오 5: Cinematic Intro

```gherkin
Given 케이스에 introNarration이 있음
When 게임이 로드됨
Then currentScreen = 'intro'로 설정

When CinematicIntro 컴포넌트 렌더링
Then 타이핑 효과로 narration 표시 (30ms/char)
And "조사 시작" 버튼이 끝에 나타남

When "조사 시작" 버튼 클릭
Then currentScreen = 'case-overview'로 전환
```

---

## API 엔드포인트 전체 목록

### Case Management (6)

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/case/generate` | 케이스 수동 생성 (개발용) |
| POST | `/api/case/regenerate` | 기존 케이스 재생성 |
| POST | `/internal/menu/post-create` | Reddit 포스트 생성 |
| GET | `/api/case/today` | 오늘의 케이스 조회 |
| GET | `/api/case/:caseId` | 특정 케이스 조회 |
| DELETE | `/api/case/:caseId` | 케이스 삭제 (개발용) |

### Suspect & Interrogation (4)

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/api/suspects/:caseId` | 케이스의 용의자 목록 |
| GET | `/api/suspect-image/:suspectId` | 프로필 이미지 로드 (2-stage) |
| POST | `/api/chat/:suspectId` | AI 용의자와 대화 (AP 획득) |
| GET | `/api/conversation/:suspectId/:userId` | 대화 이력 조회 |

### Evidence Discovery (3)

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/location/search` | 위치 탐색 (AP 소비) |
| GET | `/api/player-state/:caseId/:userId` | 플레이어 상태 조회 |
| POST | `/api/player-state/initialize` | 플레이어 상태 초기화 (AP=3) |

### Action Points (2)

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/api/player/:userId/ap-status` | AP 현황 조회 |
| GET | `/api/admin/ap-integrity/:userId` | AP Integrity 검증 (Phase 3) |

### Scoring (3)

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/submit` | 답안 제출 및 채점 |
| GET | `/api/leaderboard/:caseId` | 리더보드 조회 |
| GET | `/api/stats/:caseId` | 케이스 통계 조회 |

### Internal (2)

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/api/health` | Health Check |
| GET | `/internal/scheduler/daily-case` | 스케줄러 수동 실행 |

**Total: 20 Endpoints**

---

## 주요 데이터 변환

### Case Generation → Redis

```typescript
// CaseGeneratorService Output
{
  title, summary, detailedDescription,
  imageUrl (Base64),
  suspects: [{ name, archetype, isGuilty, apTopics, ... }],
  locations: [{ id, evidenceItems: [...] }],
  actionPoints: { initial, maximum, costs }
}

// ↓ Transform ↓

// Redis: case:{caseId}
{
  id, date, title, summary, detailedDescription, imageUrl,
  locations, actionPoints, suspectIds: [...]
}

// Redis: suspect:{suspectId} (x3)
{
  id, caseId, name, archetype, isGuilty,
  profileImageUrl (Base64 JPEG ~16KB),
  apTopics: [...]
}
```

### API Response → Frontend

```typescript
// Backend: GET /api/case/today
{
  ...caseData,
  suspects: [
    { id, name, archetype, hasProfileImage: true }
    // profileImageUrl 제외 (2-stage loading)
  ]
}

// ↓ Frontend ↓

// App.tsx: caseData state
{
  ...caseData,
  suspects: [...]  // hasProfileImage only
}

// SuspectPanel.tsx: loadedImages state
{
  "suspect-1": "data:image/jpeg;base64,...",
  "suspect-2": "data:image/jpeg;base64,...",
  "suspect-3": "data:image/jpeg;base64,..."
}
```

### Player State Evolution

```typescript
// Initial (POST /api/player-state/initialize)
{
  actionPoints: { current: 3, total: 3, spent: 0, ... },
  discoveredEvidence: [],
  visitedLocations: [],
  hasSubmitted: false
}

// ↓ After Interrogation ↓

{
  actionPoints: { current: 5, total: 5, spent: 0, acquiredTopics: [2] },
  discoveredEvidence: [],
  visitedLocations: [],
  hasSubmitted: false
}

// ↓ After Evidence Discovery ↓

{
  actionPoints: { current: 3, total: 5, spent: 2, ... },
  discoveredEvidence: [3 items],
  visitedLocations: [2 locations],
  hasSubmitted: false
}

// ↓ After Submission ↓

{
  actionPoints: { current: 0, total: 7, spent: 7, ... },
  discoveredEvidence: [5 items],
  visitedLocations: [3 locations],
  hasSubmitted: true
}
```

---

## 성능 메트릭

### 케이스 생성 시간

```
Case Generation (Total: ~14초)
├─ Story Generation (Gemini Text): ~3초
├─ Case Image (Imagen 3): ~4초
├─ Profile Images x3 (parallel): ~6초
│   ├─ Imagen 3 API: ~4초
│   └─ Sharp Compression: ~2초
└─ Redis Storage: <100ms
```

### API 응답 시간

```
GET /api/case/today: ~200ms
  ├─ Redis read (case): ~50ms
  ├─ Redis read (suspects x3): ~100ms
  └─ Data transformation: ~50ms

GET /api/suspect-image/:id: ~50ms
  └─ Redis read: ~50ms
  └─ Base64 already stored

POST /api/chat/:suspectId: ~2-4초
  ├─ Gemini Chat API: ~2-3초
  ├─ AP Analysis: ~100ms
  └─ Redis write: ~50ms

POST /api/location/search: ~100ms
  ├─ Redis read/write: ~50ms
  └─ Probability calculation: ~50ms

POST /api/submit: ~3-5초
  ├─ Gemini Scoring API: ~3-4초
  ├─ Leaderboard update: ~100ms
  └─ Redis writes: ~50ms
```

### 프론트엔드 로딩

```
Initial Load: ~1초
  ├─ React App bundle: ~500ms
  ├─ GET /api/case/today: ~200ms
  └─ Render: ~300ms

Investigation Screen: +2초 (progressive)
  ├─ Initial render: ~100ms
  └─ 3x GET /api/suspect-image: ~150ms (parallel)
      └─ 이미지 표시: staggered (50ms 간격)
```

---

## 배포 및 테스트

### 로컬 개발

```bash
# 1. 의존성 설치
npm install

# 2. 환경 변수 설정
cp .env.example .env
# GEMINI_API_KEY, VERCEL_IMAGE_FUNCTION_URL 설정

# 3. 빌드
npm run build

# 4. Devvit Playtest
devvit playtest
```

### Devvit 배포

```bash
# 1. Devvit 로그인
devvit login

# 2. 앱 업로드
devvit upload

# 3. 서브레딧에 설치
# Reddit → Mod Tools → Installed Apps → Install

# 4. Scheduler 활성화 확인
# Devvit Dashboard → Schedulers → daily-case-generator
```

### 검증 체크리스트

#### ✅ Case Generation

- [ ] DailyCaseScheduler가 매일 00:00 UTC에 실행됨
- [ ] 케이스 스토리가 Gemini로 생성됨
- [ ] 케이스 이미지가 생성됨 (includeImage: true)
- [ ] 프로필 이미지 3개가 생성됨 (includeSuspectImages: true)
- [ ] Sharp 압축으로 각 이미지 ~16KB
- [ ] Redis에 case, suspect x3 저장됨

#### ✅ Reddit Post

- [ ] Custom Post가 r/armchair_sleuths_dev에 생성됨
- [ ] 포스트 클릭 시 React App 로드됨

#### ✅ Game Play

- [ ] Loading → Intro (cinematic) → Case Overview 전환
- [ ] 프로필 이미지 progressive loading 작동
- [ ] AP 초기값 3 설정됨
- [ ] Interrogation에서 AP 획득 작동 (Topic 감지)
- [ ] Location Search에서 AP 소비 작동
- [ ] Emergency AP 1회 제공 작동
- [ ] 증거 발견 확률 시스템 작동

#### ✅ Submission

- [ ] 답안 제출 성공
- [ ] Gemini Scoring API 작동
- [ ] 리더보드 업데이트
- [ ] AP Integrity Check 작동

---

## 문서 히스토리

**v1.0** (2025-01-15)
- 초기 버전
- 5개 화면 문서화
- 이미지 버그 3건 기록

**v2.0** (2025-10-21)
- 완전한 재작성
- 6개 화면으로 업데이트 (Cinematic Intro 추가)
- Evidence Discovery System 추가
- Action Points System Phase 2 & 3 추가
- 2-stage image loading 설명
- 20+ API 엔드포인트 전체 문서화
- 모든 구버전 버그 제거 (해결됨)
- 통합 테스트 시나리오 추가
- Redis 데이터 구조 상세화
- 데이터 흐름 다이어그램 추가

---

**문서 작성**: Claude Code (Sonnet 4.5)
**프로젝트**: Armchair Sleuths (Reddit Devvit)
**Last Updated**: 2025-10-21
