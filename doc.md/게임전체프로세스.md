# Armchair Sleuths - ê²Œì„ ì „ì²´ í”„ë¡œì„¸ìŠ¤ (v2.0)

**ë¬¸ì„œ ë²„ì „**: 2.0
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-21
**ê²Œì„ ë²„ì „**: Phase 3 (AP Integrity System)

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ì „ì²´ í”„ë¡œì„¸ìŠ¤ ê°œìš”](#ì „ì²´-í”„ë¡œì„¸ìŠ¤-ê°œìš”)
3. [Phase 1: ì¼€ì´ìŠ¤ ìƒì„±](#phase-1-ì¼€ì´ìŠ¤-ìƒì„±)
4. [Phase 2: Reddit í¬ìŠ¤íŠ¸ ìƒì„±](#phase-2-reddit-í¬ìŠ¤íŠ¸-ìƒì„±)
5. [Phase 3: ê²Œì„ ì´ˆê¸°í™”](#phase-3-ê²Œì„-ì´ˆê¸°í™”)
6. [Phase 4: ê²Œì„ í”Œë ˆì´](#phase-4-ê²Œì„-í”Œë ˆì´)
7. [Phase 5: ë‹µì•ˆ ì œì¶œ ë° ì±„ì ](#phase-5-ë‹µì•ˆ-ì œì¶œ-ë°-ì±„ì )
8. [ë°ì´í„° íë¦„ ìƒì„¸](#ë°ì´í„°-íë¦„-ìƒì„¸)
9. [Redis ë°ì´í„° êµ¬ì¡°](#redis-ë°ì´í„°-êµ¬ì¡°)
10. [í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤](#í†µí•©-í…ŒìŠ¤íŠ¸-ì‹œë‚˜ë¦¬ì˜¤)

---

## ê°œìš”

Armchair SleuthsëŠ” Reddit Devvit í”Œë«í¼ ê¸°ë°˜ì˜ ì¼ì¼ ì¶”ë¦¬ ê²Œì„ì…ë‹ˆë‹¤. ë³¸ ë¬¸ì„œëŠ” ì¼€ì´ìŠ¤ ìƒì„±ë¶€í„° ë‹µì•ˆ ì œì¶œê¹Œì§€ì˜ ì „ì²´ í”„ë¡œì„¸ìŠ¤ë¥¼ end-to-endë¡œ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.

### ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Devvit Platform                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Scheduler  â”‚    â”‚    Backend   â”‚    â”‚   Frontend   â”‚ â”‚
â”‚  â”‚  (Cron Job)  â”‚â”€â”€â”€â–¶â”‚  Express API â”‚â—€â”€â”€â”€â”‚  React App   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                    â”‚                    â”‚        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                              â”‚                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                    â”‚   Redis KV Store  â”‚                   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Gemini AI API   â”‚
                    â”‚  (Case, Image,    â”‚
                    â”‚   Chat, Scoring)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ê²Œì„ í™”ë©´ íë¦„ (6 Screens)

```
Loading â†’ Cinematic Intro â†’ Case Overview â†’ Investigation â†’ Submission â†’ Results
  (1)          (2)               (3)             (4)            (5)        (6)
```

---

## ì „ì²´ í”„ë¡œì„¸ìŠ¤ ê°œìš”

### íƒ€ì„ë¼ì¸

```
Day N-1 23:59 UTC
    â”‚
    â”œâ”€â–¶ [Phase 1] DailyCaseScheduler ì‹¤í–‰ (~14ì´ˆ)
    â”‚   â””â”€ Gemini API: ì¼€ì´ìŠ¤ ìƒì„± + ì´ë¯¸ì§€ ìƒì„±
    â”‚   â””â”€ Redis: ì¼€ì´ìŠ¤ ë° ìš©ì˜ì ì €ì¥
    â”‚
Day N 00:00 UTC
    â”‚
    â”œâ”€â–¶ [Phase 2] Reddit í¬ìŠ¤íŠ¸ ìƒì„± (ìˆ˜ë™ ë˜ëŠ” ìë™)
    â”‚   â””â”€ Devvit: Custom Post ìƒì„±
    â”‚
    â”œâ”€â–¶ [Phase 3] í”Œë ˆì´ì–´ê°€ í¬ìŠ¤íŠ¸ í´ë¦­
    â”‚   â””â”€ React App ë¡œë“œ
    â”‚   â””â”€ API: ì¼€ì´ìŠ¤ ë°ì´í„° fetch
    â”‚   â””â”€ API: Player State ì´ˆê¸°í™” (AP=3)
    â”‚
    â”œâ”€â–¶ [Phase 4] ê²Œì„ í”Œë ˆì´
    â”‚   â”œâ”€ Cinematic Intro (íƒ€ì´í•‘ íš¨ê³¼)
    â”‚   â”œâ”€ Case Overview (ì‚¬ê±´ ê°œìš”)
    â”‚   â”œâ”€ Investigation
    â”‚   â”‚   â”œâ”€ Suspect Interrogation (AP íšë“)
    â”‚   â”‚   â”‚   â””â”€ AP Topic ê°ì§€ â†’ +1~2 AP
    â”‚   â”‚   â”‚   â””â”€ Bonus ê°ì§€ â†’ +1 AP
    â”‚   â”‚   â”‚   â””â”€ Emergency AP (1íšŒ ì œê³µ)
    â”‚   â”‚   â””â”€ Location Search (AP ì†Œë¹„)
    â”‚   â”‚       â””â”€ Quick Search: -1 AP
    â”‚   â”‚       â””â”€ Thorough Search: -2 AP
    â”‚   â”‚       â””â”€ Exhaustive Search: -3 AP
    â”‚   â””â”€ Submission (ìš©ì˜ì ì„ íƒ + ì¶”ë¦¬)
    â”‚
    â””â”€â–¶ [Phase 5] ë‹µì•ˆ ì œì¶œ ë° ì±„ì 
        â””â”€ Gemini AI: ì¶”ë¦¬ í‰ê°€ (0-100ì )
        â””â”€ Leaderboard ì—…ë°ì´íŠ¸
```

---

## Phase 1: ì¼€ì´ìŠ¤ ìƒì„±

### 1.1 Daily Scheduler íŠ¸ë¦¬ê±°

**íŒŒì¼**: `src/server/schedulers/DailyCaseScheduler.ts`
**ì‹¤í–‰ ì‹œê°„**: ë§¤ì¼ 00:00 UTC (Devvit Scheduler)

```typescript
// DailyCaseScheduler.ts:35-50
scheduler.cron({
  name: 'daily-case-generator',
  cron: '0 0 * * *', // ë§¤ì¼ ìì • UTC
  async onRun() {
    const geminiClient = createGeminiClient(context);
    const caseGenerator = createCaseGeneratorService(geminiClient);

    const newCase = await caseGenerator.generateCase({
      date: new Date(),
      includeImage: true,           // âœ… ì¼€ì´ìŠ¤ ì´ë¯¸ì§€ ìƒì„±
      includeSuspectImages: true    // âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ ìƒì„±
    });

    console.log('âœ… Daily case generated:', newCase.id);
  }
});
```

### 1.2 ì¼€ì´ìŠ¤ ìƒì„± í”„ë¡œì„¸ìŠ¤

**API Endpoint**: `POST /api/case/generate` (ìˆ˜ë™ ìƒì„±ìš©)
**íŒŒì¼**: `src/server/index.ts:170-191`

```
CaseGeneratorService.generateCase()
    â”‚
    â”œâ”€â–¶ [Step 1] Case Element ì„ íƒ (10ì´ˆ)
    â”‚   â””â”€ CaseElementLibrary.getTodaysCaseElements()
    â”‚       â””â”€ crime, location, victim, weapon, motive ëœë¤ ì„ íƒ
    â”‚
    â”œâ”€â–¶ [Step 2] ì¼€ì´ìŠ¤ ìŠ¤í† ë¦¬ ìƒì„± (Gemini Text)
    â”‚   â””â”€ generateCaseStory()
    â”‚       â””â”€ title, summary, detailedDescription ìƒì„±
    â”‚       â””â”€ 3ëª…ì˜ ìš©ì˜ì ìƒì„± (1ëª… ë²”ì¸)
    â”‚       â””â”€ ì¦ê±°ë¬¼ ë° ìœ„ì¹˜ ìƒì„±
    â”‚       â””â”€ AP Topics ìƒì„± (ìš©ì˜ìë³„ 5-7ê°œ)
    â”‚       â””â”€ Intro Narration ìƒì„± (cinematic)
    â”‚
    â”œâ”€â–¶ [Step 3] ì¼€ì´ìŠ¤ ì´ë¯¸ì§€ ìƒì„± (Gemini Image, if includeImage)
    â”‚   â””â”€ generateCaseImage()
    â”‚       â””â”€ Imagen 3 API í˜¸ì¶œ
    â”‚       â””â”€ Base64 ì¸ì½”ë”©
    â”‚
    â”œâ”€â–¶ [Step 4] í”„ë¡œí•„ ì´ë¯¸ì§€ ìƒì„± (3x Gemini Image, if includeSuspectImages)
    â”‚   â””â”€ generateSuspectProfileImages()
    â”‚       â””â”€ Promise.allSettled([...]) // ë³‘ë ¬ ì²˜ë¦¬
    â”‚       â””â”€ ê° ìš©ì˜ì ì´ë¯¸ì§€ Vercel Function í˜¸ì¶œ
    â”‚           â””â”€ /api/generate-image (Sharp ì••ì¶•)
    â”‚               â””â”€ 1.5MB PNG â†’ 16KB JPEG ì••ì¶•
    â”‚               â””â”€ data:image/jpeg;base64,... í˜•ì‹ ë°˜í™˜
    â”‚
    â””â”€â–¶ [Step 5] Redis ì €ì¥
        â””â”€ CaseRepository.createCase()
            â”œâ”€ KVStoreManager.saveCase()
            â”‚   â””â”€ Redis: case:case-2025-10-21
            â”‚   â””â”€ Redis: case:date:2025-10-21 â†’ case-2025-10-21
            â””â”€ KVStoreManager.saveSuspect() x3
                â””â”€ Redis: suspect:case-2025-10-21-suspect-1
                â””â”€ Redis: suspect:case-2025-10-21-suspect-2
                â””â”€ Redis: suspect:case-2025-10-21-suspect-3
                â””â”€ ê°ê° profileImageUrl í¬í•¨ (Base64 JPEG)
```

### 1.3 ìƒì„±ëœ ë°ì´í„° êµ¬ì¡°

**Case ë°ì´í„°** (Redis: `case:case-2025-10-21`)

```typescript
{
  id: "case-2025-10-21",
  date: "2025-10-21",
  title: "ê°•ë‚¨ì—­ ê·¼ì²˜ ë…ì‚´ ì‚¬ê±´",
  summary: "ê°•ë‚¨ì—­ ì¸ê·¼ ì¹´í˜ì—ì„œ 30ëŒ€ ë‚¨ì„±ì´ ë…ê·¹ë¬¼ ì¤‘ë…ìœ¼ë¡œ ì‚¬ë§...",
  imageUrl: "data:image/jpeg;base64,...",
  introNarration: "ë°¤ 11ì‹œ, ê°•ë‚¨ì—­ ê·¼ì²˜ ì¡°ìš©í•œ ì¹´í˜...",

  // Evidence Discovery System
  locations: [
    {
      id: "loc-1",
      name: "ì¹´í˜ í˜„ì¥",
      description: "ì‚¬ê±´ì´ ë°œìƒí•œ ì¹´í˜",
      evidenceItems: [
        {
          id: "ev-1",
          type: "physical",
          name: "ë…ê·¹ë¬¼ ë³‘",
          significance: "ë²”í–‰ ë„êµ¬",
          discoveryProbability: { quick: 0.3, thorough: 0.7, exhaustive: 0.95 }
        }
      ]
    }
  ],

  // Action Points Configuration
  actionPoints: {
    initial: 3,
    maximum: 12,
    costs: { quick: 1, thorough: 2, exhaustive: 3 }
  },

  // Suspects with AP Topics
  suspectIds: ["suspect-1", "suspect-2", "suspect-3"]
}
```

**Suspect ë°ì´í„°** (Redis: `suspect:case-2025-10-21-suspect-1`)

```typescript
{
  id: "case-2025-10-21-suspect-1",
  caseId: "case-2025-10-21",
  name: "ê¹€ë¯¼ìˆ˜",
  archetype: "nervous",
  isGuilty: true,

  // Profile
  background: "í”¼í•´ìì˜ ì „ ì§ì¥ ë™ë£Œ",
  personality: "ë¶ˆì•ˆí•˜ê³  ë°©ì–´ì ",
  emotionalState: "ê¸´ì¥",
  profileImageUrl: "data:image/jpeg;base64,/9j/4AAQSkZJRg...", // ~16KB
  hasProfileImage: true,

  // AP Topics (5-7ê°œ)
  apTopics: [
    {
      id: "topic-alibi-1",
      category: "alibi",
      keywords: ["ì–´ë””", "ìˆì—ˆ", "ë‹¹ì‹œ", "ì‹œê°„"],
      apReward: 1,
      requiresQuality: true,
      description: "ì•Œë¦¬ë°”ì´ ì •ë³´ íšë“",
      triggered: false
    },
    {
      id: "topic-relationship-1",
      category: "relationship",
      keywords: ["í”¼í•´ì", "ê´€ê³„", "ì•Œê³ "],
      apReward: 1,
      requiresQuality: true,
      description: "í”¼í•´ìì™€ì˜ ê´€ê³„ íŒŒì•…",
      triggered: false
    }
    // ... 3-5ê°œ ë”
  ]
}
```

---

## Phase 2: Reddit í¬ìŠ¤íŠ¸ ìƒì„±

### 2.1 í¬ìŠ¤íŠ¸ ìƒì„± API

**API Endpoint**: `POST /internal/menu/post-create`
**íŒŒì¼**: `src/main.tsx:75-120`

```typescript
// Devvit Menu Action
Devvit.addMenuItem({
  label: 'Create Case Post',
  location: 'subreddit',
  async onPress(event, context) {
    const todaysCase = await caseRepository.getTodaysCase();

    if (!todaysCase) {
      ui.showToast('No case available for today');
      return;
    }

    const post = await reddit.submitCustomPost({
      title: todaysCase.title,
      subredditName: 'armchair_sleuths_dev',
      preview: <blocks>
        <vstack>
          <text>ğŸ” Daily Mystery Case</text>
          <text>Tap to investigate!</text>
        </vstack>
      </blocks>
    });

    ui.showToast(`âœ… Post created: ${post.id}`);
  }
});
```

### 2.2 ì»¤ìŠ¤í…€ í¬ìŠ¤íŠ¸ êµ¬ì¡°

```typescript
// Custom Post Type Definition
Devvit.addCustomPostType({
  name: 'Case Investigation',
  height: 'tall',
  render: (context) => {
    // React App ë Œë”ë§
    return <App context={context} />;
  }
});
```

---

## Phase 3: ê²Œì„ ì´ˆê¸°í™”

### 3.1 ì¼€ì´ìŠ¤ ë°ì´í„° ë¡œë“œ

**API Endpoint**: `GET /api/case/today`
**íŒŒì¼**: `src/server/index.ts:196-253`

#### Request

```
GET /api/case/today
```

#### Response (ì£¼ìš” í•„ë“œ)

```typescript
{
  // Case Info
  id: "case-2025-10-21",
  title: "ê°•ë‚¨ì—­ ê·¼ì²˜ ë…ì‚´ ì‚¬ê±´",
  imageUrl: "data:image/jpeg;base64,...",
  introNarration: "ë°¤ 11ì‹œ, ê°•ë‚¨ì—­ ê·¼ì²˜...",

  // Suspects (2-stage loading)
  suspects: [
    {
      id: "case-2025-10-21-suspect-1",
      name: "ê¹€ë¯¼ìˆ˜",
      archetype: "nervous",
      hasProfileImage: true,  // âš ï¸ Phase 1: flag only
      // profileImageUrlì€ ë³„ë„ APIë¡œ ë¡œë“œ
    }
  ],

  // Evidence Discovery
  locations: [...],

  // Action Points
  actionPoints: {
    initial: 3,
    maximum: 12,
    costs: { quick: 1, thorough: 2, exhaustive: 3 }
  }
}
```

#### ë°±ì—”ë“œ ë¡œì§

```typescript
// src/server/index.ts:196-253
app.get('/api/case/today', async (req, res) => {
  const todaysCase = await caseRepository.getTodaysCase();
  const fullSuspects = await caseRepository.getCaseSuspects(todaysCase.id);

  // âš ï¸ 2-stage loading: profileImageUrl ì œì™¸
  const suspectsData = fullSuspects.map(s => ({
    id: s.id,
    name: s.name,
    archetype: s.archetype,
    hasProfileImage: s.hasProfileImage,  // flag only
    background: s.background,
    personality: s.personality,
    emotionalState: s.emotionalState
    // profileImageUrlì€ ì œì™¸ (ë³„ë„ API)
  }));

  res.json({
    ...todaysCase,
    suspects: suspectsData
  });
});
```

**Why 2-stage loading?**
- ì´ˆê¸° payload í¬ê¸° ê°ì†Œ (~150KB â†’ ~10KB)
- 500 error ë°©ì§€ (Devvit payload ì œí•œ)
- ì´ë¯¸ì§€ëŠ” Investigation í™”ë©´ì—ì„œ lazy load

### 3.2 í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ (2-stage)

**API Endpoint**: `GET /api/suspect-image/:suspectId`
**íŒŒì¼**: `src/server/index.ts:255-276`

#### Request

```
GET /api/suspect-image/case-2025-10-21-suspect-1
```

#### Response

```typescript
{
  suspectId: "case-2025-10-21-suspect-1",
  profileImageUrl: "data:image/jpeg;base64,/9j/4AAQSkZJRg...", // ~16KB
  hasImage: true
}
```

#### Frontend í†µí•© (Progressive Loading)

```typescript
// src/client/components/SuspectPanel.tsx
const [loadedImages, setLoadedImages] = useState<Record<string, string>>({});

useEffect(() => {
  suspects.forEach(async (suspect) => {
    if (suspect.hasProfileImage && !loadedImages[suspect.id]) {
      const response = await fetch(`/api/suspect-image/${suspect.id}`);
      const data = await response.json();

      setLoadedImages(prev => ({
        ...prev,
        [suspect.id]: data.profileImageUrl
      }));
    }
  });
}, [suspects]);
```

### 3.3 í”Œë ˆì´ì–´ ìƒíƒœ ì´ˆê¸°í™”

**API Endpoint**: `POST /api/player-state/initialize`
**íŒŒì¼**: `src/server/index.ts:1353-1398`

#### Request

```json
{
  "caseId": "case-2025-10-21",
  "userId": "reddit-user-123"
}
```

#### Response

```typescript
{
  caseId: "case-2025-10-21",
  userId: "reddit-user-123",

  // Action Points (ì´ˆê¸°í™”)
  actionPoints: {
    current: 3,        // actionPoints.initial
    total: 3,          // ëˆ„ì  íšë“
    spent: 0,          // ëˆ„ì  ì†Œë¹„
    initial: 3,
    acquisitionHistory: [],
    spendingHistory: [],
    acquiredTopics: [],
    bonusesAcquired: [],
    emergencyAPUsed: false
  },

  // Evidence Discovery
  discoveredEvidence: [],
  visitedLocations: [],
  locationSearchCounts: {},

  // Submission
  hasSubmitted: false
}
```

#### ë°±ì—”ë“œ ë¡œì§

```typescript
// src/server/index.ts:1353-1398
function initializeActionPoints(caseData, playerState) {
  if (!playerState.actionPoints) {
    playerState.actionPoints = {
      current: caseData.actionPoints.initial,  // 3
      total: caseData.actionPoints.initial,
      spent: 0,
      initial: caseData.actionPoints.initial,
      acquisitionHistory: [],
      spendingHistory: [],
      acquiredTopics: new Set<string>(),
      bonusesAcquired: new Set<string>(),
      emergencyAPUsed: false
    };
  }
}
```

---

## Phase 4: ê²Œì„ í”Œë ˆì´

### 4.1 í™”ë©´ ì „í™˜ íë¦„

```typescript
// src/client/App.tsx:50-80
type GameScreen =
  | 'loading'       // ì¼€ì´ìŠ¤ ë¡œë”© ì¤‘
  | 'intro'         // Cinematic Intro (íƒ€ì´í•‘ íš¨ê³¼)
  | 'case-overview' // ì‚¬ê±´ ê°œìš”
  | 'investigation' // ìš©ì˜ì ëŒ€í™” + ì¦ê±° íƒìƒ‰
  | 'submission'    // ë‹µì•ˆ ì œì¶œ
  | 'results';      // ê²°ê³¼ ë° ë¦¬ë”ë³´ë“œ

// í™”ë©´ ì „í™˜ ë¡œì§
useEffect(() => {
  if (caseData && currentScreen === 'loading') {
    if (caseData.introNarration) {
      setCurrentScreen('intro');  // Cinematic ìˆìœ¼ë©´ intro
    } else {
      setCurrentScreen('case-overview');  // ì—†ìœ¼ë©´ ë°”ë¡œ overview
    }
  }
}, [caseLoading, caseError, caseData, currentScreen]);
```

### 4.2 Cinematic Intro (Screen 2)

**ì»´í¬ë„ŒíŠ¸**: `src/client/components/CinematicIntro.tsx`

```typescript
// íƒ€ì´í•‘ íš¨ê³¼ êµ¬í˜„
function CinematicIntro({ narration, onComplete }) {
  const [displayedText, setDisplayedText] = useState('');
  const [currentIndex, setCurrentIndex] = useState(0);

  useEffect(() => {
    if (currentIndex < narration.length) {
      const timer = setTimeout(() => {
        setDisplayedText(prev => prev + narration[currentIndex]);
        setCurrentIndex(prev => prev + 1);
      }, 30); // 30ms per character

      return () => clearTimeout(timer);
    }
  }, [currentIndex, narration]);

  return (
    <div className="cinematic-intro">
      <p className="narration">{displayedText}</p>
      {currentIndex === narration.length && (
        <button onClick={onComplete}>ì¡°ì‚¬ ì‹œì‘</button>
      )}
    </div>
  );
}
```

### 4.3 Investigation - Suspect Interrogation (AP íšë“)

**API Endpoint**: `POST /api/chat/:suspectId`
**íŒŒì¼**: `src/server/index.ts:733-981`

#### Request

```json
{
  "message": "ì‚¬ê±´ ë‹¹ì‹œ ì–´ë”” ìˆì—ˆë‚˜ìš”?",
  "userId": "reddit-user-123",
  "conversationHistory": []
}
```

#### ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤

```typescript
// src/server/index.ts:733-981
app.post('/api/chat/:suspectId', async (req, res) => {
  const { suspectId } = req.params;
  const { message, userId, conversationHistory } = req.body;

  // 1. Gemini Chat API í˜¸ì¶œ
  const chatResponse = await suspectChatService.chat(
    suspectId,
    message,
    conversationHistory,
    caseData
  );

  // 2. AP Topic ë¶„ì„ (Phase 2)
  const apResult = apService.analyzeConversation(
    message,
    chatResponse.response,
    suspect,
    caseData,
    playerState.actionPoints,
    conversationId
  );

  // 3. AP íšë“ ì²˜ë¦¬
  if (apResult.apGained > 0) {
    playerState.actionPoints.current += apResult.apGained;
    playerState.actionPoints.total += apResult.apGained;

    // íšë“ ì´ë ¥ ì €ì¥
    playerState.actionPoints.acquisitionHistory.push({
      amount: apResult.apGained,
      source: 'interrogation',
      suspectId,
      topics: apResult.triggeredTopics,
      timestamp: new Date()
    });

    // Topic í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
    apResult.triggeredTopics.forEach(topicId => {
      playerState.actionPoints.acquiredTopics.add(topicId);

      // Redisì˜ suspectë„ ì—…ë°ì´íŠ¸
      const topic = suspect.apTopics.find(t => t.id === topicId);
      if (topic) topic.triggered = true;
    });
  }

  // 4. AP ìµœëŒ€ì¹˜ ì ìš©
  if (playerState.actionPoints.current > caseData.actionPoints.maximum) {
    playerState.actionPoints.current = caseData.actionPoints.maximum; // 12
  }

  // 5. Player State ì €ì¥
  await kvStore.put(`player:${userId}:${caseData.id}`, playerState);

  res.json({
    response: chatResponse.response,
    suspectId,
    actionPointsGained: apResult.apGained,
    triggeredTopics: apResult.triggeredTopics,
    currentActionPoints: playerState.actionPoints.current
  });
});
```

#### AP Acquisition Service

```typescript
// src/server/services/ActionPointsService.ts
class ActionPointsService {
  analyzeConversation(
    userMessage: string,
    aiResponse: string,
    suspect: Suspect,
    caseData: Case,
    playerAP: ActionPointsState,
    conversationId: string
  ): APAnalysisResult {

    let totalAPGained = 0;
    const triggeredTopics: string[] = [];

    // 1. Topic ê°ì§€
    for (const topic of suspect.apTopics) {
      if (topic.triggered) continue; // ì´ë¯¸ íŠ¸ë¦¬ê±°ë¨

      // í‚¤ì›Œë“œ ë§¤ì¹­
      const hasKeyword = topic.keywords.some(keyword =>
        userMessage.includes(keyword) || aiResponse.includes(keyword)
      );

      if (hasKeyword) {
        // Quality Check (if required)
        if (topic.requiresQuality) {
          const qualityScore = this.assessResponseQuality(aiResponse);
          if (qualityScore < 0.6) continue; // ë‚®ì€ í’ˆì§ˆì€ AP ì—†ìŒ
        }

        totalAPGained += topic.apReward;
        triggeredTopics.push(topic.id);
      }
    }

    // 2. Bonus Detection
    const bonus = this.detectBonus(userMessage, aiResponse, caseData);
    if (bonus && !playerAP.bonusesAcquired.has(bonus.id)) {
      totalAPGained += bonus.reward;
      playerAP.bonusesAcquired.add(bonus.id);
    }

    return {
      apGained: totalAPGained,
      triggeredTopics,
      bonusId: bonus?.id
    };
  }

  // Quality Assessment (Gemini API)
  private async assessResponseQuality(response: string): Promise<number> {
    // Gemini: "ì´ ì‘ë‹µì´ ìˆ˜ì‚¬ì— ìœ ìš©í•œ ì •ë³´ë¥¼ í¬í•¨í•˜ëŠ”ê°€?" (0-1)
    // êµ¬í˜„ ìƒëµ...
  }
}
```

#### Response

```json
{
  "response": "ê·¸ë•Œ ì €ëŠ” ì§‘ì— ìˆì—ˆì–´ìš”. ì•„ë¬´ë„ ì¦ëª…í•  ìˆ˜ ì—†ì§€ë§Œ...",
  "suspectId": "case-2025-10-21-suspect-1",
  "actionPointsGained": 1,
  "triggeredTopics": ["topic-alibi-1"],
  "currentActionPoints": 4
}
```

### 4.4 Investigation - Location Search (AP ì†Œë¹„)

**API Endpoint**: `POST /api/location/search`
**íŒŒì¼**: `src/server/index.ts:1092-1332`

#### Request

```json
{
  "caseId": "case-2025-10-21",
  "userId": "reddit-user-123",
  "locationId": "loc-1",
  "searchType": "thorough"
}
```

#### ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤

```typescript
// src/server/index.ts:1092-1332
app.post('/api/location/search', async (req, res) => {
  const { caseId, userId, locationId, searchType } = req.body;

  // 1. Player State ë¡œë“œ
  const playerState = await kvStore.get(`player:${userId}:${caseId}`);

  // 2. AP Cost ê³„ì‚°
  const apCost = caseData.actionPoints.costs[searchType];
  // quick: 1, thorough: 2, exhaustive: 3

  // 3. AP ê²€ì¦
  if (playerState.actionPoints.current < apCost) {
    // Emergency AP ì œê³µ (1íšŒ)
    if (!playerState.actionPoints.emergencyAPUsed) {
      const emergencyAP = apService.provideEmergencyAP(playerState.actionPoints);

      playerState.actionPoints.current += emergencyAP;
      playerState.actionPoints.total += emergencyAP;
      playerState.actionPoints.emergencyAPUsed = true;

      await kvStore.put(`player:${userId}:${caseId}`, playerState);

      return res.status(402).json({
        error: 'insufficient_ap',
        emergencyAPProvided: emergencyAP,
        message: 'ê¸´ê¸‰ AP 1íšŒ ì œê³µë¨',
        currentAP: playerState.actionPoints.current
      });
    } else {
      return res.status(402).json({
        error: 'insufficient_ap',
        required: apCost,
        current: playerState.actionPoints.current
      });
    }
  }

  // 4. AP ì°¨ê°
  playerState.actionPoints.current -= apCost;
  playerState.actionPoints.spent += apCost;

  // 5. ì¦ê±° íƒìƒ‰ (í™•ë¥  ê¸°ë°˜)
  const location = caseData.locations.find(l => l.id === locationId);
  const discoveredEvidence: EvidenceItem[] = [];

  for (const evidence of location.evidenceItems) {
    const probability = evidence.discoveryProbability[searchType];
    const roll = Math.random();

    if (roll < probability) {
      // ì¤‘ë³µ ë°©ì§€
      const alreadyFound = playerState.discoveredEvidence.some(
        e => e.id === evidence.id
      );

      if (!alreadyFound) {
        discoveredEvidence.push(evidence);
        playerState.discoveredEvidence.push(evidence);
      }
    }
  }

  // 6. ë°©ë¬¸ ê¸°ë¡
  if (!playerState.visitedLocations.includes(locationId)) {
    playerState.visitedLocations.push(locationId);
  }

  playerState.locationSearchCounts[locationId] =
    (playerState.locationSearchCounts[locationId] || 0) + 1;

  // 7. Spending History
  playerState.actionPoints.spendingHistory.push({
    amount: apCost,
    purpose: 'location_search',
    locationId,
    searchType,
    evidenceFound: discoveredEvidence.length,
    timestamp: new Date()
  });

  // 8. Player State ì €ì¥
  await kvStore.put(`player:${userId}:${caseId}`, playerState);

  // 9. Completion Rate ê³„ì‚°
  const totalEvidence = location.evidenceItems.length;
  const foundCount = playerState.discoveredEvidence.filter(
    e => location.evidenceItems.some(le => le.id === e.id)
  ).length;
  const completionRate = (foundCount / totalEvidence) * 100;

  res.json({
    success: true,
    evidenceFound: discoveredEvidence,
    actionPointsRemaining: playerState.actionPoints.current,
    actionCost: apCost,
    completionRate
  });
});
```

#### Response

```json
{
  "success": true,
  "evidenceFound": [
    {
      "id": "ev-1",
      "type": "physical",
      "name": "ë…ê·¹ë¬¼ ë³‘",
      "description": "ì¹´í˜ ì“°ë ˆê¸°í†µì—ì„œ ë°œê²¬ëœ ë¹ˆ ë³‘",
      "significance": "ë²”í–‰ ë„êµ¬"
    }
  ],
  "actionPointsRemaining": 2,
  "actionCost": 2,
  "completionRate": 50
}
```

### 4.5 Emergency AP System

```typescript
// src/server/services/ActionPointsService.ts
class ActionPointsService {
  provideEmergencyAP(playerAP: ActionPointsState): number {
    if (playerAP.emergencyAPUsed) return 0;

    // 1íšŒ í•œì • AP ì œê³µ
    const emergencyAmount = 2; // ì¶©ë¶„í•œ íƒìƒ‰ì„ ìœ„í•´ 2 AP

    playerAP.acquisitionHistory.push({
      amount: emergencyAmount,
      source: 'emergency',
      timestamp: new Date()
    });

    return emergencyAmount;
  }
}
```

---

## Phase 5: ë‹µì•ˆ ì œì¶œ ë° ì±„ì 

### 5.1 ë‹µì•ˆ ì œì¶œ

**API Endpoint**: `POST /api/submit`
**íŒŒì¼**: `src/server/index.ts:983-1090`

#### Request

```json
{
  "caseId": "case-2025-10-21",
  "userId": "reddit-user-123",
  "selectedSuspectId": "case-2025-10-21-suspect-1",
  "reasoning": "ê¹€ë¯¼ìˆ˜ëŠ” ì•Œë¦¬ë°”ì´ê°€ ë¶ˆí™•ì‹¤í•˜ê³ , í”¼í•´ìì™€ ê¸ˆì „ ë¬¸ì œê°€ ìˆì—ˆìœ¼ë©°..."
}
```

#### ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤

```typescript
// src/server/index.ts:983-1090
app.post('/api/submit', async (req, res) => {
  const { caseId, userId, selectedSuspectId, reasoning } = req.body;

  // 1. ì¤‘ë³µ ì œì¶œ ë°©ì§€
  const playerState = await kvStore.get(`player:${userId}:${caseId}`);
  if (playerState.hasSubmitted) {
    return res.status(400).json({ error: 'already_submitted' });
  }

  // 2. ì •ë‹µ í™•ì¸
  const selectedSuspect = await caseRepository.getSuspect(selectedSuspectId);
  const isCorrect = selectedSuspect.isGuilty;

  // 3. AP Integrity Check (Phase 3)
  const integrityResult = await apService.verifyAPIntegrity(
    playerState.actionPoints,
    caseData.actionPoints
  );

  if (!integrityResult.isValid) {
    console.warn('âš ï¸ AP Integrity violation:', integrityResult.violations);
    // ì¹˜íŒ… ê°ì§€ ë¡œê·¸ ì €ì¥ (í˜„ì¬ëŠ” ê²½ê³ ë§Œ)
  }

  // 4. Gemini Scoring API í˜¸ì¶œ
  const scoringResult = await scoringService.scoreReasoning(
    reasoning,
    caseData,
    selectedSuspect,
    playerState.discoveredEvidence,
    isCorrect
  );

  // 5. ìµœì¢… ì ìˆ˜ ê³„ì‚°
  const baseScore = isCorrect ? scoringResult.score : 0;
  const bonusScore = calculateBonusScore(playerState);
  const finalScore = baseScore + bonusScore;

  // 6. Submission ì €ì¥
  const submission = {
    userId,
    caseId,
    selectedSuspectId,
    reasoning,
    isCorrect,
    score: finalScore,
    scoringBreakdown: {
      base: baseScore,
      bonus: bonusScore,
      total: finalScore
    },
    apIntegrity: integrityResult,
    submittedAt: new Date()
  };

  await kvStore.put(`submission:${userId}:${caseId}`, submission);

  // 7. Leaderboard ì—…ë°ì´íŠ¸
  await leaderboardService.updateLeaderboard(caseId, userId, finalScore);

  // 8. Player State ì—…ë°ì´íŠ¸
  playerState.hasSubmitted = true;
  await kvStore.put(`player:${userId}:${caseId}`, playerState);

  res.json({
    isCorrect,
    score: finalScore,
    scoringBreakdown: submission.scoringBreakdown,
    feedback: scoringResult.feedback
  });
});
```

### 5.2 Gemini Scoring Service

```typescript
// src/server/services/ScoringService.ts
class ScoringService {
  async scoreReasoning(
    reasoning: string,
    caseData: Case,
    selectedSuspect: Suspect,
    discoveredEvidence: EvidenceItem[],
    isCorrect: boolean
  ): Promise<ScoringResult> {

    const prompt = `
    ë‹¹ì‹ ì€ ì¶”ë¦¬ ì†Œì„¤ í‰ê°€ìì…ë‹ˆë‹¤. ë‹¤ìŒ ì¶”ë¦¬ë¥¼ 0-100ì ìœ¼ë¡œ í‰ê°€í•˜ì„¸ìš”.

    ì‚¬ê±´: ${caseData.detailedDescription}
    ìš©ì˜ì: ${selectedSuspect.name} (${selectedSuspect.background})
    ë°œê²¬í•œ ì¦ê±°: ${discoveredEvidence.map(e => e.name).join(', ')}
    ì œì¶œí•œ ì¶”ë¦¬: ${reasoning}
    ì •ë‹µ ì—¬ë¶€: ${isCorrect ? 'ì •ë‹µ' : 'ì˜¤ë‹µ'}

    í‰ê°€ ê¸°ì¤€:
    - ë…¼ë¦¬ì  ì¼ê´€ì„± (30ì )
    - ì¦ê±° í™œìš© (30ì )
    - í†µì°°ë ¥ (20ì )
    - ì„¤ë“ë ¥ (20ì )

    ì˜¤ë‹µì¸ ê²½ìš° ìµœëŒ€ 50ì ê¹Œì§€ë§Œ ë¶€ì—¬.
    `;

    const response = await geminiClient.generateContent({
      model: 'gemini-2.0-flash',
      contents: [{ role: 'user', parts: [{ text: prompt }] }]
    });

    const score = this.parseScore(response.text);
    const feedback = this.extractFeedback(response.text);

    return { score, feedback };
  }
}
```

#### Response

```json
{
  "isCorrect": true,
  "score": 92,
  "scoringBreakdown": {
    "base": 87,
    "bonus": 5,
    "total": 92
  },
  "feedback": "ë…¼ë¦¬ì ì´ê³  ì¦ê±°ì— ê¸°ë°˜í•œ ìš°ìˆ˜í•œ ì¶”ë¦¬ì…ë‹ˆë‹¤..."
}
```

### 5.3 Leaderboard ì¡°íšŒ

**API Endpoint**: `GET /api/leaderboard/:caseId`
**íŒŒì¼**: `src/server/index.ts:1546-1587`

#### Request

```
GET /api/leaderboard/case-2025-10-21?limit=100
```

#### Response

```json
{
  "caseId": "case-2025-10-21",
  "entries": [
    {
      "rank": 1,
      "userId": "reddit-user-456",
      "score": 95,
      "submittedAt": "2025-10-21T12:34:56Z",
      "isCorrect": true
    },
    {
      "rank": 2,
      "userId": "reddit-user-123",
      "score": 92,
      "submittedAt": "2025-10-21T11:23:45Z",
      "isCorrect": true
    }
  ],
  "totalEntries": 2,
  "userRank": 2
}
```

---

## ë°ì´í„° íë¦„ ìƒì„¸

### AP íšë“ í”Œë¡œìš°

```
User: "ì‚¬ê±´ ë‹¹ì‹œ ì–´ë”” ìˆì—ˆë‚˜ìš”?"
    â”‚
    â”œâ”€â–¶ POST /api/chat/:suspectId
    â”‚   â””â”€ Gemini Chat API
    â”‚       â””â”€ Response: "ì €ëŠ” ì§‘ì— ìˆì—ˆìŠµë‹ˆë‹¤..."
    â”‚
    â”œâ”€â–¶ APService.analyzeConversation()
    â”‚   â”œâ”€ Topic Detection
    â”‚   â”‚   â””â”€ "ì–´ë””", "ìˆì—ˆ" â†’ topic-alibi-1 ë§¤ì¹­
    â”‚   â”œâ”€ Quality Check (if required)
    â”‚   â”‚   â””â”€ Gemini: "ì´ ì‘ë‹µì´ ìœ ìš©í•œê°€?" â†’ 0.85
    â”‚   â”œâ”€ Reward Calculation
    â”‚   â”‚   â””â”€ topic-alibi-1: +1 AP
    â”‚   â””â”€ Bonus Detection
    â”‚       â””â”€ None
    â”‚
    â”œâ”€â–¶ Player State ì—…ë°ì´íŠ¸
    â”‚   â”œâ”€ actionPoints.current: 3 â†’ 4
    â”‚   â”œâ”€ actionPoints.total: 3 â†’ 4
    â”‚   â”œâ”€ acquiredTopics: ["topic-alibi-1"]
    â”‚   â””â”€ acquisitionHistory: [{
    â”‚         amount: 1,
    â”‚         source: 'interrogation',
    â”‚         suspectId: "suspect-1",
    â”‚         topics: ["topic-alibi-1"]
    â”‚       }]
    â”‚
    â””â”€â–¶ Response: { apGained: 1, currentAP: 4 }
```

### AP ì†Œë¹„ í”Œë¡œìš°

```
User: Thorough Search at "ì¹´í˜ í˜„ì¥"
    â”‚
    â”œâ”€â–¶ POST /api/location/search
    â”‚   â”œâ”€ Body: {
    â”‚   â”‚   locationId: "loc-1",
    â”‚   â”‚   searchType: "thorough"
    â”‚   â”‚ }
    â”‚   â””â”€ AP Cost: caseData.actionPoints.costs.thorough = 2
    â”‚
    â”œâ”€â–¶ AP Validation
    â”‚   â”œâ”€ Current: 4 AP
    â”‚   â”œâ”€ Required: 2 AP
    â”‚   â””â”€ âœ… Sufficient
    â”‚
    â”œâ”€â–¶ Evidence Discovery (í™•ë¥  ê¸°ë°˜)
    â”‚   â”œâ”€ Evidence 1: "ë…ê·¹ë¬¼ ë³‘"
    â”‚   â”‚   â””â”€ Thorough Probability: 0.7 â†’ Roll: 0.45 â†’ âœ… Found
    â”‚   â”œâ”€ Evidence 2: "ì˜ìˆ˜ì¦"
    â”‚   â”‚   â””â”€ Thorough Probability: 0.5 â†’ Roll: 0.82 â†’ âŒ Not Found
    â”‚   â””â”€ discoveredEvidence: ["ë…ê·¹ë¬¼ ë³‘"]
    â”‚
    â”œâ”€â–¶ Player State ì—…ë°ì´íŠ¸
    â”‚   â”œâ”€ actionPoints.current: 4 â†’ 2
    â”‚   â”œâ”€ actionPoints.spent: 0 â†’ 2
    â”‚   â”œâ”€ visitedLocations: ["loc-1"]
    â”‚   â”œâ”€ locationSearchCounts: { "loc-1": 1 }
    â”‚   â”œâ”€ discoveredEvidence: [{ id: "ev-1", name: "ë…ê·¹ë¬¼ ë³‘" }]
    â”‚   â””â”€ spendingHistory: [{
    â”‚         amount: 2,
    â”‚         purpose: 'location_search',
    â”‚         locationId: "loc-1",
    â”‚         searchType: "thorough",
    â”‚         evidenceFound: 1
    â”‚       }]
    â”‚
    â””â”€â–¶ Response: {
          evidenceFound: ["ë…ê·¹ë¬¼ ë³‘"],
          actionPointsRemaining: 2,
          completionRate: 50
        }
```

### ì „ì²´ í”Œë ˆì´ì–´ ì €ë‹ˆ (AP ê´€ì )

```
Time: 0min
AP: 3 (initial)
    â”‚
    â”œâ”€ [10min] Interrogate Suspect 1
    â”‚  â””â”€ Topic: "alibi" â†’ +1 AP
    â”‚  â””â”€ AP: 3 â†’ 4
    â”‚
    â”œâ”€ [15min] Interrogate Suspect 2
    â”‚  â””â”€ Topic: "relationship" â†’ +1 AP
    â”‚  â””â”€ Bonus: "insight" â†’ +1 AP
    â”‚  â””â”€ AP: 4 â†’ 6
    â”‚
    â”œâ”€ [20min] Quick Search "ì¹´í˜"
    â”‚  â””â”€ Cost: -1 AP
    â”‚  â””â”€ Found: 1 evidence (ë…ê·¹ë¬¼ ë³‘)
    â”‚  â””â”€ AP: 6 â†’ 5
    â”‚
    â”œâ”€ [25min] Interrogate Suspect 3
    â”‚  â””â”€ Topic: "motive" â†’ +1 AP
    â”‚  â””â”€ AP: 5 â†’ 6
    â”‚
    â”œâ”€ [30min] Thorough Search "í”¼í•´ì ì§‘"
    â”‚  â””â”€ Cost: -2 AP
    â”‚  â””â”€ Found: 2 evidence
    â”‚  â””â”€ AP: 6 â†’ 4
    â”‚
    â”œâ”€ [35min] Exhaustive Search "ìš©ì˜ì ì°¨ëŸ‰"
    â”‚  â””â”€ Cost: -3 AP
    â”‚  â””â”€ Found: 3 evidence
    â”‚  â””â”€ AP: 4 â†’ 1
    â”‚
    â”œâ”€ [40min] Try Quick Search "í˜„ì¥ ì£¼ë³€"
    â”‚  â””â”€ Required: 1 AP, Current: 1 AP
    â”‚  â””â”€ âœ… Sufficient
    â”‚  â””â”€ AP: 1 â†’ 0
    â”‚
    â”œâ”€ [42min] Try Thorough Search (no AP left)
    â”‚  â””â”€ Required: 2 AP, Current: 0 AP
    â”‚  â””â”€ âŒ Emergency AP Triggered (1íšŒ ì œê³µ)
    â”‚  â””â”€ Emergency: +2 AP
    â”‚  â””â”€ AP: 0 â†’ 2
    â”‚
    â”œâ”€ [45min] Thorough Search "í˜„ì¥ ì£¼ë³€"
    â”‚  â””â”€ Cost: -2 AP
    â”‚  â””â”€ Found: 1 evidence
    â”‚  â””â”€ AP: 2 â†’ 0
    â”‚
    â””â”€ [50min] Submit Answer
       â””â”€ Total AP Acquired: 7 (3 initial + 4 from topics)
       â””â”€ Total AP Spent: 9 (6 searches + 3 emergency)
       â””â”€ Final AP: 0
```

---

## Redis ë°ì´í„° êµ¬ì¡°

### 1. Case Data

**Key**: `case:{caseId}`
**Example**: `case:case-2025-10-21`

```json
{
  "id": "case-2025-10-21",
  "date": "2025-10-21",
  "title": "ê°•ë‚¨ì—­ ê·¼ì²˜ ë…ì‚´ ì‚¬ê±´",
  "summary": "...",
  "detailedDescription": "...",
  "imageUrl": "data:image/jpeg;base64,...",
  "introNarration": "ë°¤ 11ì‹œ...",
  "locations": [...],
  "actionPoints": {
    "initial": 3,
    "maximum": 12,
    "costs": { "quick": 1, "thorough": 2, "exhaustive": 3 }
  },
  "suspectIds": ["case-2025-10-21-suspect-1", "..."],
  "createdAt": "2025-10-20T00:00:00Z"
}
```

### 2. Case Date Index

**Key**: `case:date:{YYYY-MM-DD}`
**Value**: `{caseId}` (string)
**Example**: `case:date:2025-10-21` â†’ `"case-2025-10-21"`

### 3. Case Suspects Index

**Key**: `case:{caseId}:suspects`
**Value**: `[suspectId1, suspectId2, suspectId3]`
**Example**: `case:case-2025-10-21:suspects` â†’ `["case-2025-10-21-suspect-1", "..."]`

### 4. Suspect Data

**Key**: `suspect:{suspectId}`
**Example**: `suspect:case-2025-10-21-suspect-1`

```json
{
  "id": "case-2025-10-21-suspect-1",
  "caseId": "case-2025-10-21",
  "name": "ê¹€ë¯¼ìˆ˜",
  "archetype": "nervous",
  "isGuilty": true,
  "background": "...",
  "personality": "...",
  "emotionalState": "...",
  "profileImageUrl": "data:image/jpeg;base64,...",
  "hasProfileImage": true,
  "apTopics": [...]
}
```

### 5. Player State

**Key**: `player:{userId}:{caseId}`
**Example**: `player:reddit-user-123:case-2025-10-21`

```json
{
  "caseId": "case-2025-10-21",
  "userId": "reddit-user-123",
  "actionPoints": {
    "current": 2,
    "total": 7,
    "spent": 5,
    "initial": 3,
    "acquisitionHistory": [...],
    "spendingHistory": [...],
    "acquiredTopics": ["topic-alibi-1", "topic-relationship-1"],
    "bonusesAcquired": ["bonus-insight-1"],
    "emergencyAPUsed": false
  },
  "discoveredEvidence": [...],
  "visitedLocations": ["loc-1", "loc-2"],
  "locationSearchCounts": { "loc-1": 2, "loc-2": 1 },
  "hasSubmitted": false
}
```

### 6. Conversation History

**Key**: `conversation:{conversationId}`
**Example**: `conversation:reddit-user-123-suspect-1-session-abc`

```json
{
  "conversationId": "reddit-user-123-suspect-1-session-abc",
  "userId": "reddit-user-123",
  "suspectId": "case-2025-10-21-suspect-1",
  "caseId": "case-2025-10-21",
  "messages": [
    {
      "role": "user",
      "content": "ì‚¬ê±´ ë‹¹ì‹œ ì–´ë”” ìˆì—ˆë‚˜ìš”?",
      "timestamp": "2025-10-21T10:00:00Z"
    },
    {
      "role": "assistant",
      "content": "ì €ëŠ” ì§‘ì— ìˆì—ˆìŠµë‹ˆë‹¤...",
      "timestamp": "2025-10-21T10:00:05Z",
      "apGained": 1,
      "triggeredTopics": ["topic-alibi-1"]
    }
  ],
  "createdAt": "2025-10-21T10:00:00Z",
  "lastMessageAt": "2025-10-21T10:00:05Z"
}
```

### 7. Submission

**Key**: `submission:{userId}:{caseId}`
**Example**: `submission:reddit-user-123:case-2025-10-21`

```json
{
  "userId": "reddit-user-123",
  "caseId": "case-2025-10-21",
  "selectedSuspectId": "case-2025-10-21-suspect-1",
  "reasoning": "ê¹€ë¯¼ìˆ˜ëŠ”...",
  "isCorrect": true,
  "score": 92,
  "scoringBreakdown": {
    "base": 87,
    "bonus": 5,
    "total": 92
  },
  "apIntegrity": {
    "isValid": true,
    "violations": []
  },
  "submittedAt": "2025-10-21T10:30:00Z"
}
```

### 8. Leaderboard

**Key**: `leaderboard:{caseId}`
**Value**: Sorted Set (score â†’ userId)
**Example**: `leaderboard:case-2025-10-21`

```
ZADD leaderboard:case-2025-10-21 95 "reddit-user-456"
ZADD leaderboard:case-2025-10-21 92 "reddit-user-123"
ZADD leaderboard:case-2025-10-21 88 "reddit-user-789"

ZREVRANGE leaderboard:case-2025-10-21 0 99 WITHSCORES
â†’ [
    "reddit-user-456", 95,
    "reddit-user-123", 92,
    "reddit-user-789", 88
  ]
```

---

## í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì •ìƒ í”Œë ˆì´ (AP ì ì ˆíˆ ì‚¬ìš©)

```gherkin
Given í”Œë ˆì´ì–´ê°€ ê²Œì„ì„ ì‹œì‘í•¨
When ì¼€ì´ìŠ¤ê°€ ë¡œë“œë¨
Then APëŠ” 3ì´ì–´ì•¼ í•¨

# Interrogation Phase
When "ê¹€ë¯¼ìˆ˜"ì—ê²Œ "ì•Œë¦¬ë°”ì´"ë¥¼ ì§ˆë¬¸í•¨
Then APê°€ 1 ì¦ê°€í•˜ì—¬ 4ê°€ ë¨
And acquiredTopicsì— "topic-alibi-1"ì´ ì¶”ê°€ë¨

When "ì´ì„œì—°"ì—ê²Œ "ê´€ê³„"ë¥¼ ì§ˆë¬¸í•¨
Then APê°€ 1 ì¦ê°€í•˜ì—¬ 5ê°€ ë¨

When "ë°•ì¤€í˜"ì—ê²Œ "ë™ê¸°"ë¥¼ ì§ˆë¬¸í•¨
Then APê°€ 1 ì¦ê°€í•˜ê³  bonusë¡œ 1 ì¶”ê°€ë˜ì–´ 7ì´ ë¨

# Evidence Discovery Phase
When "ì¹´í˜ í˜„ì¥"ì—ì„œ Quick Search ìˆ˜í–‰
Then APê°€ 1 ì°¨ê°ë˜ì–´ 6ì´ ë¨
And ë…ê·¹ë¬¼ ë³‘(í™•ë¥  30%) ë°œê²¬ ê°€ëŠ¥

When "í”¼í•´ì ì§‘"ì—ì„œ Thorough Search ìˆ˜í–‰
Then APê°€ 2 ì°¨ê°ë˜ì–´ 4ê°€ ë¨
And ì˜ìˆ˜ì¦(í™•ë¥  70%) ë°œê²¬ ê°€ëŠ¥

When "ìš©ì˜ì ì°¨ëŸ‰"ì—ì„œ Exhaustive Search ìˆ˜í–‰
Then APê°€ 3 ì°¨ê°ë˜ì–´ 1ì´ ë¨
And ì§€ë¬¸(í™•ë¥  95%) ë°œê²¬ ê°€ëŠ¥

# Submission
When "ê¹€ë¯¼ìˆ˜"ë¥¼ ë²”ì¸ìœ¼ë¡œ ì„ íƒí•˜ê³  ì¶”ë¦¬ ì œì¶œ
Then ì •ë‹µì´ ë§ìœ¼ë©´ 87ì  íšë“
And ë¦¬ë”ë³´ë“œì— ë“±ë¡ë¨
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: AP ë¶€ì¡± (Emergency AP íŠ¸ë¦¬ê±°)

```gherkin
Given í”Œë ˆì´ì–´ê°€ APë¥¼ ëª¨ë‘ ì†Œì§„í•¨ (AP = 0)
When Thorough Search(ë¹„ìš© 2 AP) ì‹œë„
Then Error 402 "insufficient_ap" ë°œìƒ
And Emergency AP 2 ì œê³µë¨ (1íšŒ í•œì •)
And APê°€ 0 â†’ 2ë¡œ ì¦ê°€

When ë‹¤ì‹œ Thorough Search ìˆ˜í–‰
Then APê°€ 2 ì°¨ê°ë˜ì–´ 0ì´ ë¨
And ì¦ê±° ë°œê²¬ ì„±ê³µ

When ë‹¤ì‹œ AP ë¶€ì¡± ìƒíƒœì—ì„œ Quick Search ì‹œë„
Then Error 402 "insufficient_ap" ë°œìƒ
And Emergency APëŠ” ì œê³µë˜ì§€ ì•ŠìŒ (ì´ë¯¸ ì‚¬ìš©ë¨)
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: AP Integrity Check (Phase 3)

```gherkin
Given í”Œë ˆì´ì–´ê°€ ë‹µì•ˆì„ ì œì¶œí•¨
When APService.verifyAPIntegrity() ì‹¤í–‰
Then ë‹¤ìŒì„ ê²€ì¦:
  - ì´ íšë“ AP <= (ì´ˆê¸° AP + ìµœëŒ€ Topic AP + ìµœëŒ€ Bonus AP + Emergency AP)
  - ì´ ì†Œë¹„ AP <= ì´ íšë“ AP
  - acquiredTopicsê°€ ì¤‘ë³µë˜ì§€ ì•ŠìŒ
  - emergencyAPUsedê°€ ì •í™•í•¨

If ê²€ì¦ ì‹¤íŒ¨
Then apIntegrity.isValid = false
And violations ë°°ì—´ì— ìœ„ë°˜ ë‚´ì—­ ê¸°ë¡
And ì½˜ì†”ì— ê²½ê³  ë¡œê·¸ ì¶œë ¥ (í˜„ì¬ëŠ” ì œì¶œ ê±°ë¶€í•˜ì§€ ì•ŠìŒ)
```

### ì‹œë‚˜ë¦¬ì˜¤ 4: 2-Stage Image Loading

```gherkin
Given í”Œë ˆì´ì–´ê°€ Investigation í™”ë©´ ì§„ì…
When GET /api/case/today í˜¸ì¶œ
Then suspects[].hasProfileImage = true ë°˜í™˜
And suspects[].profileImageUrlì€ ë°˜í™˜ë˜ì§€ ì•ŠìŒ

When SuspectPanel ì»´í¬ë„ŒíŠ¸ ë Œë”ë§
Then ê° suspectì— ëŒ€í•´ GET /api/suspect-image/:suspectId í˜¸ì¶œ
And progressively ì´ë¯¸ì§€ ë¡œë“œë¨
And loadedImages state ì—…ë°ì´íŠ¸

Then UIì— í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œë¨ (~16KB JPEG)
```

### ì‹œë‚˜ë¦¬ì˜¤ 5: Cinematic Intro

```gherkin
Given ì¼€ì´ìŠ¤ì— introNarrationì´ ìˆìŒ
When ê²Œì„ì´ ë¡œë“œë¨
Then currentScreen = 'intro'ë¡œ ì„¤ì •

When CinematicIntro ì»´í¬ë„ŒíŠ¸ ë Œë”ë§
Then íƒ€ì´í•‘ íš¨ê³¼ë¡œ narration í‘œì‹œ (30ms/char)
And "ì¡°ì‚¬ ì‹œì‘" ë²„íŠ¼ì´ ëì— ë‚˜íƒ€ë‚¨

When "ì¡°ì‚¬ ì‹œì‘" ë²„íŠ¼ í´ë¦­
Then currentScreen = 'case-overview'ë¡œ ì „í™˜
```

---

## API ì—”ë“œí¬ì¸íŠ¸ ì „ì²´ ëª©ë¡

### Case Management (6)

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| POST | `/api/case/generate` | ì¼€ì´ìŠ¤ ìˆ˜ë™ ìƒì„± (ê°œë°œìš©) |
| POST | `/api/case/regenerate` | ê¸°ì¡´ ì¼€ì´ìŠ¤ ì¬ìƒì„± |
| POST | `/internal/menu/post-create` | Reddit í¬ìŠ¤íŠ¸ ìƒì„± |
| GET | `/api/case/today` | ì˜¤ëŠ˜ì˜ ì¼€ì´ìŠ¤ ì¡°íšŒ |
| GET | `/api/case/:caseId` | íŠ¹ì • ì¼€ì´ìŠ¤ ì¡°íšŒ |
| DELETE | `/api/case/:caseId` | ì¼€ì´ìŠ¤ ì‚­ì œ (ê°œë°œìš©) |

### Suspect & Interrogation (4)

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| GET | `/api/suspects/:caseId` | ì¼€ì´ìŠ¤ì˜ ìš©ì˜ì ëª©ë¡ |
| GET | `/api/suspect-image/:suspectId` | í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ (2-stage) |
| POST | `/api/chat/:suspectId` | AI ìš©ì˜ìì™€ ëŒ€í™” (AP íšë“) |
| GET | `/api/conversation/:suspectId/:userId` | ëŒ€í™” ì´ë ¥ ì¡°íšŒ |

### Evidence Discovery (3)

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| POST | `/api/location/search` | ìœ„ì¹˜ íƒìƒ‰ (AP ì†Œë¹„) |
| GET | `/api/player-state/:caseId/:userId` | í”Œë ˆì´ì–´ ìƒíƒœ ì¡°íšŒ |
| POST | `/api/player-state/initialize` | í”Œë ˆì´ì–´ ìƒíƒœ ì´ˆê¸°í™” (AP=3) |

### Action Points (2)

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| GET | `/api/player/:userId/ap-status` | AP í˜„í™© ì¡°íšŒ |
| GET | `/api/admin/ap-integrity/:userId` | AP Integrity ê²€ì¦ (Phase 3) |

### Scoring (3)

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| POST | `/api/submit` | ë‹µì•ˆ ì œì¶œ ë° ì±„ì  |
| GET | `/api/leaderboard/:caseId` | ë¦¬ë”ë³´ë“œ ì¡°íšŒ |
| GET | `/api/stats/:caseId` | ì¼€ì´ìŠ¤ í†µê³„ ì¡°íšŒ |

### Internal (2)

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| GET | `/api/health` | Health Check |
| GET | `/internal/scheduler/daily-case` | ìŠ¤ì¼€ì¤„ëŸ¬ ìˆ˜ë™ ì‹¤í–‰ |

**Total: 20 Endpoints**

---

## ì£¼ìš” ë°ì´í„° ë³€í™˜

### Case Generation â†’ Redis

```typescript
// CaseGeneratorService Output
{
  title, summary, detailedDescription,
  imageUrl (Base64),
  suspects: [{ name, archetype, isGuilty, apTopics, ... }],
  locations: [{ id, evidenceItems: [...] }],
  actionPoints: { initial, maximum, costs }
}

// â†“ Transform â†“

// Redis: case:{caseId}
{
  id, date, title, summary, detailedDescription, imageUrl,
  locations, actionPoints, suspectIds: [...]
}

// Redis: suspect:{suspectId} (x3)
{
  id, caseId, name, archetype, isGuilty,
  profileImageUrl (Base64 JPEG ~16KB),
  apTopics: [...]
}
```

### API Response â†’ Frontend

```typescript
// Backend: GET /api/case/today
{
  ...caseData,
  suspects: [
    { id, name, archetype, hasProfileImage: true }
    // profileImageUrl ì œì™¸ (2-stage loading)
  ]
}

// â†“ Frontend â†“

// App.tsx: caseData state
{
  ...caseData,
  suspects: [...]  // hasProfileImage only
}

// SuspectPanel.tsx: loadedImages state
{
  "suspect-1": "data:image/jpeg;base64,...",
  "suspect-2": "data:image/jpeg;base64,...",
  "suspect-3": "data:image/jpeg;base64,..."
}
```

### Player State Evolution

```typescript
// Initial (POST /api/player-state/initialize)
{
  actionPoints: { current: 3, total: 3, spent: 0, ... },
  discoveredEvidence: [],
  visitedLocations: [],
  hasSubmitted: false
}

// â†“ After Interrogation â†“

{
  actionPoints: { current: 5, total: 5, spent: 0, acquiredTopics: [2] },
  discoveredEvidence: [],
  visitedLocations: [],
  hasSubmitted: false
}

// â†“ After Evidence Discovery â†“

{
  actionPoints: { current: 3, total: 5, spent: 2, ... },
  discoveredEvidence: [3 items],
  visitedLocations: [2 locations],
  hasSubmitted: false
}

// â†“ After Submission â†“

{
  actionPoints: { current: 0, total: 7, spent: 7, ... },
  discoveredEvidence: [5 items],
  visitedLocations: [3 locations],
  hasSubmitted: true
}
```

---

## ì„±ëŠ¥ ë©”íŠ¸ë¦­

### ì¼€ì´ìŠ¤ ìƒì„± ì‹œê°„

```
Case Generation (Total: ~14ì´ˆ)
â”œâ”€ Story Generation (Gemini Text): ~3ì´ˆ
â”œâ”€ Case Image (Imagen 3): ~4ì´ˆ
â”œâ”€ Profile Images x3 (parallel): ~6ì´ˆ
â”‚   â”œâ”€ Imagen 3 API: ~4ì´ˆ
â”‚   â””â”€ Sharp Compression: ~2ì´ˆ
â””â”€ Redis Storage: <100ms
```

### API ì‘ë‹µ ì‹œê°„

```
GET /api/case/today: ~200ms
  â”œâ”€ Redis read (case): ~50ms
  â”œâ”€ Redis read (suspects x3): ~100ms
  â””â”€ Data transformation: ~50ms

GET /api/suspect-image/:id: ~50ms
  â””â”€ Redis read: ~50ms
  â””â”€ Base64 already stored

POST /api/chat/:suspectId: ~2-4ì´ˆ
  â”œâ”€ Gemini Chat API: ~2-3ì´ˆ
  â”œâ”€ AP Analysis: ~100ms
  â””â”€ Redis write: ~50ms

POST /api/location/search: ~100ms
  â”œâ”€ Redis read/write: ~50ms
  â””â”€ Probability calculation: ~50ms

POST /api/submit: ~3-5ì´ˆ
  â”œâ”€ Gemini Scoring API: ~3-4ì´ˆ
  â”œâ”€ Leaderboard update: ~100ms
  â””â”€ Redis writes: ~50ms
```

### í”„ë¡ íŠ¸ì—”ë“œ ë¡œë”©

```
Initial Load: ~1ì´ˆ
  â”œâ”€ React App bundle: ~500ms
  â”œâ”€ GET /api/case/today: ~200ms
  â””â”€ Render: ~300ms

Investigation Screen: +2ì´ˆ (progressive)
  â”œâ”€ Initial render: ~100ms
  â””â”€ 3x GET /api/suspect-image: ~150ms (parallel)
      â””â”€ ì´ë¯¸ì§€ í‘œì‹œ: staggered (50ms ê°„ê²©)
```

---

## ë°°í¬ ë° í…ŒìŠ¤íŠ¸

### ë¡œì»¬ ê°œë°œ

```bash
# 1. ì˜ì¡´ì„± ì„¤ì¹˜
npm install

# 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
cp .env.example .env
# GEMINI_API_KEY, VERCEL_IMAGE_FUNCTION_URL ì„¤ì •

# 3. ë¹Œë“œ
npm run build

# 4. Devvit Playtest
devvit playtest
```

### Devvit ë°°í¬

```bash
# 1. Devvit ë¡œê·¸ì¸
devvit login

# 2. ì•± ì—…ë¡œë“œ
devvit upload

# 3. ì„œë¸Œë ˆë”§ì— ì„¤ì¹˜
# Reddit â†’ Mod Tools â†’ Installed Apps â†’ Install

# 4. Scheduler í™œì„±í™” í™•ì¸
# Devvit Dashboard â†’ Schedulers â†’ daily-case-generator
```

### ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### âœ… Case Generation

- [ ] DailyCaseSchedulerê°€ ë§¤ì¼ 00:00 UTCì— ì‹¤í–‰ë¨
- [ ] ì¼€ì´ìŠ¤ ìŠ¤í† ë¦¬ê°€ Geminië¡œ ìƒì„±ë¨
- [ ] ì¼€ì´ìŠ¤ ì´ë¯¸ì§€ê°€ ìƒì„±ë¨ (includeImage: true)
- [ ] í”„ë¡œí•„ ì´ë¯¸ì§€ 3ê°œê°€ ìƒì„±ë¨ (includeSuspectImages: true)
- [ ] Sharp ì••ì¶•ìœ¼ë¡œ ê° ì´ë¯¸ì§€ ~16KB
- [ ] Redisì— case, suspect x3 ì €ì¥ë¨

#### âœ… Reddit Post

- [ ] Custom Postê°€ r/armchair_sleuths_devì— ìƒì„±ë¨
- [ ] í¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ React App ë¡œë“œë¨

#### âœ… Game Play

- [ ] Loading â†’ Intro (cinematic) â†’ Case Overview ì „í™˜
- [ ] í”„ë¡œí•„ ì´ë¯¸ì§€ progressive loading ì‘ë™
- [ ] AP ì´ˆê¸°ê°’ 3 ì„¤ì •ë¨
- [ ] Interrogationì—ì„œ AP íšë“ ì‘ë™ (Topic ê°ì§€)
- [ ] Location Searchì—ì„œ AP ì†Œë¹„ ì‘ë™
- [ ] Emergency AP 1íšŒ ì œê³µ ì‘ë™
- [ ] ì¦ê±° ë°œê²¬ í™•ë¥  ì‹œìŠ¤í…œ ì‘ë™

#### âœ… Submission

- [ ] ë‹µì•ˆ ì œì¶œ ì„±ê³µ
- [ ] Gemini Scoring API ì‘ë™
- [ ] ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸
- [ ] AP Integrity Check ì‘ë™

---

## ë¬¸ì„œ íˆìŠ¤í† ë¦¬

**v1.0** (2025-01-15)
- ì´ˆê¸° ë²„ì „
- 5ê°œ í™”ë©´ ë¬¸ì„œí™”
- ì´ë¯¸ì§€ ë²„ê·¸ 3ê±´ ê¸°ë¡

**v2.0** (2025-10-21)
- ì™„ì „í•œ ì¬ì‘ì„±
- 6ê°œ í™”ë©´ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (Cinematic Intro ì¶”ê°€)
- Evidence Discovery System ì¶”ê°€
- Action Points System Phase 2 & 3 ì¶”ê°€
- 2-stage image loading ì„¤ëª…
- 20+ API ì—”ë“œí¬ì¸íŠ¸ ì „ì²´ ë¬¸ì„œí™”
- ëª¨ë“  êµ¬ë²„ì „ ë²„ê·¸ ì œê±° (í•´ê²°ë¨)
- í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì¶”ê°€
- Redis ë°ì´í„° êµ¬ì¡° ìƒì„¸í™”
- ë°ì´í„° íë¦„ ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€

---

**ë¬¸ì„œ ì‘ì„±**: Claude Code (Sonnet 4.5)
**í”„ë¡œì íŠ¸**: Armchair Sleuths (Reddit Devvit)
**Last Updated**: 2025-10-21
