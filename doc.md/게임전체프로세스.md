──────────────────────────────────────────────────────────────────────────────────╮ │
│ │ Devvit 게임 전체 프로세스 분석 (이미지 포함)                                     │ │
│ │                                                                                  │ │
│ │ 📋 완전한 End-to-End 흐름                                                        │ │
│ │                                                                                  │ │
│ │ 1️⃣ 케이스 생성 (Backend - Daily Scheduler                                       │ │
│ │                                                                                  │ │
│ │ 트리거: DailyCaseScheduler.ts - 매일 자정 UTC 실행                               │ │
│ │                                                                                  │ │
│ │ DailyCaseScheduler (매일 00:00 UTC)                                              │ │
│ │   ↓                                                                              │ │
│ │ createGeminiClient()                                                             │ │
│ │   ↓                                                                              │ │
│ │ createCaseGeneratorService()                                                     │ │
│ │   ↓                                                                              │ │
│ │ caseGenerator.generateCase({                                                     │ │
│ │   date: new Date(),                                                              │ │
│ │   includeImage: true,          // ✅ 케이스 이미지                                │ │
│ │   includeSuspectImages: ???    // ❌ BUG #2: 누락됨!                              │ │
│ │ })                                                                               │ │
│ │   ↓                                                                              │ │
│ │ CaseGeneratorService.generateCase()                                              │ │
│ │   ├─ CaseElementLibrary.getTodaysCaseElements()                                  │ │
│ │   ├─ generateCaseStory() → Gemini Text API                                       │ │
│ │   ├─ generateCaseImage() → Gemini Image API (if includeImage)                    │ │
│ │   ├─ generateSuspectProfileImages() → 3x Gemini Image API (if                    │ │
│ │ includeSuspectImages)                                                            │ │
│ │   │   └─ Promise.all([...]) - 병렬 처리                                          │ │
│ │   │       └─ Vercel Function (api/generate-image.ts)                             │ │
│ │   │           └─ Sharp 압축 (1.5MB → 16KB JPEG)                                  │ │
│ │   └─ CaseRepository.createCase()                                                 │ │
│ │       ├─ KVStoreManager.saveCase() → Redis: case:case-2025-10-18                 │ │
│ │       └─ KVStoreManager.saveSuspect() x3 → Redis:                                │ │
│ │ suspect:case-2025-10-18-suspect-{1,2,3}                                          │ │
│ │           └─ profileImageUrl 포함 (Base64 JPEG data URL)                         │ │
│ │                                                                                  │ │
│ │ 2️⃣ Reddit 포스트 생성 (Devvit Platform                                          │ │
│ │                                                                                  │ │
│ │ 트리거: 앱 설치 또는 메뉴 액션                                                   │ │
│ │                                                                                  │ │
│ │ reddit.submitCustomPost()                                                        │ │
│ │   ├─ splash 화면 설정                                                            │ │
│ │   ├─ postData: { gameState, score }                                              │ │
│ │   └─ subredditName: r/armchair_sleuths_dev                                       │ │
│ │       ↓                                                                          │ │
│ │ Reddit 포스트 생성 완료                                                          │ │
│ │   └─ 포스트 ID 반환                                                              │ │
│ │                                                                                  │ │
│ │ 3️⃣ 게임 UI 로드 (Client - React App                                             │ │
│ │                                                                                  │ │
│ │ 시작점: 사용자가 Reddit 포스트 클릭                                              │ │
│ │                                                                                  │ │
│ │ client/main.tsx → App.tsx 렌더링                                                 │ │
│ │   ↓                                                                              │ │
│ │ useCase() Hook 실행                                                              │ │
│ │   ↓                                                                              │ │
│ │ fetch('/api/case/today')                                                         │ │
│ │   ↓                                                                              │ │
│ │ server/index.ts:196 - GET /api/case/today                                        │ │
│ │   ├─ CaseRepository.getTodaysCase()                                              │ │
│ │   │   └─ KVStoreManager.getCaseByDate(today)                                     │ │
│ │   │       └─ Redis: case:date:2025-10-18 → case-2025-10-18                       │ │
│ │   ├─ CaseRepository.getCaseSuspects(caseId)                                      │ │
│ │   │   └─ KVStoreManager.getCaseSuspects()                                        │ │
│ │   │       ├─ Redis: case:case-2025-10-18:suspects → [suspect-1, suspect-2,       │ │
│ │ suspect-3]                                                                       │ │
│ │   │       └─ Redis: suspect:case-2025-10-18-suspect-{1,2,3}                      │ │
│ │   │           └─ profileImageUrl 포함 (Base64 JPEG)                              │ │
│ │   └─ Response 생성:                                                              │ │
│ │       ❌ BUG #1: profileImageUrl이 응답에서 제외됨!                               │ │
│ │                                                                                  │ │
│ │       현재 코드 (index.ts:232-240):                                              │ │
│ │       ```typescript                                                              │ │
│ │       const suspectsData = fullSuspects.map(s => ({                              │ │
│ │         id: s.id,                                                                │ │
│ │         caseId: s.caseId,                                                        │ │
│ │         name: s.name,                                                            │ │
│ │         archetype: s.archetype,                                                  │ │
│ │         background: s.background,                                                │ │
│ │         personality: s.personality,                                              │ │
│ │         emotionalState: s.emotionalState                                         │ │
│ │         // ❌ profileImageUrl 누락!                                               │ │
│ │       }));                                                                       │ │
│ │       ```                                                                        │ │
│ │                                                                                  │ │
│ │ 4️⃣ 게임 플레이 (Reddit 페이지                                                   │ │
│ │                                                                                  │ │
│ │ App.tsx 화면 전환                                                                │ │
│ │   ↓                                                                              │ │
│ │ 1. Loading → Case Overview → Investigation                                       │ │
│ │   ↓                                                                              │ │
│ │ 2. SuspectPanel.tsx 렌더링                                                       │ │
│ │    ├─ suspects.map() 반복                                                        │ │
│ │    └─ 각 용의자 카드:                                                            │ │
│ │        ├─ {suspect.profileImageUrl && <img src={...} />}  // ✅ UI 준비됨         │ │
│ │        └─ {!suspect.profileImageUrl && <👤 placeholder>}  // ❌ 현재 항상 이것    │ │
│ │   ↓                                                                              │ │
│ │ 3. ChatInterface.tsx - AI 용의자와 대화                                          │ │
│ │    └─ POST /api/chat/:suspectId                                                  │ │
│ │   ↓                                                                              │ │
│ │ 4. SubmissionForm.tsx - 답안 제출                                                │ │
│ │    └─ POST /api/submit                                                           │ │
│ │   ↓                                                                              │ │
│ │ 5. ResultView.tsx - 결과 확인                                                    │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ 🐛 발견된 Critical Bugs                                                          │ │
│ │                                                                                  │ │
│ │ Bug #1: API 응답에 profileImageUrl 누락 ⚠️ CRITICAL                              │ │
│ │                                                                                  │ │
│ │ 위치: src/server/index.ts:232-240                                                │ │
│ │                                                                                  │ │
│ │ 문제:                                                                            │ │
│ │ - KVStore에는 profileImageUrl이 저장되어 있음                                    │ │
│ │ - getCaseSuspects()로 가져올 때도 포함됨                                         │ │
│ │ - 하지만 클라이언트에게 보내는 응답에서 제외됨                                   │ │
│ │                                                                                  │ │
│ │ 영향:                                                                            │ │
│ │ - 이미지가 생성되고 저장되어도 클라이언트가 받을 수 없음                         │ │
│ │ - SuspectPanel에서 항상 placeholder 표시                                         │ │
│ │                                                                                  │ │
│ │ 수정 필요:                                                                       │ │
│ │ // src/server/index.ts:232-240                                                   │ │
│ │ const suspectsData = fullSuspects.map(s => ({                                    │ │
│ │   id: s.id,                                                                      │ │
│ │   caseId: s.caseId,                                                              │ │
│ │   name: s.name,                                                                  │ │
│ │   archetype: s.archetype,                                                        │ │
│ │   background: s.background,                                                      │ │
│ │   personality: s.personality,                                                    │ │
│ │   emotionalState: s.emotionalState,                                              │ │
│ │   profileImageUrl: s.profileImageUrl  // ← 추가 필요!                            │ │
│ │ }));                                                                             │ │
│ │                                                                                  │ │
│ │ Bug #2: DailyCaseScheduler에 includeSuspectImages 누락 ⚠️ HIGH                   │ │
│ │                                                                                  │ │
│ │ 위치: src/server/schedulers/DailyCaseScheduler.ts:42-45                          │ │
│ │                                                                                  │ │
│ │ 문제:                                                                            │ │
│ │ - includeImage: true만 설정됨                                                    │ │
│ │ - includeSuspectImages 파라미터가 없음                                           │ │
│ │ - 프로필 이미지가 생성되지 않음                                                  │ │
│ │                                                                                  │ │
│ │ 수정 필요:                                                                       │ │
│ │ // src/server/schedulers/DailyCaseScheduler.ts:42-45                             │ │
│ │ const newCase = await caseGenerator.generateCase({                               │ │
│ │   date: new Date(),                                                              │ │
│ │   includeImage: true,                                                            │ │
│ │   includeSuspectImages: true  // ← 추가 필요!                                    │ │
│ │ });                                                                              │ │
│ │                                                                                  │ │
│ │ Bug #3: 수동 케이스 생성에도 includeSuspectImages 누락 ⚠️ MEDIUM                 │ │
│ │                                                                                  │ │
│ │ 위치:                                                                            │ │
│ │ - src/server/schedulers/DailyCaseScheduler.ts:92-95 (manual-case-generation)     │ │
│ │ - src/server/index.ts:164-167 (POST /api/case/generate)                          │ │
│ │                                                                                  │ │
│ │ 문제:                                                                            │ │
│ │ - 테스트/개발용 수동 생성에서도 프로필 이미지 생성 안 됨                         │ │
│ │                                                                                  │ │
│ │ 수정 필요:                                                                       │ │
│ │ // DailyCaseScheduler.ts:92-95                                                   │ │
│ │ const newCase = await caseGenerator.generateCase({                               │ │
│ │   date: new Date(),                                                              │ │
│ │   includeImage: false,                                                           │ │
│ │   includeSuspectImages: true  // ← 추가!                                         │ │
│ │ });                                                                              │ │
│ │                                                                                  │ │
│ │ // index.ts:164-167                                                              │ │
│ │ const caseData = await caseGenerator.generateCase({                              │ │
│ │   date: new Date(),                                                              │ │
│ │   includeImage: false,                                                           │ │
│ │   includeSuspectImages: true  // ← 추가!                                         │ │
│ │ });                                                                              │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ 🧪 Devvit 환경 테스트 프로세스                                                   │ │
│ │                                                                                  │ │
│ │ Phase 1: 로컬 수정 및 빌드                                                       │ │
│ │                                                                                  │ │
│ │ 1. Bug #1 수정 → src/server/index.ts                                             │ │
│ │ 2. Bug #2 수정 → src/server/schedulers/DailyCaseScheduler.ts                     │ │
│ │ 3. Bug #3 수정 → src/server/index.ts, DailyCaseScheduler.ts                      │ │
│ │ 4. 빌드: npm run build                                                           │ │
│ │                                                                                  │ │
│ │ Phase 2: Devvit 배포                                                             │ │
│ │                                                                                  │ │
│ │ # 1. Devvit 로그인 (필요시)                                                      │ │
│ │ devvit login                                                                     │ │
│ │                                                                                  │ │
│ │ # 2. Devvit 앱 업로드                                                            │ │
│ │ devvit upload                                                                    │ │
│ │                                                                                  │ │
│ │ # 3. Playtest 시작                                                               │ │
│ │ devvit playtest                                                                  │ │
│ │                                                                                  │ │
│ │ Phase 3: Reddit에서 테스트                                                       │ │
│ │                                                                                  │ │
│ │ 3.1 케이스 생성 테스트                                                           │ │
│ │                                                                                  │ │
│ │ 옵션 A: 자동 스케줄러 대기                                                       │ │
│ │ - 자정 UTC까지 대기                                                              │ │
│ │ - 또는 스케줄러 수동 트리거 (Devvit 대시보드)                                    │ │
│ │                                                                                  │ │
│ │ 옵션 B: 수동 생성 (추천)                                                         │ │
│ │ # Reddit 포스트에서 메뉴 액션 클릭                                               │ │
│ │ # 또는 API 직접 호출                                                             │ │
│ │ curl -X POST https://your-devvit-app.reddit.dev/api/case/generate                │ │
│ │                                                                                  │ │
│ │ 3.2 게임 포스트 생성                                                             │ │
│ │                                                                                  │ │
│ │ # Devvit 대시보드에서 "Create Post" 메뉴 실행                                    │ │
│ │ # 또는                                                                           │ │
│ │ curl -X POST https://your-devvit-app.reddit.dev/internal/menu/post-create        │ │
│ │                                                                                  │ │
│ │ 3.3 Reddit에서 게임 플레이                                                       │ │
│ │                                                                                  │ │
│ │ 1. r/armchair_sleuths_dev 서브레딧 방문                                          │ │
│ │ 2. 생성된 게임 포스트 클릭                                                       │ │
│ │ 3. "Tap to Start" 버튼 클릭                                                      │ │
│ │ 4. Investigation 화면에서 용의자 카드 확인:                                      │ │
│ │   - ✅ 프로필 이미지 표시되는지 확인                                              │ │
│ │   - 이미지 크기: ~16KB (압축된 JPEG)                                             │ │
│ │   - 로딩 시간: 즉시 (Base64 inline)                                              │ │
│ │                                                                                  │ │
│ │ Phase 4: 검증 체크리스트                                                         │ │
│ │                                                                                  │ │
│ │ Storage 검증 (Devvit Console)                                                    │ │
│ │                                                                                  │ │
│ │ # Redis 키 확인                                                                  │ │
│ │ case:date:2025-10-18                                                             │ │
│ │ case:case-2025-10-18                                                             │ │
│ │ suspect:case-2025-10-18-suspect-1                                                │ │
│ │ suspect:case-2025-10-18-suspect-2                                                │ │
│ │ suspect:case-2025-10-18-suspect-3                                                │ │
│ │                                                                                  │ │
│ │ # Suspect 데이터 확인                                                            │ │
│ │ # profileImageUrl이 "data:image/jpeg;base64,..." 형식인지 확인                   │ │
│ │                                                                                  │ │
│ │ API 응답 검증 (Browser DevTools)                                                 │ │
│ │                                                                                  │ │
│ │ // Network 탭에서 /api/case/today 확인                                           │ │
│ │ // Response JSON:                                                                │ │
│ │ {                                                                                │ │
│ │   "suspects": [                                                                  │ │
│ │     {                                                                            │ │
│ │       "id": "...",                                                               │ │
│ │       "name": "이서연",                                                          │ │
│ │       "profileImageUrl": "data:image/jpeg;base64,/9j/2wBD..."  // ← 있어야 함!   │ │
│ │     }                                                                            │ │
│ │   ]                                                                              │ │
│ │ }                                                                                │ │
│ │                                                                                  │ │
│ │ UI 렌더링 검증 (Reddit 페이지)                                                   │ │
│ │                                                                                  │ │
│ │ 1. 용의자 카드에 프로필 이미지 표시됨                                            │ │
│ │ 2. 이미지가 원형(rounded-full)으로 표시됨                                        │ │
│ │ 3. Placeholder(👤)가 아닌 실제 사진                                              │ │
│ │ 4. 3명 모두 이미지 있음 (성공률 100% 목표)                                       │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ 📝 수정 요약                                                                     │ │
│ │                                                                                  │ │
│ │ 필수 수정 파일 (3개)                                                             │ │
│ │                                                                                  │ │
│ │ 1. src/server/index.ts                                                           │ │
│ │   - Line 232-240: profileImageUrl: s.profileImageUrl 추가                        │ │
│ │   - Line 164-167: includeSuspectImages: true 추가                                │ │
│ │ 2. src/server/schedulers/DailyCaseScheduler.ts                                   │ │
│ │   - Line 44: includeSuspectImages: true 추가                                     │ │
│ │   - Line 94: includeSuspectImages: true 추가                                     │ │
│ │                                                                                  │ │
│ │ 배포 프로세스                                                                    │ │
│ │                                                                                  │ │
│ │ 1. npm run build                                                                 │ │
│ │ 2. devvit upload                                                                 │ │
│ │ 3. devvit playtest (또는 실제 배포)                                              │ │
│ │ 4. Reddit에서 테스트                                                             │ │
│ │                                                                                  │ │
│ │ 예상 결과                                                                        │ │
│ │                                                                                  │ │
│ │ ✅ 성공 시:                                                                       │ │
│ │ - 케이스 생성: ~14초 (텍스트 + 이미지 3개)                                       │ │
│ │ - 총 크기: ~48KB (압축된 JPEG 3개)                                               │ │
│ │ - Reddit 로딩: 즉시 (Base64 inline)                                              │ │
│ │ - UI: 프로필 이미지 3개 모두 표시                                                │ │
│ │                                                                                  │ │
│ │ ❌ 실패 시 디버깅:                                                                │ │
│ │ - Devvit 콘솔 로그 확인                                                          │ │
│ │ - Redis 데이터 직접 조회                                                         │ │
│ │ - Browser Network 탭에서 API 응답 확인                                           │ │
│ │ - Sharp 압축 에러 로그 확인 (Vercel Function)    