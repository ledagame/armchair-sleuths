# Reddit Detective Agency - 최종 아키텍처 (해커톤 전쟁 모드)

**작성일**: 2025-01-15
**상태**: 🔥 **전쟁 모드 활성화 - 즉시 구현 시작**
**남은 기간**: 16일
**철학**: **작동하는 것 > 최적화된 것**

---

## 🔥 해커톤 전쟁 모드

### 핵심 원칙

> **"이건 해커톤이다. 전쟁이다. Over-engineering은 적이다."**

#### 1. **MVP First, Everything Else Later**
- Phase 1: 작동만 하면 OK → 캐싱 없음, 복잡한 최적화 없음
- Phase 2: 시간 남으면 개선 → 간단한 Redis 캐싱
- Phase 3: 완전히 여유있으면 → Vector 캐싱

#### 2. **필요한 것만 설치**
```bash
# 필요한 것 (2개!)
✅ Gemini API 키
✅ Vercel 계정

# 필요 없는 것
❌ OpenAI API 키 (Gemini로 다 해결)
❌ Upstash Vector (나중에!)
```

#### 3. **16일 = 96시간 = 매초가 귀하다**
- 계획은 이미 충분함
- 더 이상 계획하지 말고 **지금 코딩 시작**
- 구현하면서 배우는 게 더 빠름

---

## 🎯 프로젝트 개요

### 해커톤 정보
- **대회**: Reddit Games and Puzzles Hackathon
- **상금**: $45,000
- **마감**: 16일 후
- **플랫폼**: Devvit (Reddit Developer Platform)

### 핵심 기능
1. **AI 기반 머더미스터리 자동 생성**: 매일 새로운 사건이 자동으로 생성됨
2. **실제 플레이 가능**: 3명의 AI 용의자와 대화하며 추리

### MVP 전략
- **Strategy A**: 메인 케이스만 (미니 케이스 제외)
- **이미지 생성**: Phase 1 필수 포함 (캐싱 없이!)
- **Spirit of Kiro 패턴**: word-lists, emotional states 적용 (간단한 것만)

---

## ✅ 검증 완료된 기술 스택 (단순화)

### 1. AI 모델 - Gemini API만 사용!

#### 텍스트 LLM: `gemini-flash-lite-latest`
- **용도**: 모든 텍스트 생성 (케이스, AI 용의자 대화, 채점, **임베딩**)
- **가격**: $0.10/1M input, $0.40/1M output
- **속도**: 887 tokens/s (매우 빠름)

```typescript
// API 엔드포인트
const GEMINI_TEXT_API = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-lite-latest:generateContent';

// 임베딩 API (Phase 2-3에서 사용)
const GEMINI_EMBEDDING_API = 'https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent';
```

#### 이미지 생성: `gemini-2.5-flash-image`
- **용도**: 사건 현장 이미지 생성
- **가격**: $0.039/이미지
- **Phase 1**: 캐싱 없이 직접 생성 ($1.17/월 - OK!)

```typescript
const GEMINI_IMAGE_API = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent';
```

### 2. 인프라

#### Devvit (Reddit Developer Platform)
- **Client**: React 기반 UI
- **Server**: 비즈니스 로직 + Scheduler API + Redis KV
- **제약**: 1초 실행 제한 → Scheduler로 해결

#### Vercel Function (초간단 버전)
```typescript
// Phase 1: 캐싱 없음 - 30분이면 구현 완료!
export default async function handler(req, res) {
  const { prompt } = req.body;

  // Gemini로 이미지 생성 (캐싱 없음)
  const response = await fetch(
    'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent',
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-goog-api-key': process.env.GEMINI_API_KEY!
      },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    }
  );

  const data = await response.json();
  const imageUrl = `data:image/png;base64,${data.candidates[0].content.parts[0].inlineData.data}`;

  return res.json({ imageUrl });
}
```

### 3. Spirit of Kiro 패턴 (단순화)

#### ✅ CaseElementLibrary (필수 - Phase 1)
- **목적**: 일관된 콘텐츠 품질
- **구현**: 순수 JavaScript, Date seed 기반

```typescript
export const CaseElementLibrary = {
  weapons: ['독극물', '둔기', '날카로운 흉기', '총기', '질식', '추락'],
  motives: [
    { category: '금전', keywords: ['유산', '보험금', '빚'] },
    { category: '복수', keywords: ['배신', '원한', '모욕'] },
  ],
  locations: [
    { name: '밀실 서재', props: ['책장', '금고', '비밀 통로'] },
    { name: '저택 정원', props: ['분수', '동상', '장미 덤불'] },
  ]
};
```

#### ✅ Emotional State System (필수 - Phase 1)
- **목적**: 동적 AI 용의자 행동
- **구현**: Devvit Redis KV

```typescript
interface SuspectEmotionalState {
  suspicionLevel: number; // 0-100
  tone: 'cooperative' | 'nervous' | 'defensive' | 'aggressive';
}
```

#### 🟡 이미지 캐싱 (선택 - Phase 2-3)
- **Phase 1**: 캐싱 없음 ($1.17/월 - 16일이면 $0.62, OK!)
- **Phase 2**: Devvit Redis 캐싱 (시간 남으면)
- **Phase 3**: Upstash Vector 캐싱 (완전히 여유있으면)

---

## 🏗️ 최종 아키텍처 (3-Tier)

```
┌────────────────────────────────────────────────────────────┐
│                  CLIENT LAYER (React)                       │
│  - CaseOverview, SuspectPanel, ChatInterface               │
└────────────────────────────────────────────────────────────┘
                          ↓
                    fetch('/api/...')
                          ↓
┌────────────────────────────────────────────────────────────┐
│           DEVVIT SERVER (Business Logic)                    │
│  - CaseGeneratorService (Gemini 텍스트)                    │
│  - SuspectAIService (Gemini 텍스트)                        │
│  - ScoringEngine (Gemini 텍스트)                           │
│  - Redis KV (데이터 저장)                                  │
│  - Scheduler API (백그라운드 작업)                         │
└────────────────────────────────────────────────────────────┘
                          ↓
                fetch(Gemini API / Vercel)
                          ↓
┌────────────────────────────────────────────────────────────┐
│                    EXTERNAL SERVICES                        │
│  • Gemini API                                               │
│    - gemini-flash-lite-latest (모든 텍스트)               │
│    - gemini-2.5-flash-image (이미지)                      │
│                                                             │
│  • Vercel Function                                          │
│    - Phase 1: 이미지 생성 (캐싱 없음)                     │
│    - Phase 2: + Redis 캐싱 (선택)                         │
│    - Phase 3: + Vector 캐싱 (선택)                        │
└────────────────────────────────────────────────────────────┘
```

---

## 📁 디렉토리 구조 (단순화)

### 🔴 P0 (필수 - Week 1)
```
src/server/services/
├── case/
│   ├── CaseElementLibrary.ts        # ⭐ word-lists
│   └── CaseGeneratorService.ts      # ⭐ Gemini 케이스 생성
├── suspect/
│   ├── SuspectAIService.ts          # ⭐ AI 용의자
│   └── EmotionalStateManager.ts     # ⭐ 감정 상태
├── scoring/
│   ├── ScoringEngine.ts             # ⭐ 채점
│   └── W4HValidator.ts              # ⭐ 5W1H 검증
├── gemini/
│   └── GeminiClient.ts              # ⭐ Gemini API 클라이언트
└── repositories/kv/
    ├── KVStoreManager.ts            # ⭐ Redis 추상화
    └── CaseRepository.ts

src/server/schedulers/
└── DailyCaseScheduler.ts            # ⭐ 매일 사건 생성

src/server/triggers/
└── CommentSubmitTrigger.ts          # ⭐ 댓글 처리

src/client/components/
├── case/
│   ├── CaseOverview.tsx             # ⭐ 사건 개요
│   └── CaseImage.tsx                # ⭐ 사건 이미지
├── suspect/
│   ├── SuspectPanel.tsx             # ⭐ 용의자 패널
│   └── SuspectCard.tsx
└── chat/
    ├── ChatInterface.tsx            # ⭐ AI 대화
    └── MessageList.tsx

vercel/api/
└── generate-image.ts                # ⭐ 이미지 생성 (캐싱 없음)
```

---

## 💻 핵심 코드 (단순화)

### 1. Vercel Function (Phase 1 - 초간단!)

```typescript
// vercel/api/generate-image.ts
// 30분이면 완성!

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { prompt } = req.body;

  try {
    // Gemini로 이미지 생성 (캐싱 없음)
    const response = await fetch(
      'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent',
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-goog-api-key': process.env.GEMINI_API_KEY!
        },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      }
    );

    if (!response.ok) {
      throw new Error(`Gemini API error: ${response.status}`);
    }

    const data = await response.json();
    const base64Image = data.candidates[0].content.parts[0].inlineData.data;
    const imageUrl = `data:image/png;base64,${base64Image}`;

    console.log('✅ Image generated:', imageUrl.substring(0, 50));

    return res.json({ imageUrl });

  } catch (error) {
    console.error('Image generation error:', error);
    return res.status(500).json({ error: 'Image generation failed' });
  }
}
```

### 2. GeminiClient.ts (모든 기능!)

```typescript
// src/server/services/gemini/GeminiClient.ts

export class GeminiClient {
  private readonly TEXT_MODEL = 'gemini-flash-lite-latest';
  private readonly IMAGE_MODEL = 'gemini-2.5-flash-image';
  private readonly EMBEDDING_MODEL = 'text-embedding-004';
  private readonly BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
  private readonly apiKey: string;

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  /**
   * 텍스트 생성 (케이스, AI 용의자 대화, 채점)
   */
  async generateText(prompt: string): Promise<string> {
    const response = await fetch(
      `${this.BASE_URL}/${this.TEXT_MODEL}:generateContent`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-goog-api-key': this.apiKey
        },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      }
    );

    if (!response.ok) {
      throw new Error(`Gemini API error: ${response.status}`);
    }

    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
  }

  /**
   * 이미지 생성 (Vercel Function으로 위임)
   */
  async generateImage(prompt: string): Promise<string> {
    const response = await fetch('https://your-vercel-function.vercel.app/api/generate-image', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });

    const data = await response.json();
    return data.imageUrl;
  }

  /**
   * 임베딩 생성 (Phase 2-3에서 캐싱 용도)
   */
  async generateEmbedding(text: string): Promise<number[]> {
    const response = await fetch(
      `${this.BASE_URL}/${this.EMBEDDING_MODEL}:embedContent`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-goog-api-key': this.apiKey
        },
        body: JSON.stringify({
          model: `models/${this.EMBEDDING_MODEL}`,
          content: { parts: [{ text }] }
        })
      }
    );

    const data = await response.json();
    return data.embedding.values;
  }
}
```

---

## 📅 16일 구현 로드맵 (단순화)

### Week 1 (Day 1-7): 🔴 MVP 완성

#### Day 1: 환경 설정 (2-3시간)
```bash
# 필요한 것만!
✅ npm install -g devvit
✅ devvit login
✅ devvit new armchair-sleuths
✅ Gemini API 키 발급
✅ Vercel 계정 생성
✅ .env 파일 생성 (GEMINI_API_KEY만!)

# 필요 없는 것
❌ OpenAI
❌ Upstash
```

#### Day 2: 데이터 레이어 (6시간)
- [ ] CaseElementLibrary.ts
- [ ] KVStoreManager.ts (Redis)
- [ ] CaseRepository.ts
- [ ] 유닛 테스트

#### Day 3: Gemini + 케이스 생성 (6시간)
- [ ] GeminiClient.ts
- [ ] CaseGeneratorService.ts
- [ ] DailyCaseScheduler.ts
- [ ] 케이스 3개 생성 테스트

#### Day 4: 이미지 생성 (6시간)
- [ ] Vercel Function (캐싱 없음 - 30분!)
- [ ] ImageGeneratorService.ts
- [ ] 이미지 5개 생성 테스트
- **캐싱은 나중에!**

#### Day 5: AI 용의자 (6시간)
- [ ] EmotionalStateManager.ts
- [ ] SuspectAIService.ts
- [ ] AIResponseProcessor.ts
- [ ] 용의자 3명과 대화 테스트

#### Day 6: 채점 시스템 (6시간)
- [ ] W4HValidator.ts
- [ ] ScoringEngine.ts
- [ ] CommentSubmitTrigger.ts
- [ ] 답변 10개 채점 테스트

#### Day 7: 클라이언트 UI (6시간)
- [ ] CaseOverview.tsx
- [ ] SuspectPanel.tsx
- [ ] ChatInterface.tsx
- [ ] 전체 플로우 통합 테스트

**Week 1 체크포인트**: 작동하는 MVP ✅

---

### Week 2 (Day 8-14): 🟡 개선 및 안정화

#### Day 8-9: 리더보드 + 제출 UI
- [ ] LeaderboardService.ts
- [ ] SubmissionForm.tsx
- [ ] ResultModal.tsx

#### Day 10-11: 버그 수정 + 테스트
- [ ] End-to-End 테스트
- [ ] 버그 수정
- [ ] 에러 처리 강화

#### Day 12-14: UX 개선
- [ ] 로딩 상태
- [ ] 에러 메시지
- [ ] 모바일 최적화

**선택 (시간 남으면)**:
- [ ] Phase 2: Redis 이미지 캐싱 (1-2시간)

---

### Week 3 (Day 15-16): 🚀 배포

#### Day 15: 최종 테스트
- [ ] QA
- [ ] 프로덕션 테스트
- [ ] 문서화

#### Day 16: 배포 및 제출
- [ ] Devvit 배포
- [ ] Vercel 배포
- [ ] 해커톤 제출 🎉

---

## 🎯 3단계 이미지 캐싱 전략

### Phase 1: 캐싱 없음 (Day 1-7)
**지금 바로 이걸로 시작!**

```typescript
// 30분이면 완성
export default async function handler(req, res) {
  const imageUrl = await generateImageWithGemini(req.body.prompt);
  return res.json({ imageUrl });
}
```

**비용**: $1.17/30일 = **16일이면 $0.62** ← 완전히 OK!
**장점**: 구현 30분, 버그 제로, 바로 다음 기능 개발 가능
**단점**: 없음 (해커톤 기간 동안은)

---

### Phase 2: Redis 캐싱 (Day 8-12, 선택)
**시간 남으면 추가**

```typescript
// Vercel Function에 Redis 추가
export default async function handler(req, res) {
  const { prompt } = req.body;

  // 1. Redis에서 확인 (정확히 같은 프롬프트만)
  const cached = await redis.get(`image:${prompt}`);
  if (cached) return res.json({ imageUrl: cached, cached: true });

  // 2. 새 이미지 생성
  const imageUrl = await generateImageWithGemini(prompt);

  // 3. Redis에 저장 (24시간)
  await redis.set(`image:${prompt}`, imageUrl, 86400);

  return res.json({ imageUrl, cached: false });
}
```

**구현 시간**: 1-2시간
**비용 절감**: 65% (정확히 같은 프롬프트만 캐시)
**복잡도**: ⭐⭐ 낮음

---

### Phase 3: Vector 캐싱 (Day 13-14, 선택)
**완전히 여유있으면**

```typescript
// Gemini embedding + Upstash Vector
export default async function handler(req, res) {
  const { prompt } = req.body;

  // 1. Gemini embedding 생성
  const embedding = await generateEmbeddingWithGemini(prompt);

  // 2. Vector 유사도 검색
  const similar = await vectorIndex.query({ vector: embedding });
  if (similar[0]?.score > 0.95) {
    return res.json({ imageUrl: similar[0].metadata.imageUrl });
  }

  // 3. 새 이미지 생성 + 저장
  const imageUrl = await generateImageWithGemini(prompt);
  await vectorIndex.upsert([{ vector: embedding, metadata: { imageUrl } }]);

  return res.json({ imageUrl });
}
```

**구현 시간**: 2-3시간 + Upstash 설정
**비용 절감**: 90% (유사한 프롬프트도 캐시)
**복잡도**: ⭐⭐⭐⭐ 높음

---

## ✅ 수정된 체크리스트

### 환경 설정 (Day 1)
- [ ] Devvit CLI 설치
- [ ] Gemini API 키 발급 ⭐ **이것만!**
- [ ] Vercel 계정 생성
- [ ] .env 파일 생성
- [ ] Redis KV 연결 테스트

### Phase 1 필수 (Day 1-7)
- [ ] CaseElementLibrary.ts
- [ ] CaseGeneratorService.ts
- [ ] GeminiClient.ts (텍스트 + 이미지)
- [ ] EmotionalStateManager.ts
- [ ] SuspectAIService.ts
- [ ] ScoringEngine.ts
- [ ] DailyCaseScheduler.ts
- [ ] Vercel Function (캐싱 없음)
- [ ] 클라이언트 UI (기본)

### Phase 2 선택 (Day 8-14)
- [ ] LeaderboardService.ts
- [ ] SubmissionForm.tsx
- [ ] Redis 이미지 캐싱 (선택)
- [ ] 버그 수정
- [ ] UX 개선

### Phase 3 선택 (시간 남으면)
- [ ] Upstash Vector 설정
- [ ] Vector 캐싱 구현
- [ ] 추가 애니메이션

---

## 💰 비용 계산 (단순화)

### Phase 1 (캐싱 없음)
| 항목 | 16일 비용 | 비고 |
|------|-----------|------|
| Gemini Text | ~$2.50 | 케이스 + AI 대화 |
| Gemini Image | **$0.62** | 16개 이미지 |
| Vercel | 무료 | 무료 티어 |
| Devvit | 무료 | Reddit 제공 |
| **합계** | **~$3.12** | **완전히 OK!** |

### Phase 2 (Redis 캐싱)
| 항목 | 16일 비용 | 비고 |
|------|-----------|------|
| Gemini Image | **$0.22** | 65% 절감 |
| **합계** | **~$2.72** | 40센트 절약 |

### Phase 3 (Vector 캐싱)
| 항목 | 16일 비용 | 비고 |
|------|-----------|------|
| Gemini Image | **$0.06** | 90% 절감 |
| Upstash | 무료 | 무료 티어 |
| **합계** | **~$2.56** | 56센트 절약 |

**결론**: Phase 1로 시작해도 **$3.12면 충분!** 최적화는 나중에!

---

## 🚨 주의사항

### 1. Over-engineering 금지!
- ❌ "완벽한 캐싱 시스템 먼저 만들어야지"
- ✅ "일단 작동하게 만들고, 시간 남으면 최적화"

### 2. 계획 마비 금지!
- ❌ "계획을 더 다듬어야..."
- ✅ "충분히 계획했으니 지금 바로 코딩 시작"

### 3. 완벽주의 금지!
- ❌ "이 코드는 리팩토링이 필요해"
- ✅ "작동하면 OK, 다음 기능으로"

### 4. 시간 낭비 금지!
- ❌ 40센트 절약하려고 2일 투자
- ✅ MVP 완성 후 여유있으면 최적화

---

## 🔥 즉시 시작하기

### 지금 당장 할 일 (순서대로)

```bash
# 1단계 (10분)
npm install -g devvit
devvit login
devvit new armchair-sleuths
cd armchair-sleuths

# 2단계 (10분)
# https://aistudio.google.com/app/apikey
# Gemini API 키 발급

# 3단계 (5분)
echo "GEMINI_API_KEY=your_key_here" > .env

# 4단계 (5분)
# Gemini API 테스트
node test-gemini.js

# 끝! 이제 Day 2 시작!
```

---

## 🏆 성공 기준

### Week 1 끝 (Day 7)
- ✅ 사건 자동 생성 작동
- ✅ AI 용의자와 대화 가능
- ✅ 이미지 표시됨
- ✅ 채점 시스템 작동
- ✅ 기본 UI 작동

**이것만 되면 MVP 성공!**

### Week 2 끝 (Day 14)
- ✅ 리더보드
- ✅ 버그 수정
- ✅ UX 개선

### Week 3 끝 (Day 16)
- ✅ 배포 완료
- ✅ 해커톤 제출 🎉

---

## 📢 최종 메시지

### 이 문서를 읽고 있다면...

**❌ 더 이상 계획하지 마세요**
**✅ 지금 바로 터미널을 열고 시작하세요**

```bash
npm install -g devvit
devvit login
devvit new armchair-sleuths
```

### 기억하세요

> **"해커톤에서 가장 위험한 적은 부족한 기술이 아니라
> 완벽을 추구하는 마음과 over-engineering이다."**

### 지금 필요한 것

1. ✅ Gemini API 키
2. ✅ Vercel 계정
3. ✅ 코딩 시작

### 지금 필요 없는 것

1. ❌ 더 많은 계획
2. ❌ 완벽한 아키텍처
3. ❌ OpenAI, Upstash

---

**작성자**: AI Assistant
**최종 업데이트**: 2025-01-15
**상태**: 🔥 **전쟁 모드 - 즉시 실행**
**남은 시간**: 16일 = 384시간

**지금 시작하세요! 🚀🔥**
