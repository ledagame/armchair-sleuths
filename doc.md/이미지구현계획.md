Here is Claude's plan:                                                               │
│ ╭──────────────────────────────────────────────────────────────────────────────────╮ │
│ │ 용의자 프로필 이미지 생성 및 활용 전체 구조 설계                                 │ │
│ │                                                                                  │ │
│ │ 📊 현재 상황 분석                                                                │ │
│ │                                                                                  │ │
│ │ 이미지는 어디에 저장되는가?                                                      │ │
│ │                                                                                  │ │
│ │ 현재: Base64 데이터 URL로 메모리에만 존재                                        │ │
│ │ - Vercel Function이 Gemini API를 호출하여 이미지 생성                            │ │
│ │ - 반환 형식: data:image/png;base64,iVBORw0KGgo... (1.6MB)                        │ │
│ │ - 저장 위치: 없음 (휘발성)                                                       │ │
│ │ - 문제점:                                                                        │ │
│ │   - 매번 재생성 필요 ($0.039/이미지)                                             │ │
│ │   - Base64 문자열이 너무 커서 Devvit KV Store 제한 초과 가능                     │ │
│ │   - 네트워크 부담 (2MB+ 데이터 전송)                                             │ │
│ │                                                                                  │ │
│ │ 게임앱에서 어떻게 활용하는가?                                                    │ │
│ │                                                                                  │ │
│ │ 현재 구조:                                                                       │ │
│ │ 1. CaseData 타입에 imageUrl?: string 필드 존재                                   │ │
│ │ 2. SuspectPanel.tsx에 avatarUrl prop 존재하지만 미사용                           │ │
│ │ 3. UI 컴포넌트는 준비되어 있으나 데이터 연결 안됨                                │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ 🎯 최적 설계 방안 (3단계 접근)                                                   │ │
│ │                                                                                  │ │
│ │ Phase 1: 즉시 적용 가능 (Base64 최적화)                                          │ │
│ │                                                                                  │ │
│ │ 목표: 이미지 크기 축소 + Devvit 호환                                             │ │
│ │                                                                                  │ │
│ │ 1.1 이미지 크기 최적화                                                           │ │
│ │                                                                                  │ │
│ │ // api/generate-image.ts 수정                                                    │ │
│ │ - 해상도 제한: 512x512px (현재 1024x1024 추정)                                   │ │
│ │ - JPEG 압축: PNG → JPEG (품질 80%)                                               │ │
│ │ - 예상 크기: 1.6MB → 200KB (8배 감소)                                            │ │
│ │                                                                                  │ │
│ │ 1.2 Suspect 타입 확장                                                            │ │
│ │                                                                                  │ │
│ │ // src/client/types/index.ts                                                     │ │
│ │ export interface Suspect {                                                       │ │
│ │   id: string;                                                                    │ │
│ │   caseId: string;                                                                │ │
│ │   name: string;                                                                  │ │
│ │   archetype: string;                                                             │ │
│ │   background: string;                                                            │ │
│ │   personality: string;                                                           │ │
│ │   emotionalState: EmotionalState;                                                │ │
│ │   profileImageUrl?: string; // 🆕 추가                                           │ │
│ │ }                                                                                │ │
│ │                                                                                  │ │
│ │ 1.3 케이스 생성 시 용의자별 이미지 생성                                          │ │
│ │                                                                                  │ │
│ │ // src/server/services/case/CaseGeneratorService.ts                              │ │
│ │ async generateCase() {                                                           │ │
│ │   // 각 용의자별로 프로필 이미지 생성                                            │ │
│ │   for (const suspect of suspects) {                                              │ │
│ │     const prompt = `Portrait of ${suspect.archetype}: ${suspect.background}`;    │ │
│ │     const imageUrl = await geminiClient.generateImage(prompt);                   │ │
│ │     suspect.profileImageUrl = imageUrl;                                          │ │
│ │   }                                                                              │ │
│ │ }                                                                                │ │
│ │                                                                                  │ │
│ │ 1.4 UI에서 프로필 이미지 표시                                                    │ │
│ │                                                                                  │ │
│ │ // src/client/components/suspect/SuspectPanel.tsx                                │ │
│ │ <div className="avatar">                                                         │ │
│ │   {suspect.profileImageUrl ? (                                                   │ │
│ │     <img src={suspect.profileImageUrl} alt={suspect.name} />                     │ │
│ │   ) : (                                                                          │ │
│ │     <div className="placeholder">👤</div>                                        │ │
│ │   )}                                                                             │ │
│ │ </div>                                                                           │ │
│ │                                                                                  │ │
│ │ 장점:                                                                            │ │
│ │ - 즉시 구현 가능 (2-3시간)                                                       │ │
│ │ - 외부 의존성 없음                                                               │ │
│ │ - Devvit KV Store에 저장 가능 (200KB < 1MB 제한)                                 │ │
│ │                                                                                  │ │
│ │ 단점:                                                                            │ │
│ │ - 케이스 생성 시간 증가 (용의자 3명 × 8초 = 24초)                                │ │
│ │ - 중복 생성 (같은 archetype도 매번 새로 생성)                                    │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ Phase 2: 캐싱 레이어 추가 (Redis)                                                │ │
│ │                                                                                  │ │
│ │ 목표: 이미지 재사용으로 비용/시간 절감                                           │ │
│ │                                                                                  │ │
│ │ 2.1 Vercel KV (Redis) 활용                                                       │ │
│ │                                                                                  │ │
│ │ // api/generate-image.ts                                                         │ │
│ │ import { kv } from '@vercel/kv';                                                 │ │
│ │                                                                                  │ │
│ │ async function generateImage(prompt: string) {                                   │ │
│ │   // 1. 캐시 확인                                                                │ │
│ │   const cacheKey = `image:${hashPrompt(prompt)}`;                                │ │
│ │   const cached = await kv.get(cacheKey);                                         │ │
│ │   if (cached) return { imageUrl: cached, cached: true };                         │ │
│ │                                                                                  │ │
│ │   // 2. 생성                                                                     │ │
│ │   const imageUrl = await callGeminiAPI(prompt);                                  │ │
│ │                                                                                  │ │
│ │   // 3. 캐시 저장 (7일)                                                          │ │
│ │   await kv.set(cacheKey, imageUrl, { ex: 604800 });                              │ │
│ │                                                                                  │ │
│ │   return { imageUrl, cached: false };                                            │ │
│ │ }                                                                                │ │
│ │                                                                                  │ │
│ │ 비용 절감:                                                                       │ │
│ │ - 첫 생성: $0.039                                                                │ │
│ │ - 이후 재사용: $0 (무료)                                                         │ │
│ │ - 예상 절감: 70% (유사한 archetype 재사용)                                       │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ Phase 3: 영구 스토리지 (Supabase Storage)                                        │ │
│ │                                                                                  │ │
│ │ 목표: Base64 → 실제 이미지 파일로 전환                                           │ │
│ │                                                                                  │ │
│ │ 3.1 아키텍처                                                                     │ │
│ │                                                                                  │ │
│ │ Vercel Function → Gemini API → Base64 이미지                                     │ │
│ │                 ↓                                                                │ │
│ │     Supabase Storage 업로드 (PNG/JPEG)                                           │ │
│ │                 ↓                                                                │ │
│ │     Public URL 반환 (https://...)                                                │ │
│ │                 ↓                                                                │ │
│ │         Devvit KV Store 저장                                                     │ │
│ │                                                                                  │ │
│ │ 3.2 구현                                                                         │ │
│ │                                                                                  │ │
│ │ // vercel/api/generate-and-upload-image.ts                                       │ │
│ │ import { createClient } from '@supabase/supabase-js';                            │ │
│ │                                                                                  │ │
│ │ export default async function handler(req, res) {                                │ │
│ │   // 1. Gemini로 이미지 생성                                                     │ │
│ │   const base64Image = await generateWithGemini(prompt);                          │ │
│ │                                                                                  │ │
│ │   // 2. Supabase Storage 업로드                                                  │ │
│ │   const buffer = Buffer.from(base64Image, 'base64');                             │ │
│ │   const fileName = `suspects/${caseId}/${suspectId}.jpg`;                        │ │
│ │                                                                                  │ │
│ │   await supabase.storage                                                         │ │
│ │     .from('profile-images')                                                      │ │
│ │     .upload(fileName, buffer, { contentType: 'image/jpeg' });                    │ │
│ │                                                                                  │ │
│ │   // 3. Public URL 반환                                                          │ │
│ │   const { data } = supabase.storage                                              │ │
│ │     .from('profile-images')                                                      │ │
│ │     .getPublicUrl(fileName);                                                     │ │
│ │                                                                                  │ │
│ │   return res.json({ imageUrl: data.publicUrl });                                 │ │
│ │ }                                                                                │ │
│ │                                                                                  │ │
│ │ 장점:                                                                            │ │
│ │ - 작은 URL만 저장 (50 bytes vs 200KB)                                            │ │
│ │ - CDN 캐싱으로 빠른 로딩                                                         │ │
│ │ - 영구 보관 가능                                                                 │ │
│ │                                                                                  │ │
│ │ 비용 (Supabase Free Tier):                                                       │ │
│ │ - Storage: 1GB 무료                                                              │ │
│ │ - 이미지당 200KB → 5,000개 저장 가능                                             │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ 🚀 권장 구현 순서                                                                │ │
│ │                                                                                  │ │
│ │ Step 1: Phase 1 구현 (즉시)                                                      │ │
│ │                                                                                  │ │
│ │ 1. ✅ 이미지 생성 API 작동 확인 (완료)                                            │ │
│ │ 2. 이미지 크기 최적화 (512px, JPEG)                                              │ │
│ │ 3. Suspect 타입에 profileImageUrl 추가                                           │ │
│ │ 4. CaseGeneratorService에서 용의자 이미지 생성                                   │ │
│ │ 5. SuspectPanel에서 이미지 표시                                                  │ │
│ │                                                                                  │ │
│ │ 예상 작업 시간: 2-3시간                                                          │ │
│ │                                                                                  │ │
│ │ Step 2: Phase 2 구현 (1주일 내)                                                  │ │
│ │                                                                                  │ │
│ │ 1. Vercel KV 설정                                                                │ │
│ │ 2. 캐싱 로직 추가                                                                │ │
│ │ 3. 캐시 히트율 모니터링                                                          │ │
│ │                                                                                  │ │
│ │ 예상 작업 시간: 4-6시간                                                          │ │
│ │                                                                                  │ │
│ │ Step 3: Phase 3 구현 (선택적)                                                    │ │
│ │                                                                                  │ │
│ │ 1. Supabase 프로젝트 생성                                                        │ │
│ │ 2. Storage 버킷 설정                                                             │ │
│ │ 3. 업로드 로직 구현                                                              │ │
│ │ 4. Migration 스크립트                                                            │ │
│ │                                                                                  │ │
│ │ 예상 작업 시간: 1-2일                                                            │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ 📝 구체적 변경 파일 목록                                                         │ │
│ │                                                                                  │ │
│ │ Phase 1 구현 파일                                                                │ │
│ │                                                                                  │ │
│ │ 1. api/generate-image.ts - 이미지 크기 최적화                                    │ │
│ │ 2. src/client/types/index.ts - Suspect 타입 확장                                 │ │
│ │ 3. src/server/services/case/CaseGeneratorService.ts - 이미지 생성 로직           │ │
│ │ 4. src/server/services/repositories/kv/CaseRepository.ts - 이미지 URL 저장       │ │
│ │ 5. src/client/components/suspect/SuspectPanel.tsx - 이미지 표시 UI               │ │
│ │ 6. src/server/services/repositories/kv/KVStoreManager.ts - SuspectData 타입 확장 │ │
│ │                                                                                  │ │
│ │ Phase 2 추가 파일                                                                │ │
│ │                                                                                  │ │
│ │ 1. package.json - @vercel/kv 의존성 추가                                         │ │
│ │ 2. api/generate-image.ts - Redis 캐싱 추가                                       │ │
│ │ 3. .env.local - KV_REST_API_URL, KV_REST_API_TOKEN 추가                          │ │
│ │                                                                                  │ │
│ │ Phase 3 추가 파일                                                                │ │
│ │                                                                                  │ │
│ │ 1. package.json - @supabase/supabase-js 추가                                     │ │
│ │ 2. api/generate-and-upload-image.ts - 새 엔드포인트                              │ │
│ │ 3. vercel.json - 환경 변수 설정                                                  │ │
│ │ 4. .env.local - SUPABASE_URL, SUPABASE_ANON_KEY                                  │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ 💰 비용 분석                                                                     │ │
│ │                                                                                  │ │
│ │ Phase 1 (Base64 최적화)                                                          │ │
│ │                                                                                  │ │
│ │ - 이미지 생성: 3명 × $0.039 = $0.117/케이스                                      │ │
│ │ - 16일 운영: $1.87                                                               │ │
│ │ - ✅ 저렴하고 즉시 사용 가능                                                      │ │
│ │                                                                                  │ │
│ │ Phase 2 (Redis 캐싱)                                                             │ │
│ │                                                                                  │ │
│ │ - 첫 생성: $0.117/케이스                                                         │ │
│ │ - 캐시 히트 (70%): $0.035/케이스                                                 │ │
│ │ - 16일 운영: ~$0.75                                                              │ │
│ │ - 💰 60% 비용 절감                                                               │ │
│ │                                                                                  │ │
│ │ Phase 3 (Supabase Storage)                                                       │ │
│ │                                                                                  │ │
│ │ - Gemini: 동일                                                                   │ │
│ │ - Supabase: 무료 (1GB 내)                                                        │ │
│ │ - ✅ 추가 비용 없음                                                               │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ 🎨 UI/UX 개선 방안                                                               │ │
│ │                                                                                  │ │
│ │ 용의자 카드에 프로필 이미지 추가                                                 │ │
│ │                                                                                  │ │
│ │ ┌─────────────────────────────┐                                                  │ │
│ │ │ 👤 [이미지]                  │                                                 │ │
│ │ │                             │                                                  │ │
│ │ │ 김철수 (비즈니스맨)          │                                                 │ │
│ │ │ "성공을 위해서라면..."        │                                                │ │
│ │ │                             │                                                  │ │
│ │ │ 감정 상태: 😰 불안함          │                                                │ │
│ │ │ 의심 레벨: ████░░ 40%        │                                                 │ │
│ │ └─────────────────────────────┘                                                  │ │
│ │                                                                                  │ │
│ │ 로딩 상태 표시                                                                   │ │
│ │                                                                                  │ │
│ │ {isLoading ? (                                                                   │ │
│ │   <div className="shimmer-placeholder" />                                        │ │
│ │ ) : (                                                                            │ │
│ │   <img src={profileImageUrl} />                                                  │ │
│ │ )}                                                                               │ │
│ │                                                                                  │ │
│ │ ---                                                                              │ │
│ │ 권장사항: Phase 1부터 순차적 구현, 사용자 피드백 수집 후 Phase 2/3 결정   