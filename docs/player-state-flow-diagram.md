# Player State Initialization Flow

## Current Flow (Broken)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                  â”‚ Case API â”‚                â”‚  KV Store   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                            â”‚                              â”‚
     â”‚  GET /api/case/:caseId     â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  Fetch case data             â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  Case data                   â”‚
     â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                              â”‚
     â”‚  200 OK (case data)        â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
     â”‚                            â”‚                              â”‚
     â”‚  GET /api/player-state/    â”‚                              â”‚
     â”‚      :caseId/:userId       â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  Query player state          â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  âŒ NOT FOUND                â”‚
     â”‚  âŒ 404 NOT FOUND          â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                              â”‚
     â”‚  ğŸ˜¢ Error: Cannot start    â”‚                              â”‚
     â”‚      game                  â”‚                              â”‚
     â”‚                            â”‚                              â”‚
```

**Problem**: Player state is never created, so API returns 404.

---

## Fixed Flow (Auto-Initialize)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                  â”‚ Case API â”‚                â”‚  KV Store   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                            â”‚                              â”‚
     â”‚  GET /api/case/:caseId     â”‚                              â”‚
     â”‚      ?userId=user123       â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  Fetch case data             â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  Case data                   â”‚
     â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  âœ… Check player state       â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  âŒ NOT FOUND                â”‚
     â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  âœ… AUTO-CREATE              â”‚
     â”‚                            â”‚  Initialize state:           â”‚
     â”‚                            â”‚  - current AP: 3             â”‚
     â”‚                            â”‚  - discovered: []            â”‚
     â”‚                            â”‚  - searches: []              â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  âœ… SAVED                    â”‚
     â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                              â”‚
     â”‚  200 OK (case data +       â”‚                              â”‚
     â”‚         playerInitialized) â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
     â”‚                            â”‚                              â”‚
     â”‚  GET /api/player-state/    â”‚                              â”‚
     â”‚      :caseId/:userId       â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  Query player state          â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  âœ… FOUND                    â”‚
     â”‚  âœ… 200 OK (player state)  â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                              â”‚
     â”‚  ğŸ˜Š Game starts            â”‚                              â”‚
     â”‚      successfully!         â”‚                              â”‚
     â”‚                            â”‚                              â”‚
```

**Solution**: Auto-initialize player state when case is accessed with userId.

---

## Fallback Flow (Double Safety)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                  â”‚ Player State â”‚            â”‚  KV Store   â”‚
â”‚         â”‚                  â”‚     API      â”‚            â”‚             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                              â”‚                            â”‚
     â”‚  GET /api/player-state/      â”‚                            â”‚
     â”‚      :caseId/:userId         â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚  Query player state        â”‚
     â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚  âŒ NOT FOUND              â”‚
     â”‚                              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚  âš ï¸ Verify case exists     â”‚
     â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚  âœ… Case exists            â”‚
     â”‚                              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚  âœ… AUTO-CREATE            â”‚
     â”‚                              â”‚  (fallback safety net)     â”‚
     â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚  âœ… SAVED                  â”‚
     â”‚                              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                              â”‚                            â”‚
     â”‚  âœ… 200 OK (player state)    â”‚                            â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
     â”‚                              â”‚                            â”‚
     â”‚  ğŸ˜Š Game continues           â”‚                            â”‚
     â”‚                              â”‚                            â”‚
```

**Benefit**: Even if auto-init in case API fails, player state API creates it as fallback.

---

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                  â”‚ Player State â”‚            â”‚  KV Store   â”‚
â”‚         â”‚                  â”‚     API      â”‚            â”‚             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                              â”‚                            â”‚
     â”‚  GET /api/player-state/      â”‚                            â”‚
     â”‚      undefined/user123       â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚  âš ï¸ VALIDATE INPUT         â”‚
     â”‚                              â”‚  caseId = 'undefined' âŒ   â”‚
     â”‚                              â”‚                            â”‚
     â”‚  âŒ 400 Bad Request           â”‚                            â”‚
     â”‚  { error: "Invalid caseId" } â”‚                            â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
     â”‚                              â”‚                            â”‚
     â”‚  GET /api/player-state/      â”‚                            â”‚
     â”‚      case-123/undefined      â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚  âš ï¸ VALIDATE INPUT         â”‚
     â”‚                              â”‚  userId = 'undefined' âŒ   â”‚
     â”‚                              â”‚                            â”‚
     â”‚  âŒ 400 Bad Request           â”‚                            â”‚
     â”‚  { error: "Invalid userId" } â”‚                            â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
     â”‚                              â”‚                            â”‚
     â”‚  GET /api/player-state/      â”‚                            â”‚
     â”‚      invalid-case/user123    â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚  Query case                â”‚
     â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚  âŒ Case NOT FOUND         â”‚
     â”‚                              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                              â”‚                            â”‚
     â”‚  âŒ 404 Not Found             â”‚                            â”‚
     â”‚  { error: "Case not found" } â”‚                            â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
     â”‚                              â”‚                            â”‚
```

**Benefit**: Clear error messages instead of generic 404s.

---

## Action Points Integration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                  â”‚ Game API â”‚                â”‚  KV Store   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                            â”‚                              â”‚
     â”‚  1. GET /api/case/         â”‚                              â”‚
     â”‚     case-123?userId=alice  â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  âœ… Auto-init player state   â”‚
     â”‚                            â”‚  - AP: 3                     â”‚
     â”‚                            â”‚  - acquired: []              â”‚
     â”‚                            â”‚  - spent: 0                  â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚  âœ… 200 OK                 â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
     â”‚                            â”‚                              â”‚
     â”‚  2. POST /api/chat/        â”‚                              â”‚
     â”‚     suspect-1              â”‚                              â”‚
     â”‚     { message: "alibi?" }  â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  Fetch player state          â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  State (AP: 3)               â”‚
     â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  âœ… Analyze conversation     â”‚
     â”‚                            â”‚  Topic: alibi â†’ +1 AP        â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  Update state (AP: 4)        â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚  âœ… 200 OK                 â”‚                              â”‚
     â”‚  { apGained: 1,            â”‚                              â”‚
     â”‚    newTotal: 4 }           â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
     â”‚                            â”‚                              â”‚
     â”‚  3. POST /api/location/    â”‚                              â”‚
     â”‚     search                 â”‚                              â”‚
     â”‚     { type: "thorough" }   â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  Fetch player state          â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  State (AP: 4)               â”‚
     â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  âœ… Deduct AP (4 - 2 = 2)    â”‚
     â”‚                            â”‚  âœ… Discover evidence        â”‚
     â”‚                            â”‚                              â”‚
     â”‚                            â”‚  Update state (AP: 2)        â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                              â”‚
     â”‚  âœ… 200 OK                 â”‚                              â”‚
     â”‚  { evidenceFound: [...],   â”‚                              â”‚
     â”‚    currentAP: 2 }          â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
     â”‚                            â”‚                              â”‚
```

**Key**: Player state persists across all game actions (chat, search, etc.)

---

## State Persistence Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Client State                         â”‚
â”‚  - Current AP displayed                                â”‚
â”‚  - Discovered evidence list                            â”‚
â”‚  - Search history                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Sync via API calls
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Server State (KV Store)                â”‚
â”‚                                                        â”‚
â”‚  Key: player-state:case-123:alice                      â”‚
â”‚  Value: {                                              â”‚
â”‚    caseId: "case-123",                                 â”‚
â”‚    userId: "alice",                                    â”‚
â”‚    actionPoints: {                                     â”‚
â”‚      current: 2,                                       â”‚
â”‚      total: 4,                                         â”‚
â”‚      spent: 2,                                         â”‚
â”‚      initial: 3,                                       â”‚
â”‚      acquisitionHistory: [                             â”‚
â”‚        { timestamp, amount: 1, source: "topic" }       â”‚
â”‚      ],                                                â”‚
â”‚      spendingHistory: [                                â”‚
â”‚        { timestamp, amount: 2, action: "thorough" }    â”‚
â”‚      ],                                                â”‚
â”‚      acquiredTopics: Set("suspect-1:alibi"),           â”‚
â”‚      bonusesAcquired: Set(),                           â”‚
â”‚      emergencyAPUsed: false                            â”‚
â”‚    },                                                  â”‚
â”‚    discoveredEvidence: [                               â”‚
â”‚      { evidenceId, discoveredAt, method, locationId }  â”‚
â”‚    ],                                                  â”‚
â”‚    searchHistory: [                                    â”‚
â”‚      { locationId, searchType, timestamp, found: 3 }   â”‚
â”‚    ],                                                  â”‚
â”‚    stats: {                                            â”‚
â”‚      totalSearches: 1,                                 â”‚
â”‚      thoroughSearches: 1,                              â”‚
â”‚      totalEvidenceFound: 3,                            â”‚
â”‚      criticalEvidenceFound: 1,                         â”‚
â”‚      efficiency: 30.0                                  â”‚
â”‚    },                                                  â”‚
â”‚    lastUpdated: "2025-10-23T10:30:00Z"                 â”‚
â”‚  }                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Summary

```
START
  â”‚
  â”œâ”€> Player accesses game
  â”‚   â””â”€> GET /api/case/:caseId?userId=X
  â”‚       â”œâ”€> Fetch case from KV store
  â”‚       â”œâ”€> Check if player state exists
  â”‚       â”œâ”€> If missing: AUTO-CREATE âœ…
  â”‚       â”‚   â”œâ”€> Initialize AP (3)
  â”‚       â”‚   â”œâ”€> Initialize empty arrays
  â”‚       â”‚   â””â”€> Save to KV store
  â”‚       â””â”€> Return case + playerInitialized: true
  â”‚
  â”œâ”€> Player checks state
  â”‚   â””â”€> GET /api/player-state/:caseId/:userId
  â”‚       â”œâ”€> Fetch from KV store
  â”‚       â”œâ”€> If missing: AUTO-CREATE (fallback) âœ…
  â”‚       â””â”€> Return state (always 200 OK)
  â”‚
  â”œâ”€> Player chats with suspect
  â”‚   â””â”€> POST /api/chat/:suspectId
  â”‚       â”œâ”€> Analyze conversation
  â”‚       â”œâ”€> Award AP for topics
  â”‚       â”œâ”€> Update player state
  â”‚       â””â”€> Return response + AP gained
  â”‚
  â”œâ”€> Player searches location
  â”‚   â””â”€> POST /api/location/search
  â”‚       â”œâ”€> Check AP availability
  â”‚       â”œâ”€> Deduct AP (1/2/3)
  â”‚       â”œâ”€> Discover evidence
  â”‚       â”œâ”€> Update player state
  â”‚       â””â”€> Return evidence + remaining AP
  â”‚
  â””â”€> Player submits answer
      â””â”€> POST /api/submit
          â”œâ”€> Validate answers
          â”œâ”€> Calculate score
          â””â”€> Update leaderboard
END
```

---

## Key Takeaways

1. **Auto-Initialize**: Player state created automatically on first access
2. **Double Safety**: Fallback creation if primary init fails
3. **Validation**: Clear errors for invalid input
4. **Persistence**: All game progress saved to KV store
5. **Zero 404s**: Always return valid state or clear error

---

**Visual Legend**:
- âœ… = Success path
- âŒ = Error path
- âš ï¸ = Validation/Warning
- ğŸ˜Š = Happy player
- ğŸ˜¢ = Frustrated player

**Created**: 2025-10-23
**Status**: Implementation Ready
