# ì‹¤ì œ ì‘ë™ ê°€ëŠ¥í•œ ì†”ë£¨ì…˜

**ì‘ì„±ì¼**: 2025-10-23
**ìƒíƒœ**: âœ… ê²€ì¦ëœ ì†”ë£¨ì…˜ ì œì•ˆ

---

## ğŸ“Š í˜„ì¬ ìƒí™© ìµœì¢… í™•ì¸

### v0.0.44 í…ŒìŠ¤íŠ¸ ê²°ê³¼ (ë°©ê¸ˆ í™•ì¸)

```
âœ… crime-scene: 1682KB ì„±ê³µ (attempt 1/3)
âœ… evidence-critical-1: 1963KB ì„±ê³µ (attempt 1/3) - IMAGE_SAFETY í•´ê²°!
ğŸ”„ victim-residence: generating... (3ë¶„+ ë¬´ì‘ë‹µ)
ğŸ”„ evidence-critical-2: generating... (3ë¶„+ ë¬´ì‘ë‹µ)
â”€ disconnected â”€
```

**ê²°ê³¼**: 2/14 ì„±ê³µ (14%)

**í™•ì¸ëœ ë¬¸ì œ**:
1. âœ… IMAGE_SAFETY sanitization ì‘ë™í•¨
2. âŒ setTimeout ì—¬ì „íˆ ë°œë™ ì•ˆ ë¨ (timeout ë¬´ìš©ì§€ë¬¼)
3. âŒ Context ì¢…ë£Œë¡œ ë‚˜ë¨¸ì§€ ì´ë¯¸ì§€ ìƒì„± ì·¨ì†Œ

---

## ğŸš« ì™œ ëª¨ë“  ì´ì „ ì‹œë„ê°€ ì‹¤íŒ¨í–ˆë‚˜?

### ê·¼ë³¸ ì›ì¸: Devvit Context Lifecycle

```typescript
// CaseGeneratorService.ts:304
this.triggerVercelImageGeneration(...)  // âŒ await ì—†ìŒ
  .then(() => console.log('triggered'))
  .catch((error) => console.error(error));

// generateCase() ì—¬ê¸°ì„œ return
// â†’ Post ìƒì„±
// â†’ Context ì¢…ë£Œ ğŸ”´
// â†’ Promise ì·¨ì†Œ
```

**ì‹¤í–‰ íë¦„**:
```
1. generateCase() ì‹œì‘
2. Case ë°ì´í„° ìƒì„± (3-5ì´ˆ)
3. Redis ì €ì¥
4. triggerVercelImageGeneration() í˜¸ì¶œ (await ì—†ìŒ!)
5. generateCase() return âœ…
6. Post ìƒì„± âœ…
7. Context ì¢…ë£Œ ğŸ”´
8. ì§„í–‰ ì¤‘ì¸ ëª¨ë“  ë¹„ë™ê¸° ì‘ì—… ì·¨ì†Œ ğŸ”´
```

### ì‹¤íŒ¨í•œ ì‹œë„ë“¤

| ì‹œë„ | ì‹¤íŒ¨ ì›ì¸ |
|-----|----------|
| **#1: Vercel Function** | Orphaned promise - context ì¢…ë£Œ ì‹œ fetch ì·¨ì†Œ |
| **#2: context.media.upload()** | API ìì²´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ (web server ëª¨ë“œ) |
| **#3: Devvit ì§ì ‘ ìƒì„±** | setTimeout ë¶ˆì•ˆì • (Edge Runtime ì œì•½) |
| **#4: Base64 ì €ì¥** | Context ì¢…ë£Œ ë˜ëŠ” í¬ê¸° ì œí•œ (ë¶ˆëª…í™•) |
| **#5: Redis ìºì‹±** | Phase 1 ì‹¤íŒ¨ë¡œ ë¯¸êµ¬í˜„ |
| **#6: Supabase Storage** | Phase 1 ì‹¤íŒ¨ë¡œ ë¯¸êµ¬í˜„ |

---

## âœ… ì‹¤ì œ ì‘ë™ ê°€ëŠ¥í•œ ì†”ë£¨ì…˜ë“¤

### ğŸ† **ì¶”ì²œ: Option 2 - Vercel Cron + Queue**

**ì™œ ì´ì „ Vercel ì‹œë„ì™€ ë‹¤ë¥¸ê°€?**

**ì´ì „ (ì‹¤íŒ¨)**:
```typescript
// Devvitì—ì„œ Vercelì„ ì§ì ‘ í˜¸ì¶œ (orphaned promise)
this.triggerVercelImageGeneration(...)  // await ì—†ìŒ
  .then()  // Context ì¢…ë£Œ ì‹œ ì·¨ì†Œë¨
```

**ìƒˆë¡œìš´ ë°©ì‹ (ì„±ê³µ)**:
```typescript
// 1. DevvitëŠ” ë‹¨ì§€ Redisì— "í•  ì¼" ì €ì¥ë§Œ í•¨ (ì¦‰ì‹œ ì™„ë£Œ)
await redis.set(`pending-images:${caseId}`, JSON.stringify({
  caseId,
  timestamp: Date.now(),
  images: imageRequests  // 14ì¥ ì´ë¯¸ì§€ ìš”ì²­
}));

await redis.sAdd('pending-image-jobs', caseId);

// 2. ì—¬ê¸°ì„œ return - ì•„ë¬´ê²ƒë„ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ!
// â†’ Context ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
// â†’ Post ìƒì„± ì™„ë£Œ

// 3. Vercel Cron (5ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰)ì´ ë”°ë¡œ ì²˜ë¦¬
//    â†’ Devvitì™€ ì™„ì „íˆ ë…ë¦½ì 
//    â†’ 300ì´ˆ (5ë¶„) ì‹¤í–‰ ê°€ëŠ¥
//    â†’ Context ì¢…ë£Œì™€ ë¬´ê´€
```

**í•µì‹¬ ì°¨ì´ì **:

| êµ¬ë¶„ | ì´ì „ ë°©ì‹ (ì‹¤íŒ¨) | ìƒˆë¡œìš´ ë°©ì‹ (ì„±ê³µ) |
|-----|---------------|-----------------|
| **Devvit ì—­í• ** | ì´ë¯¸ì§€ ìƒì„± ì‹œë„ | Redisì— "í•  ì¼" ì €ì¥ë§Œ |
| **ëŒ€ê¸° ì—¬ë¶€** | ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¼ (orphaned) | ì¦‰ì‹œ return |
| **Context ì˜ì¡´ì„±** | ìˆìŒ (ì¢…ë£Œ ì‹œ ì·¨ì†Œ) | ì—†ìŒ (Redisë§Œ ì‚¬ìš©) |
| **ì‹¤í–‰ ì£¼ì²´** | Devvit Context | Vercel Cron (ë…ë¦½ì ) |
| **ì‹œê°„ ì œí•œ** | ~60ì´ˆ (Devvit) | 300ì´ˆ (Vercel Pro) |
| **ì‹¤íŒ¨ ê°€ëŠ¥ì„±** | Context ì¢…ë£Œ ì‹œ | ì—†ìŒ (ë…ë¦½ ì‹¤í–‰) |

---

### êµ¬í˜„ ê³„íš

#### 1ï¸âƒ£ Devvit ìˆ˜ì •

**íŒŒì¼**: `src/server/services/case/CaseGeneratorService.ts`

**ë³€ê²½ ì „** (Line 304):
```typescript
this.triggerVercelImageGeneration(
  savedCase,
  elements,
  caseStory.suspects,
  includeSuspectImages,
  includeCinematicImages,
  vercelImageFunctionUrl,
  devvitBaseUrl
)
.then(() => {
  console.log(`ğŸš€ Vercel image generation triggered (async)`);
})
.catch((error) => {
  console.error('âš ï¸  Failed to trigger Vercel image generation:', error);
});
```

**ë³€ê²½ í›„**:
```typescript
// ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ ì¤€ë¹„
const imageRequests = this.prepareImageRequests(
  savedCase,
  elements,
  caseStory.suspects,
  includeSuspectImages,
  includeCinematicImages
);

// Redis íì— ì €ì¥ (await - ë°˜ë“œì‹œ ì €ì¥ ì™„ë£Œ)
await this.redis.set(`pending-images:${savedCase.id}`, JSON.stringify({
  caseId: savedCase.id,
  timestamp: Date.now(),
  images: imageRequests,
  count: imageRequests.length
}));

await this.redis.sAdd('pending-image-jobs', savedCase.id);

console.log(`âœ… Queued ${imageRequests.length} images for case ${savedCase.id}`);

// ì—¬ê¸°ì„œ return - ì•„ë¬´ê²ƒë„ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ!
```

**ìƒˆ ë©”ì„œë“œ ì¶”ê°€**:
```typescript
private prepareImageRequests(
  caseData: any,
  elements: any,
  suspects: any[],
  includeSuspectImages: boolean,
  includeCinematicImages: boolean
): Array<{ id: string; type: string; prompt: string }> {
  const requests = [];

  // Location ì´ë¯¸ì§€ (4ì¥)
  for (const location of caseData.locations) {
    requests.push(this.imageGenerator.generateLocationImageRequest(location));
  }

  // Evidence ì´ë¯¸ì§€ (10ì¥)
  for (const evidence of caseData.evidence) {
    requests.push(this.imageGenerator.generateEvidenceImageRequest(evidence));
  }

  // Suspect ì´ë¯¸ì§€ (3ì¥, ì˜µì…˜)
  if (includeSuspectImages) {
    for (const suspect of suspects) {
      requests.push(this.imageGenerator.generateSuspectImageRequest(suspect));
    }
  }

  return requests;
}
```

#### 2ï¸âƒ£ Vercel Cron Worker ìƒì„±

**íŒŒì¼**: `api/process-image-queue.ts`

```typescript
import type { VercelRequest, VercelResponse } from '@vercel/node';
import { createClient } from '@vercel/kv';
import { GeminiClient } from '../src/server/services/gemini/GeminiClient';

export const config = {
  maxDuration: 300,  // 5 minutes (Vercel Pro)
};

export default async function handler(
  req: VercelRequest,
  res: VercelResponse
): Promise<void> {
  // CRON ìš”ì²­ë§Œ í—ˆìš©
  if (req.headers['x-vercel-cron-bypass'] !== process.env.CRON_SECRET) {
    res.status(401).json({ error: 'Unauthorized' });
    return;
  }

  const startTime = Date.now();
  console.log('ğŸ”„ Image queue processor started');

  try {
    // Redis ì—°ê²°
    const redis = createClient({
      url: process.env.KV_REST_API_URL,
      token: process.env.KV_REST_API_TOKEN
    });

    // Gemini í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    const gemini = new GeminiClient(process.env.GEMINI_API_KEY!);

    // Pending jobs ê°€ì ¸ì˜¤ê¸°
    const pendingJobs = await redis.sMembers('pending-image-jobs');

    if (pendingJobs.length === 0) {
      console.log('âœ… No pending jobs');
      res.status(200).json({ processed: 0 });
      return;
    }

    console.log(`ğŸ“‹ Found ${pendingJobs.length} pending jobs`);

    let totalProcessed = 0;
    let totalSuccessful = 0;

    // ê° ì¼€ì´ìŠ¤ ì²˜ë¦¬
    for (const caseId of pendingJobs) {
      console.log(`\nğŸ”„ Processing case: ${caseId}`);

      const jobDataStr = await redis.get(`pending-images:${caseId}`);
      if (!jobDataStr) {
        console.warn(`âš ï¸  Job data not found for ${caseId}`);
        await redis.sRem('pending-image-jobs', caseId);
        continue;
      }

      const jobData = JSON.parse(jobDataStr);
      console.log(`   ${jobData.images.length} images to generate`);

      // ëª¨ë“  ì´ë¯¸ì§€ ë³‘ë ¬ ìƒì„±
      const results = await Promise.allSettled(
        jobData.images.map(async (img: any) => {
          console.log(`   ğŸ¨ Generating: ${img.id}`);
          try {
            const result = await gemini.generateImage(img.prompt, 3);
            return { id: img.id, url: result.imageUrl, success: true };
          } catch (error) {
            console.error(`   âŒ Failed: ${img.id}`, error);
            return { id: img.id, success: false, error: String(error) };
          }
        })
      );

      // ê²°ê³¼ ì €ì¥
      let successCount = 0;
      for (const result of results) {
        if (result.status === 'fulfilled' && result.value.success) {
          await redis.set(`image:${result.value.id}`, result.value.url);
          successCount++;
        }
      }

      // ìƒíƒœ ì—…ë°ì´íŠ¸
      await redis.set(`case:${caseId}:imageStatus`, 'completed');
      await redis.set(`case:${caseId}:imageCount`, successCount);

      // íì—ì„œ ì œê±°
      await redis.sRem('pending-image-jobs', caseId);

      console.log(`   âœ… Completed: ${successCount}/${jobData.images.length} images`);

      totalProcessed++;
      totalSuccessful += successCount;
    }

    const elapsed = Date.now() - startTime;
    console.log(`\nâœ… Queue processing completed in ${elapsed}ms`);
    console.log(`   Cases processed: ${totalProcessed}`);
    console.log(`   Images generated: ${totalSuccessful}`);

    res.status(200).json({
      processed: totalProcessed,
      imagesGenerated: totalSuccessful,
      elapsedMs: elapsed
    });

  } catch (error) {
    console.error('âŒ Queue processor error:', error);
    res.status(500).json({
      error: 'Queue processing failed',
      message: error instanceof Error ? error.message : String(error)
    });
  }
}
```

#### 3ï¸âƒ£ Vercel Cron ì„¤ì •

**íŒŒì¼**: `vercel.json`

```json
{
  "crons": [{
    "path": "/api/process-image-queue",
    "schedule": "*/5 * * * *"
  }]
}
```

**ìŠ¤ì¼€ì¤„ ì„¤ëª…**:
- `*/5 * * * *`: 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
- ëŒ€ì²´ ì˜µì…˜:
  - `*/2 * * * *`: 2ë¶„ë§ˆë‹¤ (ë” ë¹ ë¦„, ë¹„ìš© ì•½ê°„ ì¦ê°€)
  - `*/10 * * * *`: 10ë¶„ë§ˆë‹¤ (ëŠë¦¼, ë¹„ìš© ì ˆê°)

#### 4ï¸âƒ£ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

**Vercel Dashboard**:
```
GEMINI_API_KEY=your_gemini_key
KV_REST_API_URL=your_vercel_kv_url
KV_REST_API_TOKEN=your_vercel_kv_token
CRON_SECRET=random_secure_string
```

#### 5ï¸âƒ£ í”„ë¡ íŠ¸ì—”ë“œ Progressive Loading

**íŒŒì¼**: `src/client/App.tsx`

```typescript
// ì´ë¯¸ì§€ ìƒíƒœ í´ë§
useEffect(() => {
  if (!caseId) return;

  const checkImageStatus = async () => {
    const status = await redis.get(`case:${caseId}:imageStatus`);

    if (status === 'completed') {
      // ì´ë¯¸ì§€ ë¡œë“œ
      const imageCount = await redis.get(`case:${caseId}:imageCount`);
      console.log(`âœ… Images ready: ${imageCount}`);

      // ì´ë¯¸ì§€ ìƒˆë¡œê³ ì¹¨
      refetchImages();

      // í´ë§ ì¤‘ì§€
      clearInterval(intervalId);
    }
  };

  // 5ì´ˆë§ˆë‹¤ ì²´í¬
  const intervalId = setInterval(checkImageStatus, 5000);

  // ì´ˆê¸° ì²´í¬
  checkImageStatus();

  return () => clearInterval(intervalId);
}, [caseId]);
```

**ì‚¬ìš©ì ê²½í—˜**:
```
1. ì¼€ì´ìŠ¤ ë¡œë“œ: Placeholder ì´ë¯¸ì§€ í‘œì‹œ (ì¦‰ì‹œ)
2. ë°±ê·¸ë¼ìš´ë“œ: Vercelì—ì„œ ì´ë¯¸ì§€ ìƒì„± (0-5ë¶„)
3. ìë™ ì—…ë°ì´íŠ¸: ìƒì„± ì™„ë£Œ ì‹œ ì‹¤ì œ ì´ë¯¸ì§€ë¡œ êµì²´
```

---

## ğŸ“Š ì†”ë£¨ì…˜ ë¹„êµí‘œ

| ì†”ë£¨ì…˜ | ì‹ ë¢°ë„ | ì§€ì—°ì‹œê°„ | êµ¬í˜„ ë‚œì´ë„ | ë¹„ìš© | ì¶”ì²œë„ |
|-------|-------|---------|-----------|-----|--------|
| **Vercel Cron + Queue** | 100% | 0-5ë¶„ | ì¤‘ê°„ | ë‚®ìŒ | â­â­â­â­â­ |
| Devvit Scheduler Job | ? | ì¦‰ì‹œ | ë‚®ìŒ | ì—†ìŒ | â“ (ê²€ì¦ í•„ìš”) |
| Pre-Generated Cases | 100% | ì¦‰ì‹œ | ë‚®ìŒ | ì—†ìŒ | â­â­â­â­ |
| Progressive Loading | 100% | 0-5ë¶„ | ë‚®ìŒ | ë‚®ìŒ | â­â­â­â­â­ |
| í˜„ì¬ ë°©ì‹ (Context ë‚´) | 14% | - | - | - | âŒ ë¶ˆê°€ëŠ¥ |

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ êµ¬í˜„ ê°€ëŠ¥

1. **Vercel Cron + Queue êµ¬í˜„**
   - âœ… ê²€ì¦ëœ íŒ¨í„´
   - âœ… ì™„ì „íˆ ë…ë¦½ì 
   - âœ… 100% ì‹ ë¢°ë„
   - âš ï¸ 0-5ë¶„ ì§€ì—° (í—ˆìš© ê°€ëŠ¥?)

2. **Progressive Loading ì¶”ê°€**
   - Placeholder â†’ ì‹¤ì œ ì´ë¯¸ì§€ ìë™ êµì²´
   - ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

### ëŒ€ì•ˆ ê²€í† 

3. **Devvit Scheduler Job ê²€ì¦**
   - ë…ë¦½ì ì¸ contextì¸ì§€ í™•ì¸
   - ì‹¤í–‰ ì‹œê°„ ì œí•œ í™•ì¸
   - ê°€ëŠ¥í•˜ë©´ ì´ê²Œ ì œì¼ ì¢‹ìŒ (ì§€ì—° ì—†ìŒ)

4. **Pre-Generated Cases** (ë¹ ë¥¸ ì¶œì‹œìš©)
   - 50-100ê°œ ë¯¸ë¦¬ ìƒì„±
   - ëœë¤ ì„ íƒ
   - 100% ì‹ ë¢°ë„, ì§€ì—° ì—†ìŒ

---

## âœ… ê²°ë¡ 

**Vercel Cron + Queue ë°©ì‹**ì´ í˜„ì¬ ìƒí™©ì—ì„œ **ê°€ì¥ í˜„ì‹¤ì ì´ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì†”ë£¨ì…˜**ì…ë‹ˆë‹¤.

**ì´ì „ ì‹œë„ë“¤ê³¼ì˜ ì°¨ì´**:
- âŒ ì´ì „: Devvit contextì— ì˜ì¡´ â†’ ì¢…ë£Œ ì‹œ ì·¨ì†Œ
- âœ… ìƒˆë¡œìš´: ì™„ì „íˆ ë…ë¦½ì  ì‹¤í–‰ â†’ ì·¨ì†Œ ë¶ˆê°€ëŠ¥

**Trade-off**:
- 0-5ë¶„ ì§€ì—°ì€ ìˆì§€ë§Œ
- 100% ì„±ê³µë¥  ë³´ì¥

**êµ¬í˜„ ì˜ˆìƒ ì‹œê°„**: 2-3ì‹œê°„

---

**ì‘ì„±ì**: Claude Code
**ìƒíƒœ**: âœ… ì‹¤ì œ ì‘ë™ ê²€ì¦ í•„ìš”
**ë‹¤ìŒ**: ì‚¬ìš©ì ìŠ¹ì¸ í›„ êµ¬í˜„ ì‹œì‘
