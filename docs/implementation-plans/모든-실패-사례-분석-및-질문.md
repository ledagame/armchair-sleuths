# 모든 실패 사례 분석 및 질문

**작성일**: 2025-10-23
**상태**: 🔴 모든 시도 실패 확인됨

---

## 📋 확인된 실패 사례들

### 1. Vercel Function 방식 (vercel-image-integration-IMPLEMENTATION-COMPLETE.md)

**시도 날짜**: 2025-10-21

**방법:**
```
Devvit → Vercel Function → Gemini API → Image → Webhook → Redis
```

**구현 상태:**
- ✅ `api/generate-all-images.ts` 파일 존재 (335줄)
- ✅ Webhook 핸들러 구현됨
- ✅ `*.vercel.app` wildcard 허용 등록

**실패 원인 (추정):**
```typescript
// CaseGeneratorService.ts Line 304
this.triggerVercelImageGeneration(...)  // await 없음
  .then(() => console.log('triggered'))
  .catch(error => console.error(error));

// generateCase() 즉시 return
// → Post 생성
// → Context 종료 🔴
// → fetch() 취소됨
```

**결과:** ❌ 실패
**문제:** Orphaned Promise - Context 종료 시 취소

---

### 2. context.media.upload() API 방식 (CRITICAL_FINDING_MEDIA_API.md)

**시도 날짜**: 2025-10-21

**방법:**
```
Gemini URL → context.media.upload() → Reddit CDN (i.redd.it)
```

**발견:**
```
context.media is undefined
```

**실패 원인:**
- Devvit Web Server 모드에서 `context.media` API 자체가 존재하지 않음
- Traditional Devvit App에서만 사용 가능할 가능성
- Web Server와 Public API의 Context 타입이 다름

**결과:** ❌ 실패
**문제:** API 자체가 존재하지 않음

---

### 3. Devvit 내부 직접 생성 (v0.0.44, 오늘)

**시도 날짜**: 2025-10-23

**방법:**
```typescript
// Devvit 내부에서 직접 Gemini API 호출
// GeminiClient.generateImage() with Promise.race timeout
```

**구현:**
```typescript
const timeoutPromise = new Promise((_, reject) => {
  setTimeout(() => reject('Timeout'), 60000);
});

const fetchPromise = fetch(geminiUrl, ...);

return await Promise.race([fetchPromise, timeoutPromise]);
```

**실패 원인:**
- Devvit Background Scheduler에서 setTimeout이 작동하지 않음
- Edge Runtime (Cloudflare Workers 유사) 환경 추정
- Timer는 I/O 후에만 진행 (보안 조치)

**결과:** ❌ 실패 (2/14 성공, 2개 3분+ 무한 대기)
**문제:** setTimeout 불안정, timeout 미발동

---

### 4. Base64 방식 (이미지구현계획.md - Phase 1)

**계획 내용:**
- 이미지를 Base64로 인코딩
- Redis KV Store에 저장
- 512x512, JPEG 압축으로 크기 축소 (200KB 목표)

**실패 원인 (추정):**
- KV Store 크기 제한 초과?
- 14장 × 200KB = 2.8MB
- 네트워크 전송 부담
- 또는 Context 제한으로 생성 자체 실패?

**결과:** ❌ 실패
**문제:** 정확한 실패 원인 불명

---

### 5. Redis 캐싱 방식 (이미지구현계획.md - Phase 2)

**계획 내용:**
- Vercel KV (Redis)에 이미지 캐싱
- 동일 archetype 재사용으로 비용 절감

**상태:** 계획만 있고 구현 안 됨?

**추정 실패 이유:**
- Phase 1 (Base64)이 실패해서 Phase 2로 못 감

---

### 6. Supabase Storage 방식 (이미지구현계획.md - Phase 3)

**계획 내용:**
```
Gemini → Base64 → Supabase Storage 업로드 → Public URL
```

**상태:** 계획만 있고 구현 안 됨?

**추정 실패 이유:**
- Phase 1, 2가 실패해서 Phase 3로 못 감
- 또는 Vercel Function 방식(#1)과 동일한 orphaned promise 문제

---

## 🚨 공통 실패 원인

### 근본 문제: Devvit Context Lifecycle

**문제 상황:**
```
1. generateCase() 실행
   ↓ (3-5초)
2. Case 저장 완료
   ↓
3. 이미지 생성 시작 (비동기)
   ↓
4. generateCase() return ✅
   ↓
5. Post 생성 ✅
   ↓
6. Devvit Context 종료 🔴
   ↓
7. 실행 중인 작업 모두 취소 🔴
```

**증거:**
- 사용자 증언: "백그라운드에서도 포스트가 업로드되는즉시 종료되어서"
- v0.0.44 로그: 2/14만 성공, 나머지 무반응
- Vercel Function도 호출 자체 실패 (orphaned promise)

---

## 📊 시도 요약표

| # | 방법 | 상태 | 실패 원인 |
|---|------|------|----------|
| 1 | Vercel Function | ❌ 실패 | Orphaned promise (context 종료) |
| 2 | context.media.upload() | ❌ 실패 | API 존재하지 않음 (web server) |
| 3 | Devvit 직접 생성 | ❌ 실패 | setTimeout 불안정 |
| 4 | Base64 저장 | ❌ 실패 | 불명 (크기? context?) |
| 5 | Redis 캐싱 | ⏸️ 미구현 | Phase 1 실패로 중단 |
| 6 | Supabase Storage | ⏸️ 미구현 | Phase 1 실패로 중단 |

---

## ❓ 정확한 상황 파악을 위한 질문

### 1. **Suspect 3장 이미지**

**질문 1:**
```
api/generate-all-images.ts가 있고, vercel-image-integration-IMPLEMENTATION-COMPLETE.md에
"성공"이라고 되어 있는데, 실제로는 production에서 작동하지 않았나요?
```

**추가 질문:**
- 로컬 개발(npm run dev)에서만 확인했나요?
- Production 배포 후 실제로 이미지 생성 안 됐나요?
- Webhook이 수신되지 않았나요?

---

### 2. **Base64 방식 (Phase 1)**

**질문 2:**
```
Base64 방식을 실제로 구현하고 테스트했나요?
어떻게 실패했나요?
```

**가능한 실패 원인:**
- [ ] KV Store 크기 제한 초과 에러
- [ ] Context 종료로 생성 자체 실패
- [ ] 네트워크 timeout
- [ ] 다른 이유: _______

---

### 3. **Context 종료 타이밍**

**질문 3:**
```
정확히 언제 context가 종료되나요?
```

**가능성:**
- [ ] Post 생성 즉시
- [ ] HTTP 응답 반환 후
- [ ] 특정 시간 경과 후 (60초?)
- [ ] 잘 모름

---

### 4. **Devvit Scheduler 제한**

**질문 4:**
```
Daily Scheduler job은 얼마나 오래 실행될 수 있나요?
```

**확인 사항:**
- [ ] 공식 문서 본 적 있음: _______초
- [ ] 에러 메시지로 확인: _______초
- [ ] 추정: 60초 미만
- [ ] 모름

---

### 5. **외부 인프라 사용 가능 여부**

**질문 5:**
```
추가 비용이 들더라도 외부 서비스 사용 가능한가요?
```

**선택지:**
- [ ] Vercel Cron Job (5분마다 체크) - 추가 비용 거의 없음
- [ ] AWS SQS/Lambda - 월 $5-10 예상
- [ ] Redis Queue (Upstash) - 월 $0-5
- [ ] 모두 불가능
- [ ] 비용 상관없음

---

### 6. **타협 가능한 부분**

**질문 6:**
```
어떤 타협이 가능한가요?
```

**옵션:**
- [ ] 이미지 없이 placeholder만 사용 (게임 플레이 가능)
- [ ] 사전 생성된 제한된 케이스 (30-50개) 반복 사용
- [ ] 이미지 생성 지연 허용 (최대 5분)
- [ ] 부분 성공 허용 (14장 중 10장만 생성)
- [ ] 타협 불가 - 14장 모두 필수

---

## 🎯 다음 단계

**저의 다음 액션:**

1. ✅ 위 질문들에 대한 답변 받기
2. ⏳ 실제 가능한 솔루션 설계
3. ⏳ 구현 및 테스트

**질문에 답변 주시면:**
- 정확한 실패 원인 파악
- 실제 작동 가능한 솔루션 제안
- 구현 우선순위 결정

---

## 💡 현재 생각 중인 대안 (답변 후 구체화)

### 대안 A: 완전 비동기 Polling
```
Devvit → Redis에 "pending" 상태 저장
Vercel Cron (5분마다) → Pending 확인 → 이미지 생성
Devvit → 5분 후 이미지 표시 (placeholder → 실제 이미지)
```

### 대안 B: Build-time 생성
```
배포 전 → 50개 케이스 미리 생성 → Assets 포함
Daily: 50개 중 랜덤 선택
```

### 대안 C: Placeholder Only
```
이미지 없이 이모지/아이콘만 사용
게임 플레이에는 영향 없음
```

### 대안 D: Progressive Enhancement
```
첫 로드: Placeholder
Background: 지속적으로 생성 시도
성공 시: 자동 업데이트
```

---

**다음:** 위 질문에 답변 주시면 정확한 해결책 제시하겠습니다.
