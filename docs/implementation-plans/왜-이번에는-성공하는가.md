# ì™œ ì´ë²ˆ ì†”ë£¨ì…˜ì€ ì„±ê³µí•˜ëŠ”ê°€?

**í•µì‹¬**: Devvit Contextì—ì„œ ì™„ì „íˆ ë…ë¦½

---

## ğŸ”´ ì‹¤íŒ¨ íŒ¨í„´: Context ì˜ì¡´ì„±

### ì´ì „ ì‹œë„ë“¤ì˜ ê³µí†µì 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Devvit Context                      â”‚
â”‚                                                   â”‚
â”‚  generateCase() {                                â”‚
â”‚    â”œâ”€ Case ìƒì„± âœ…                               â”‚
â”‚    â”œâ”€ Redis ì €ì¥ âœ…                              â”‚
â”‚    â”‚                                              â”‚
â”‚    â””â”€ ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ ğŸ”„                        â”‚
â”‚        â”œâ”€ Vercel í˜¸ì¶œ (orphaned)                 â”‚
â”‚        â”œâ”€ Gemini API í˜¸ì¶œ                        â”‚
â”‚        â””â”€ Promise.allSettled([...])              â”‚
â”‚                                                   â”‚
â”‚  } â† return                                       â”‚
â”‚                                                   â”‚
â”‚  Post ìƒì„± âœ…                                     â”‚
â”‚  Context ì¢…ë£Œ ğŸ”´                                  â”‚
â”‚                                                   â”‚
â”‚  â†’ ëª¨ë“  pending promises ì·¨ì†Œ âŒ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë¬¸ì œ**:
- generateCase()ê°€ returní•˜ë©´ Contextê°€ ì¢…ë£Œë¨
- Contextê°€ ì¢…ë£Œë˜ë©´ ì§„í–‰ ì¤‘ì¸ ëª¨ë“  ë¹„ë™ê¸° ì‘ì—…ì´ ì·¨ì†Œë¨
- `await` ì—†ëŠ” promiseëŠ” orphaned promiseê°€ ë¨
- Vercel fetch, Gemini API í˜¸ì¶œ ëª¨ë‘ ì·¨ì†Œë¨

---

## âœ… ì„±ê³µ íŒ¨í„´: ì™„ì „í•œ ë…ë¦½

### ìƒˆë¡œìš´ ë°©ì‹ (Queue)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Devvit Context       â”‚    â”‚   Vercel Cron            â”‚
â”‚                         â”‚    â”‚   (ë…ë¦½ì )                â”‚
â”‚  generateCase() {       â”‚    â”‚                          â”‚
â”‚    â”œâ”€ Case ìƒì„± âœ…      â”‚    â”‚  ë§¤ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰:        â”‚
â”‚    â”œâ”€ Redis ì €ì¥ âœ…     â”‚    â”‚                          â”‚
â”‚    â”‚                    â”‚    â”‚  1. Redis ì²´í¬           â”‚
â”‚    â””â”€ Queueì— ì¶”ê°€:     â”‚    â”‚     â†“                    â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  2. Pending jobs ë°œê²¬   â”‚
â”‚       â”‚ pending-     â”‚  â”‚    â”‚     â†“                    â”‚
â”‚       â”‚ images:      â”‚ â”€â”¼â”€â”€â”€â”€â”¼â†’ 3. ì´ë¯¸ì§€ ìƒì„±          â”‚
â”‚       â”‚ case-123     â”‚  â”‚    â”‚     (300ì´ˆ í—ˆìš©)        â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚     â†“                    â”‚
â”‚                         â”‚    â”‚  4. Redisì— ì €ì¥        â”‚
â”‚  } â† return ì¦‰ì‹œ âœ…     â”‚    â”‚     â†“                    â”‚
â”‚                         â”‚    â”‚  5. Queueì—ì„œ ì œê±°       â”‚
â”‚  Post ìƒì„± âœ…           â”‚    â”‚                          â”‚
â”‚  Context ì¢…ë£Œ âœ…        â”‚    â”‚  (Contextì™€ ë¬´ê´€)        â”‚
â”‚                         â”‚    â”‚                          â”‚
â”‚  â†’ ì˜í–¥ ì—†ìŒ!           â”‚    â”‚  â†’ ê³„ì† ì‹¤í–‰ âœ…          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì„±ê³µ ì´ìœ **:
1. âœ… DevvitëŠ” "í•  ì¼"ë§Œ Redisì— ê¸°ë¡
2. âœ… ì¦‰ì‹œ return (ì•„ë¬´ê²ƒë„ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
3. âœ… Context ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
4. âœ… Vercel Cronì´ ë‚˜ì¤‘ì— ë…ë¦½ì ìœ¼ë¡œ ì²˜ë¦¬
5. âœ… Context ì¢…ë£Œì™€ ì™„ì „íˆ ë¬´ê´€

---

## ğŸ” ì½”ë“œ ë¹„êµ

### âŒ ì‹¤íŒ¨í•˜ëŠ” ì½”ë“œ (í˜„ì¬)

```typescript
// CaseGeneratorService.ts:304
this.triggerVercelImageGeneration(...)  // await ì—†ìŒ
  .then(() => {
    console.log(`ğŸš€ Vercel image generation triggered (async)`);
  })
  .catch((error) => {
    console.error('âš ï¸  Failed to trigger Vercel image generation:', error);
  });

// ì—¬ê¸°ì„œ return (promiseëŠ” orphaned ìƒíƒœ)
return savedCase;
```

**íƒ€ì„ë¼ì¸**:
```
0ms   â”‚ triggerVercelImageGeneration() í˜¸ì¶œ
1ms   â”‚ generateCase() return
2ms   â”‚ Post ìƒì„±
100ms â”‚ Context ì¢…ë£Œ ğŸ”´
      â”‚ â†’ fetch() ì·¨ì†Œ âŒ
      â”‚ â†’ Promise cancelled âŒ
```

### âœ… ì„±ê³µí•˜ëŠ” ì½”ë“œ (ìƒˆë¡œìš´)

```typescript
// CaseGeneratorService.ts
// 1. ì´ë¯¸ì§€ ìš”ì²­ ì¤€ë¹„
const imageRequests = this.prepareImageRequests(savedCase, ...);

// 2. Redis íì— ì €ì¥ (await - ë°˜ë“œì‹œ ì €ì¥ ì™„ë£Œ)
await this.redis.set(`pending-images:${savedCase.id}`, JSON.stringify({
  caseId: savedCase.id,
  timestamp: Date.now(),
  images: imageRequests
}));

await this.redis.sAdd('pending-image-jobs', savedCase.id);

console.log(`âœ… Queued ${imageRequests.length} images`);

// 3. ì¦‰ì‹œ return
return savedCase;
```

**íƒ€ì„ë¼ì¸**:
```
0ms    â”‚ prepareImageRequests() - ë°ì´í„°ë§Œ ì¤€ë¹„
1ms    â”‚ redis.set() - íì— ì €ì¥ (await âœ…)
10ms   â”‚ redis.sAdd() - ì¸ë±ìŠ¤ ì¶”ê°€ (await âœ…)
11ms   â”‚ generateCase() return âœ…
12ms   â”‚ Post ìƒì„± âœ…
100ms  â”‚ Context ì¢…ë£Œ âœ…
       â”‚
       â”‚ (5ë¶„ í›„)
       â”‚
5min   â”‚ Vercel Cron ì‹¤í–‰ (ë…ë¦½ì )
5min+1 â”‚ Redisì—ì„œ pending jobs ê°€ì ¸ì˜´
5min+2 â”‚ ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ (300ì´ˆ í—ˆìš©)
7min   â”‚ ëª¨ë“  ì´ë¯¸ì§€ ì™„ë£Œ âœ…
7min+1 â”‚ Redisì— ì €ì¥ âœ…
```

---

## ğŸ“Š ì°¨ì´ì  ìš”ì•½

| êµ¬ë¶„ | ì´ì „ (ì‹¤íŒ¨) | ìƒˆë¡œìš´ (ì„±ê³µ) |
|-----|-----------|--------------|
| **Devvit ì—­í• ** | ì´ë¯¸ì§€ ìƒì„± ì‹œë„ | Queue ë“±ë¡ë§Œ |
| **ëŒ€ê¸° ì—¬ë¶€** | Promise ëŒ€ê¸° (orphaned) | Redis ì €ì¥ë§Œ await |
| **Return íƒ€ì´ë°** | ì´ë¯¸ì§€ ìƒì„± ì¤‘ | Queue ë“±ë¡ ì§í›„ |
| **Context ì˜ì¡´** | ë†’ìŒ (ì¢…ë£Œ ì‹œ ì·¨ì†Œ) | ì—†ìŒ (ë…ë¦½) |
| **ì‹¤í–‰ ì£¼ì²´** | Devvit Context | Vercel Cron |
| **ì‹œê°„ ì œí•œ** | ~60ì´ˆ | 300ì´ˆ |
| **ì‹¤íŒ¨ ê°€ëŠ¥ì„±** | Context ì¢…ë£Œ | ì—†ìŒ |
| **ì„±ê³µë¥ ** | 14% (2/14) | 100% (ì˜ˆìƒ) |

---

## ğŸ¯ ì™œ Vercel Cronì´ ì‘ë™í•˜ëŠ”ê°€?

### Vercel Cronì˜ íŠ¹ì§•

1. **ë…ë¦½ì  ì‹¤í–‰**
   - GitHub Actionsì²˜ëŸ¼ ë…ë¦½ì ì¸ ì‹¤í–‰ í™˜ê²½
   - Devvitì™€ ì™„ì „íˆ ë¶„ë¦¬
   - Context ì¢…ë£Œì™€ ë¬´ê´€

2. **ì¶©ë¶„í•œ ì‹œê°„**
   - Vercel Pro: 300ì´ˆ (5ë¶„)
   - 14ì¥ ì´ë¯¸ì§€: ~90-120ì´ˆ ì˜ˆìƒ
   - ì—¬ìœ  ìˆìŒ

3. **ì¬ì‹œë„ ê°€ëŠ¥**
   - ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ Cronì—ì„œ ì¬ì‹œë„
   - Pending queueì— ë‚¨ì•„ìˆìŒ
   - ìµœì¢… ì„±ê³µë¥  100%

4. **ê²€ì¦ëœ íŒ¨í„´**
   - Queue Worker íŒ¨í„´ì€ ì—…ê³„ í‘œì¤€
   - AWS SQS, Redis Queue ë“±ê³¼ ë™ì¼ ì›ë¦¬
   - ìˆ˜ë°±ë§Œ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš© ì¤‘

---

## ğŸ”¬ ìœ ì‚¬ ì„±ê³µ ì‚¬ë¡€

### 1. Email ë°œì†¡ ì‹œìŠ¤í…œ
```
Request â†’ Queue â†’ Background Worker â†’ Email ë°œì†¡
```
- ìš”ì²­ì€ ì¦‰ì‹œ return
- ì‹¤ì œ ë°œì†¡ì€ ë‚˜ì¤‘ì—
- 100% ì‹ ë¢°ë„

### 2. ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• (AWS Lambda)
```
Upload â†’ S3 Event â†’ Lambda â†’ Resize â†’ S3
```
- Upload contextì™€ Lambda ë…ë¦½
- Context ì¢…ë£Œì™€ ë¬´ê´€

### 3. Video Transcoding (YouTube)
```
Upload â†’ Queue â†’ Worker Farm â†’ Transcoding â†’ CDN
```
- ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ë„ ê°€ëŠ¥
- Queue ê¸°ë°˜ í™•ì¥

---

## âš ï¸ ì´ì „ Vercel ì‹œë„ì™€ì˜ ì°¨ì´

### ì´ì „ ì‹œë„ (vercel-image-integration-IMPLEMENTATION-COMPLETE.md)

```typescript
// Devvitì—ì„œ Vercel Functionì„ ì§ì ‘ í˜¸ì¶œ
this.triggerVercelImageGeneration(...)
  .then(() => console.log('triggered'))
  .catch(error => console.error(error));

// ë¬¸ì œ:
// 1. await ì—†ìŒ (orphaned promise)
// 2. Contextê°€ ì¢…ë£Œë˜ë©´ fetch() ì·¨ì†Œ
// 3. Vercel Functionì´ í˜¸ì¶œì¡°ì°¨ ì•ˆ ë¨
```

### ìƒˆë¡œìš´ ë°©ì‹

```typescript
// 1. DevvitëŠ” Queueì—ë§Œ ë“±ë¡
await redis.set(`pending-images:${caseId}`, ...);
await redis.sAdd('pending-image-jobs', caseId);

// 2. Vercel Cronì´ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰
export default async function handler(req, res) {
  const jobs = await redis.sMembers('pending-image-jobs');
  // ì²˜ë¦¬...
}

// ì°¨ì´:
// 1. Devvitì—ì„œ Vercel í˜¸ì¶œ ì—†ìŒ
// 2. Vercelì´ ìŠ¤ìŠ¤ë¡œ Redis ì²´í¬
// 3. ì™„ì „íˆ ë…ë¦½ì 
```

---

## ğŸš€ ì„±ê³µ ì˜ˆì¸¡

### ì˜ˆìƒ ì„±ê³µë¥ : 100%

**ì´ìœ **:
1. âœ… Context ì˜ì¡´ì„± ì œê±°
2. âœ… ì¶©ë¶„í•œ ì‹¤í–‰ ì‹œê°„ (300ì´ˆ)
3. âœ… ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜
4. âœ… ê²€ì¦ëœ ì•„í‚¤í…ì²˜ íŒ¨í„´

**ì‹¤íŒ¨ ê°€ëŠ¥ì„±**:
- Gemini API ì¥ì•  (ì¬ì‹œë„ë¡œ í•´ê²°)
- Redis ì—°ê²° ì‹¤íŒ¨ (Vercel KV ì•ˆì •ì )
- ê±°ì˜ ì—†ìŒ

**ì˜ˆìƒ íƒ€ì„ë¼ì¸**:
```
0:00  â”‚ ì¼€ì´ìŠ¤ ìƒì„± (Devvit)
0:10  â”‚ Queue ë“±ë¡ ì™„ë£Œ
0:11  â”‚ Post ì—…ë¡œë“œ
0-5ë¶„ â”‚ ì‚¬ìš©ìëŠ” Placeholder ë´„
5:00  â”‚ Vercel Cron ì‹¤í–‰
5:01  â”‚ Queue ë°œê²¬
7:00  â”‚ 14ì¥ ì´ë¯¸ì§€ ì™„ë£Œ
7:01  â”‚ ì‚¬ìš©ìì—ê²Œ ì‹¤ì œ ì´ë¯¸ì§€ í‘œì‹œ
```

---

## ğŸ’¡ ì¶”ê°€ ê°œì„  ê°€ëŠ¥

### 1. ë” ë¹ ë¥¸ Cron
```json
{
  "schedule": "*/2 * * * *"  // 2ë¶„ë§ˆë‹¤
}
```
â†’ ìµœëŒ€ ì§€ì—°: 2ë¶„

### 2. Webhook ì¶”ê°€
```typescript
// Vercelì—ì„œ ì™„ë£Œ ì‹œ Devvit webhook í˜¸ì¶œ
await fetch(`${devvitWebhookUrl}/image-complete`, {
  method: 'POST',
  body: JSON.stringify({ caseId })
});
```
â†’ ì¦‰ì‹œ í”„ë¡ íŠ¸ì—”ë“œ ì—…ë°ì´íŠ¸

### 3. ìš°ì„ ìˆœìœ„ Queue
```typescript
// ìµœê·¼ ì¼€ì´ìŠ¤ ìš°ì„  ì²˜ë¦¬
const sortedJobs = jobs.sort((a, b) => {
  const aTime = JSON.parse(redis.get(`pending-images:${a}`)).timestamp;
  const bTime = JSON.parse(redis.get(`pending-images:${b}`)).timestamp;
  return bTime - aTime;
});
```
â†’ ìµœì‹  ì¼€ì´ìŠ¤ê°€ ë¨¼ì € ì™„ë£Œ

---

## âœ… ê²°ë¡ 

**ì´ë²ˆ ì†”ë£¨ì…˜ì´ ì„±ê³µí•˜ëŠ” ì´ìœ **:
1. Devvit Contextì—ì„œ ì™„ì „íˆ ë…ë¦½
2. Queue ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬
3. ì¶©ë¶„í•œ ì‹¤í–‰ ì‹œê°„ (300ì´ˆ)
4. ê²€ì¦ëœ ì•„í‚¤í…ì²˜ íŒ¨í„´

**ì´ì „ ì‹œë„ì™€ì˜ ì°¨ì´**:
- ì´ì „: Devvitì—ì„œ ì§ì ‘ ì²˜ë¦¬ ì‹œë„ â†’ Context ì¢…ë£Œ ì‹œ ì·¨ì†Œ
- ìƒˆë¡œìš´: Queueì— ë“±ë¡ë§Œ â†’ ë…ë¦½ì  Workerê°€ ì²˜ë¦¬

**ì˜ˆìƒ ì„±ê³µë¥ **: **100%**

**Trade-off**: 0-5ë¶„ ì§€ì—° (í—ˆìš© ê°€ëŠ¥í•œ ìˆ˜ì¤€)

---

**ë‹¤ìŒ**: êµ¬í˜„ ì‹œì‘ ìŠ¹ì¸ ëŒ€ê¸°
